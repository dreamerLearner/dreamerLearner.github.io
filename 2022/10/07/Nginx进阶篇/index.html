<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Nginx进阶篇 | Dreamer Blog</title><meta name="keywords" content="导航,分享"><meta name="author" content="Dreamer Blog"><meta name="copyright" content="Dreamer Blog"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Nginx服务器基础配置实例前面我们已经对Nginx服务器默认配置文件的结构和涉及的基本指令做了详细的阐述。通过这些指令的合理配置，我们就可以让一台Nginx服务器正常工作，并且提供基本的web服务器功能。 接下来我们将通过一个比较完整和最简单的基础配置实例，来巩固下前面所学习的指令及其配置。 需求如下: 1234567891011121314（1）有如下访问：	http:&#x2F;&#x2F;192.168.20">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx进阶篇">
<meta property="og:url" content="http://dreamerlearner.github.io/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/index.html">
<meta property="og:site_name" content="Dreamer Blog">
<meta property="og:description" content="Nginx服务器基础配置实例前面我们已经对Nginx服务器默认配置文件的结构和涉及的基本指令做了详细的阐述。通过这些指令的合理配置，我们就可以让一台Nginx服务器正常工作，并且提供基本的web服务器功能。 接下来我们将通过一个比较完整和最简单的基础配置实例，来巩固下前面所学习的指令及其配置。 需求如下: 1234567891011121314（1）有如下访问：	http:&#x2F;&#x2F;192.168.20">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://dreamerlearner.github.io/img/vanilla.jpg">
<meta property="article:published_time" content="2022-10-07T11:54:51.000Z">
<meta property="article:modified_time" content="2022-10-07T12:44:19.661Z">
<meta property="article:author" content="Dreamer Blog">
<meta property="article:tag" content="导航">
<meta property="article:tag" content="分享">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dreamerlearner.github.io/img/vanilla.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://dreamerlearner.github.io/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Nginx进阶篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-07 20:44:19'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/vanilla.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Dreamer Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Nginx进阶篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-10-07T11:54:51.000Z" title="Created 2022-10-07 19:54:51">2022-10-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-10-07T12:44:19.661Z" title="Updated 2022-10-07 20:44:19">2022-10-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Nginx%E5%AD%A6%E4%B9%A0/">Nginx学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Nginx%E5%AD%A6%E4%B9%A0/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/">Nginx进阶篇</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Nginx进阶篇"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Nginx服务器基础配置实例"><a href="#Nginx服务器基础配置实例" class="headerlink" title="Nginx服务器基础配置实例"></a>Nginx服务器基础配置实例</h1><p>前面我们已经对Nginx服务器默认配置文件的结构和涉及的基本指令做了详细的阐述。通过这些指令的合理配置，我们就可以让一台Nginx服务器正常工作，并且提供基本的web服务器功能。</p>
<p>接下来我们将通过一个比较完整和最简单的基础配置实例，来巩固下前面所学习的指令及其配置。</p>
<p>需求如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">（1）有如下访问：</span><br><span class="line">	http://192.168.200.133:8081/server1/location1</span><br><span class="line">		访问的是：index_sr1_location1.html</span><br><span class="line">	http://192.168.200.133:8081/server1/location2</span><br><span class="line">		访问的是：index_sr1_location2.html</span><br><span class="line">	http://192.168.200.133:8082/server2/location1</span><br><span class="line">		访问的是：index_sr2_location1.html</span><br><span class="line">	http://192.168.200.133:8082/server2/location2</span><br><span class="line">		访问的是：index_sr2_location2.html</span><br><span class="line">（2）如果访问的资源不存在，</span><br><span class="line">	返回自定义的404页面</span><br><span class="line">（3）将/server1和/server2的配置使用不同的配置文件分割</span><br><span class="line">	将文件放到/home/www/conf.d目录下，然后使用include进行合并</span><br><span class="line">（4）为/server1和/server2各自创建一个访问日志文件</span><br></pre></td></tr></table></figure>

<p>准备相关文件，目录如下：</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587129309340.png" alt="1587129309340"></p>
<p>配置的内容如下:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##全局块 begin##</span></span><br><span class="line"><span class="comment">#配置允许运行Nginx工作进程的用户和用户组</span></span><br><span class="line">user www<span class="comment">;</span></span><br><span class="line"><span class="comment">#配置运行Nginx进程生成的worker进程数</span></span><br><span class="line">worker_processes 2<span class="comment">;</span></span><br><span class="line"><span class="comment">#配置Nginx服务器运行对错误日志存放的路径</span></span><br><span class="line">error_log logs/error.log<span class="comment">;</span></span><br><span class="line"><span class="comment">#配置Nginx服务器允许时记录Nginx的master进程的PID文件路径和名称</span></span><br><span class="line">pid logs/nginx.pid<span class="comment">;</span></span><br><span class="line"><span class="comment">#配置Nginx服务是否以守护进程方法启动</span></span><br><span class="line"><span class="comment">#daemon on;</span></span><br><span class="line"><span class="comment">##全局块 end##</span></span><br><span class="line"></span><br><span class="line"><span class="comment">##events块 begin##</span></span><br><span class="line">events&#123;</span><br><span class="line">	<span class="comment">#设置Nginx网络连接序列化</span></span><br><span class="line">	accept_mutex on<span class="comment">;</span></span><br><span class="line">	<span class="comment">#设置Nginx的worker进程是否可以同时接收多个请求</span></span><br><span class="line">	multi_accept on<span class="comment">;</span></span><br><span class="line">	<span class="comment">#设置Nginx的worker进程最大的连接数</span></span><br><span class="line">	worker_connections 1024<span class="comment">;</span></span><br><span class="line">	<span class="comment">#设置Nginx使用的事件驱动模型</span></span><br><span class="line">	use epoll<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">##events块 end##</span></span><br><span class="line"><span class="comment">##http块 start##</span></span><br><span class="line">http&#123;</span><br><span class="line">	<span class="comment">#定义MIME-Type</span></span><br><span class="line">	include mime.types<span class="comment">;</span></span><br><span class="line">	default_type application/octet-stream<span class="comment">;</span></span><br><span class="line">	<span class="comment">#配置允许使用sendfile方式运输</span></span><br><span class="line">	sendfile on<span class="comment">;</span></span><br><span class="line">	<span class="comment">#配置连接超时时间</span></span><br><span class="line">	keepalive_timeout 65<span class="comment">;</span></span><br><span class="line">	<span class="comment">#配置请求处理日志格式</span></span><br><span class="line">	log_format server1 &#x27;===&gt;server1 access log<span class="attr">&#x27;;</span></span><br><span class="line"><span class="attr">	log_format server2 &#x27;</span>===&gt;server2 access log<span class="string">&#x27;;</span></span><br><span class="line"><span class="string">	##server块 开始##</span></span><br><span class="line"><span class="string">	include /home/www/conf.d/*.conf;</span></span><br><span class="line"><span class="string">	##server块 结束##</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">##http块 end##</span></span><br></pre></td></tr></table></figure>



<p>server1.conf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">		<span class="comment">#配置监听端口和主机名称</span></span><br><span class="line">		listen 8081<span class="comment">;</span></span><br><span class="line">		server_name localhost<span class="comment">;</span></span><br><span class="line">		<span class="comment">#配置请求处理日志存放路径</span></span><br><span class="line">		access_log /home/www/myweb/server1/logs/access.log server1<span class="comment">;</span></span><br><span class="line">		<span class="comment">#配置错误页面</span></span><br><span class="line">		error_page 404 /404.html<span class="comment">;</span></span><br><span class="line">		<span class="comment">#配置处理/server1/location1请求的location</span></span><br><span class="line">		location /server1/location1&#123;</span><br><span class="line">			root /home/www/myweb<span class="comment">;</span></span><br><span class="line">			index index_sr1_location1.html<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#配置处理/server1/location2请求的location</span></span><br><span class="line">		location /server1/location2&#123;</span><br><span class="line">			root /home/www/myweb<span class="comment">;</span></span><br><span class="line">			index index_sr1_location2.html<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#配置错误页面转向</span></span><br><span class="line">		<span class="attr">location</span> = /<span class="number">404</span>.html &#123;</span><br><span class="line">			root /home/www/myweb<span class="comment">;</span></span><br><span class="line">			index 404.html<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>server2.conf</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">		<span class="comment">#配置监听端口和主机名称</span></span><br><span class="line">		listen 8082<span class="comment">;</span></span><br><span class="line">		server_name localhost<span class="comment">;</span></span><br><span class="line">		<span class="comment">#配置请求处理日志存放路径</span></span><br><span class="line">		access_log /home/www/myweb/server2/logs/access.log server2<span class="comment">;</span></span><br><span class="line">		<span class="comment">#配置错误页面,对404.html做了定向配置</span></span><br><span class="line">		error_page 404 /404.html<span class="comment">;</span></span><br><span class="line">		<span class="comment">#配置处理/server1/location1请求的location</span></span><br><span class="line">		location /server2/location1&#123;</span><br><span class="line">			root /home/www/myweb<span class="comment">;</span></span><br><span class="line">			index index_sr2_location1.html<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#配置处理/server2/location2请求的location</span></span><br><span class="line">		location /server2/location2&#123;</span><br><span class="line">			root /home/www/myweb<span class="comment">;</span></span><br><span class="line">			index index_sr2_location2.html<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">#配置错误页面转向</span></span><br><span class="line">		<span class="attr">location</span> = /<span class="number">404</span>.html &#123;</span><br><span class="line">			root /home/www/myweb<span class="comment">;</span></span><br><span class="line">			index 404.html<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>访问测试：</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587129766585.png" alt="1587129766585"></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587129777898.png" alt="1587129777898"></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587290246228.png" alt="1587290246228"></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587129805309.png" alt="1587129805309"></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587129817226.png" alt="1587129817226"></p>
<h1 id="Nginx服务操作的问题"><a href="#Nginx服务操作的问题" class="headerlink" title="Nginx服务操作的问题"></a>Nginx服务操作的问题</h1><p>经过前面的操作，我们会发现，如果想要启动、关闭或重新加载nginx配置文件，都需要先进入到nginx的安装目录的sbin目录，然后使用nginx的二级制可执行文件来操作，相对来说操作比较繁琐，这块该如何优化？另外如果我们想把Nginx设置成随着服务器启动就自动完成启动操作，又该如何来实现?这就需要用到接下来我们要讲解的两个知识点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Nginx配置成系统服务</span><br><span class="line">Nginx命令配置到系统环境</span><br></pre></td></tr></table></figure>

<h1 id="Nginx配置成系统服务"><a href="#Nginx配置成系统服务" class="headerlink" title="Nginx配置成系统服务"></a>Nginx配置成系统服务</h1><p>把Nginx应用服务设置成为系统服务，方便对Nginx服务的启动和停止等相关操作，具体实现步骤:</p>
<p>(1) 在<code>/usr/lib/systemd/system</code>目录下添加nginx.service,内容如下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=nginx web service</span><br><span class="line"><span class="attr">Documentation</span>=http://nginx.org/en/docs/</span><br><span class="line"><span class="attr">After</span>=network.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">Type</span>=forking</span><br><span class="line"><span class="attr">PIDFile</span>=/usr/local/nginx/logs/nginx.pid</span><br><span class="line"><span class="attr">ExecStartPre</span>=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/nginx/sbin/nginx</span><br><span class="line"><span class="attr">ExecReload</span>=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line"><span class="attr">ExecStop</span>=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line"><span class="attr">PrivateTmp</span>=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=default.target</span><br></pre></td></tr></table></figure>

<p>(2)添加完成后如果权限有问题需要进行权限设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>

<p>(3)使用系统命令来操作Nginx服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">启动: systemctl start nginx</span><br><span class="line">停止: systemctl stop nginx</span><br><span class="line">重启: systemctl restart nginx</span><br><span class="line">重新加载配置文件: systemctl reload nginx</span><br><span class="line">查看nginx状态: systemctl status nginx</span><br><span class="line">开机启动: systemctl enable nginx</span><br></pre></td></tr></table></figure>

<h1 id="Nginx命令配置到系统环境"><a href="#Nginx命令配置到系统环境" class="headerlink" title="Nginx命令配置到系统环境"></a>Nginx命令配置到系统环境</h1><p>前面我们介绍过Nginx安装目录下的二级制可执行文件<code>nginx</code>的很多命令，要想使用这些命令前提是需要进入sbin目录下才能使用，很不方便，如何去优化，我们可以将该二进制可执行文件加入到系统的环境变量，这样的话在任何目录都可以使用nginx对应的相关命令。具体实现步骤如下:</p>
<p>演示可删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/sbin/nginx -V</span><br><span class="line">cd /usr/local/nginx/sbin  nginx -V</span><br><span class="line">如何优化？？？</span><br></pre></td></tr></table></figure>

<p>(1)修改<code>/etc/profile</code>文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">在最后一行添加</span><br><span class="line">export PATH=$PATH:/usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>

<p>(2)使之立即生效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>

<p>(3)执行nginx命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure>

<h1 id="Nginx静态资源部署"><a href="#Nginx静态资源部署" class="headerlink" title="Nginx静态资源部署"></a>Nginx静态资源部署</h1><h2 id="Nginx静态资源概述"><a href="#Nginx静态资源概述" class="headerlink" title="Nginx静态资源概述"></a>Nginx静态资源概述</h2><p>上网去搜索访问资源对于我们来说并不陌生，通过浏览器发送一个HTTP请求实现从客户端发送请求到服务器端获取所需要内容后并把内容回显展示在页面的一个过程。这个时候，我们所请 求的内容就分为两种类型，一类是静态资源、一类是动态资源。<br>静态资源即指在服务器端真实存在并且能直接拿来展示的一些文件，比如常见的html页面、css文件、js文件、图 片、视频等资源；<br>动态资源即指在服务器端真实存在但是要想获取需要经过一定的业务逻辑处理，根据不同的条件展示在页面不同这 一部分内容，比如说报表数据展示、根据当前登录用户展示相关具体数据等资源；</p>
<p>Nginx处理静态资源的内容，我们需要考虑下面这几个问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）静态资源的配置指令</span><br><span class="line">（2）静态资源的配置优化</span><br><span class="line">（3）静态资源的压缩配置指令</span><br><span class="line">（4）静态资源的缓存处理</span><br><span class="line">（5）静态资源的访问控制，包括跨域问题和防盗链问题</span><br></pre></td></tr></table></figure>

<h2 id="Nginx静态资源的配置指令"><a href="#Nginx静态资源的配置指令" class="headerlink" title="Nginx静态资源的配置指令"></a>Nginx静态资源的配置指令</h2><h3 id="listen指令"><a href="#listen指令" class="headerlink" title="listen指令"></a>listen指令</h3><p>listen:用来配置监听端口。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>listen address[:port] [default_server]…;<br/>listen port [default_server]…;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>listen *:80 | *:8000</td>
</tr>
<tr>
<td>位置</td>
<td>server</td>
</tr>
</tbody></table>
<p>listen的设置比较灵活，我们通过几个例子来把常用的设置方式熟悉下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">listen 127.0.0.1:8000; // listen localhost:8000 监听指定的IP和端口</span><br><span class="line">listen 127.0.0.1;	监听指定IP的所有端口</span><br><span class="line">listen 8000;	监听指定端口上的连接</span><br><span class="line">listen *:8000;	监听指定端口上的连接</span><br></pre></td></tr></table></figure>

<p>default_server属性是标识符，用来将此虚拟主机设置成默认主机。所谓的默认主机指的是如果没有匹配到对应的address:port，则会默认执行的。如果不指定默认使用的是第一个server。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 8080<span class="comment">;</span></span><br><span class="line">	server_name 127.0.0.1<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">		index index.html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	listen 8080 default_server<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	default_type text/plain<span class="comment">;</span></span><br><span class="line">	return 444 &#x27;This is a error request&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="server-name指令"><a href="#server-name指令" class="headerlink" title="server_name指令"></a>server_name指令</h3><p>server_name：用来设置虚拟主机服务名称。</p>
<p>127.0.0.1 、 localhost 、域名[<a target="_blank" rel="noopener" href="http://www.baidu.com/">www.baidu.com</a> | <a href="http://www.jd.com]">www.jd.com]</a></p>
<table>
<thead>
<tr>
<th>语法</th>
<th>server_name  name …;<br/>name可以提供多个中间用空格分隔</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>server_name  “”;</td>
</tr>
<tr>
<td>位置</td>
<td>server</td>
</tr>
</tbody></table>
<p>关于server_name的配置方式有三种，分别是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">精确匹配</span><br><span class="line">通配符匹配</span><br><span class="line">正则表达式匹配</span><br></pre></td></tr></table></figure>

<p>配置方式一：精确匹配</p>
<p>如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.itcast.cn www.itheima.cn<span class="comment">;</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>补充小知识点:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hosts是一个没有扩展名的系统文件，可以用记事本等工具打开，其作用就是将一些常用的网址域名与其对应的IP地址建立一个关联“数据库”，当用户在浏览器中输入一个需要登录的网址时，系统会首先自动从hosts文件中寻找对应的IP地址，一旦找到，系统会立即打开对应网页，如果没有找到，则系统会再将网址提交DNS域名解析服务器进行IP地址的解析。</span><br></pre></td></tr></table></figure>

<p>windows:C:\Windows\System32\drivers\etc</p>
<p>centos：&#x2F;etc&#x2F;hosts</p>
<p>因为域名是要收取一定的费用，所以我们可以使用修改hosts文件来制作一些虚拟域名来使用。需要修改 <code>/etc/hosts</code>文件来添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">127.0.0.1 www.itcast.cn</span><br><span class="line">127.0.0.1 www.itheima.cn</span><br></pre></td></tr></table></figure>

<p>配置方式二:使用通配符配置</p>
<p>server_name中支持通配符”*”,但需要注意的是通配符不能出现在域名的中间，只能出现在首段或尾段，如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name  *.itcast.cn	www.itheima.*<span class="comment">;</span></span><br><span class="line">	<span class="comment"># www.itcast.cn abc.itcast.cn www.itheima.cn www.itheima.com</span></span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面的配置就会报错</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name  www.*.cn www.itheima.c*</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>配置三:使用正则表达式配置</p>
<p>server_name中可以使用正则表达式，并且使用<code>~</code>作为正则表达式字符串的开始标记。</p>
<p>常见的正则表达式</p>
<table>
<thead>
<tr>
<th>代码</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>^</td>
<td>匹配搜索字符串开始位置</td>
</tr>
<tr>
<td>$</td>
<td>匹配搜索字符串结束位置</td>
</tr>
<tr>
<td>.</td>
<td>匹配除换行符\n之外的任何单个字符</td>
</tr>
<tr>
<td>\</td>
<td>转义字符，将下一个字符标记为特殊字符</td>
</tr>
<tr>
<td>[xyz]</td>
<td>字符集，与任意一个指定字符匹配</td>
</tr>
<tr>
<td>[a-z]</td>
<td>字符范围，匹配指定范围内的任何字符</td>
</tr>
<tr>
<td>\w</td>
<td>与以下任意字符匹配 A-Z a-z 0-9 和下划线,等效于[A-Za-z0-9_]</td>
</tr>
<tr>
<td>\d</td>
<td>数字字符匹配，等效于[0-9]</td>
</tr>
<tr>
<td>{n}</td>
<td>正好匹配n次</td>
</tr>
<tr>
<td>{n,}</td>
<td>至少匹配n次</td>
</tr>
<tr>
<td>{n,m}</td>
<td>匹配至少n次至多m次</td>
</tr>
<tr>
<td>*</td>
<td>零次或多次，等效于{0,}</td>
</tr>
<tr>
<td>+</td>
<td>一次或多次，等效于{1,}</td>
</tr>
<tr>
<td>?</td>
<td>零次或一次，等效于{0,1}</td>
</tr>
</tbody></table>
<p>配置如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">        listen 80<span class="comment">;</span></span><br><span class="line">        server_name ~^www\.(\w+)\.com$<span class="comment">;</span></span><br><span class="line">        default_type text/plain<span class="comment">;</span></span><br><span class="line">        return 200 $1  $2 ..<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">注意 ~后面不能加空格，括号可以取值</span><br></pre></td></tr></table></figure>

<h4 id="匹配执行顺序"><a href="#匹配执行顺序" class="headerlink" title="匹配执行顺序"></a>匹配执行顺序</h4><p>由于server_name指令支持通配符和正则表达式，因此在包含多个虚拟主机的配置文件中，可能会出现一个名称被多个虚拟主机的server_name匹配成功，当遇到这种情况，当前的请求交给谁来处理呢？</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name ~^www\.\w+\.com$<span class="comment">;</span></span><br><span class="line">	default_type text/plain<span class="comment">;</span></span><br><span class="line">	return 200 &#x27;regex_success&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.itheima.*<span class="comment">;</span></span><br><span class="line">	default_type text/plain<span class="comment">;</span></span><br><span class="line">	return 200 &#x27;wildcard_after_success&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name *.itheima.com<span class="comment">;</span></span><br><span class="line">	default_type text/plain<span class="comment">;</span></span><br><span class="line">	return 200 &#x27;wildcard_before_success&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.itheima.com<span class="comment">;</span></span><br><span class="line">	default_type text/plain<span class="comment">;</span></span><br><span class="line">	return 200 &#x27;exact_success&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">	listen 80 default_server<span class="comment">;</span></span><br><span class="line">	server_name _<span class="comment">;</span></span><br><span class="line">	default_type text/plain<span class="comment">;</span></span><br><span class="line">	return 444 &#x27;default_server not found server&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结论：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">exact_success</span><br><span class="line">wildcard_before_success</span><br><span class="line">wildcard_after_success</span><br><span class="line">regex_success</span><br><span class="line">default_server not found server!!</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">No1:准确匹配server_name</span><br><span class="line"></span><br><span class="line">No2:通配符在开始时匹配server_name成功</span><br><span class="line"></span><br><span class="line">No3:通配符在结束时匹配server_name成功</span><br><span class="line"></span><br><span class="line">No4:正则表达式匹配server_name成功</span><br><span class="line"></span><br><span class="line">No5:被默认的default_server处理，如果没有指定默认找第一个server</span><br></pre></td></tr></table></figure>

<h3 id="location指令"><a href="#location指令" class="headerlink" title="location指令"></a>location指令</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location / &#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	location /abc&#123;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>location:用来设置请求的URI</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>location [  &#x3D;  |   ~  |  <del>*   |   ^</del>   |@ ] uri{…}</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server,location</td>
</tr>
</tbody></table>
<p>uri变量是待匹配的请求字符串，可以不包含正则表达式，也可以包含正则表达式，那么nginx服务器在搜索匹配location的时候，是先使用不包含正则表达式进行匹配，找到一个匹配度最高的一个，然后在通过包含正则表达式的进行匹配，如果能匹配到直接访问，匹配不到，就使用刚才匹配度最高的那个location来处理请求。</p>
<p>属性介绍:</p>
<p>不带符号，要求必须以指定模式开始</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name 127.0.0.1<span class="comment">;</span></span><br><span class="line">	location /abc&#123;</span><br><span class="line">		default_type text/plain<span class="comment">;</span></span><br><span class="line">		return 200 &quot;access success&quot;<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">以下访问都是正确的</span><br><span class="line">http://192.168.200.133/abc</span><br><span class="line">http://192.168.200.133/abc?<span class="attr">p1</span>=TOM</span><br><span class="line">http://192.168.200.133/abc/</span><br><span class="line">http://192.168.200.133/abcdef</span><br></pre></td></tr></table></figure>

<p>&#x3D; :  用于不包含正则表达式的uri前，必须与指定的模式精确匹配</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name 127.0.0.1<span class="comment">;</span></span><br><span class="line">	<span class="attr">location</span> =/abc&#123;</span><br><span class="line">		default_type text/plain<span class="comment">;</span></span><br><span class="line">		return 200 &quot;access success&quot;<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">可以匹配到</span><br><span class="line">http://192.168.200.133/abc</span><br><span class="line">http://192.168.200.133/abc?<span class="attr">p1</span>=TOM</span><br><span class="line">匹配不到</span><br><span class="line">http://192.168.200.133/abc/</span><br><span class="line">http://192.168.200.133/abcdef</span><br></pre></td></tr></table></figure>

<p>~ ： 用于表示当前uri中包含了正则表达式，并且区分大小写<br>~*:  用于表示当前uri中包含了正则表达式，并且不区分大小写</p>
<p>换句话说，如果uri包含了正则表达式，需要用上述两个符合来标识</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name 127.0.0.1<span class="comment">;</span></span><br><span class="line">	location ~^/abc\w$&#123;</span><br><span class="line">		default_type text/plain<span class="comment">;</span></span><br><span class="line">		return 200 &quot;access success&quot;<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name 127.0.0.1<span class="comment">;</span></span><br><span class="line">	location ~*^/abc\w$&#123;</span><br><span class="line">		default_type text/plain<span class="comment">;</span></span><br><span class="line">		return 200 &quot;access success&quot;<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>^~: 用于不包含正则表达式的uri前，功能和不加符号的一致，唯一不同的是，如果模式匹配，那么就停止搜索其他模式了。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name 127.0.0.1<span class="comment">;</span></span><br><span class="line">	location ^~/abc&#123;</span><br><span class="line">		default_type text/plain<span class="comment">;</span></span><br><span class="line">		return 200 &quot;access success&quot;<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="设置请求资源的目录root-x2F-alias"><a href="#设置请求资源的目录root-x2F-alias" class="headerlink" title="设置请求资源的目录root &#x2F; alias"></a>设置请求资源的目录root &#x2F; alias</h3><p>root：设置请求的根目录</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>root path;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>root html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>path为Nginx服务器接收到请求以后查找资源的根目录路径。</p>
<p>alias：用来更改location的URI</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>alias path;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>location</td>
</tr>
</tbody></table>
<p>path为修改后的根路径。</p>
<p>以上两个指令都可以来指定访问资源的路径，那么这两者之间的区别是什么?</p>
<p>举例说明：</p>
<p>（1）在<code>/usr/local/nginx/html</code>目录下创建一个 images目录,并在目录下放入一张图片<code>mv.png</code>图片</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">	root /usr/local/nginx/html<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问图片的路径为:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.133/images/mv.png</span><br></pre></td></tr></table></figure>

<p>（2）如果把root改为alias</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">	alias /usr/local/nginx/html<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次访问上述地址，页面会出现404的错误，查看错误日志会发现是因为地址不对，所以验证了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root的处理结果是: root路径+location路径</span><br><span class="line">/usr/local/nginx/html/images/mv.png</span><br><span class="line">alias的处理结果是:使用alias路径替换location路径</span><br><span class="line">/usr/local/nginx/html/images</span><br></pre></td></tr></table></figure>

<p>需要在alias后面路径改为</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">	alias /usr/local/nginx/html/images<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）如果location路径是以&#x2F;结尾,则alias也必须是以&#x2F;结尾，root没有要求</p>
<p>将上述配置修改为</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">location /images/ &#123;</span><br><span class="line">	alias /usr/local/nginx/html/images<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问就会出问题，查看错误日志还是路径不对，所以需要把alias后面加上 &#x2F; </p>
<p>小结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root的处理结果是: root路径+location路径</span><br><span class="line">alias的处理结果是:使用alias路径替换location路径</span><br><span class="line">alias是一个目录别名的定义，root则是最上层目录的含义。</span><br><span class="line">如果location路径是以/结尾,则alias也必须是以/结尾，root没有要求</span><br></pre></td></tr></table></figure>

<h3 id="index指令"><a href="#index指令" class="headerlink" title="index指令"></a>index指令</h3><p>index:设置网站的默认首页</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>index file …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>index index.html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>index后面可以跟多个设置，如果访问的时候没有指定具体访问的资源，则会依次进行查找，找到第一个为止。</p>
<p>举例说明：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">	root /usr/local/nginx/html<span class="comment">;</span></span><br><span class="line">	index index.html index.htm<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">访问该location的时候，可以通过 http://ip:port/，地址后面如果不添加任何内容，则默认依次访问index.html和index.htm，找到第一个来进行返回</span><br></pre></td></tr></table></figure>

<h3 id="error-page指令"><a href="#error-page指令" class="headerlink" title="error_page指令"></a>error_page指令</h3><p>error_page:设置网站的错误页面</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>error_page code … [&#x3D;[response]] uri;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location……</td>
</tr>
</tbody></table>
<p>当出现对应的响应code后，如何来处理。</p>
<p>举例说明：</p>
<p>（1）可以指定具体跳转的地址</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	error_page 404 http://www.itcast.cn<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）可以指定重定向地址</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	error_page 404 /50x.html<span class="comment">;</span></span><br><span class="line">	error_page 500 502 503 504 /50x.html<span class="comment">;</span></span><br><span class="line">	<span class="attr">location</span> =/<span class="number">50</span>x.html&#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（3）使用location的@符合完成错误信息展示</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	error_page 404 @jump_to_error<span class="comment">;</span></span><br><span class="line">	location @jump_to_error &#123;</span><br><span class="line">		default_type text/plain<span class="comment">;</span></span><br><span class="line">		return 404 &#x27;Not Found Page...&#x27;<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可选项<code>=[response]</code>的作用是用来将相应代码更改为另外一个</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	error_page <span class="attr">404</span> =<span class="number">200</span> /<span class="number">50</span>x.html<span class="comment">;</span></span><br><span class="line">	<span class="attr">location</span> =/<span class="number">50</span>x.html&#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">这样的话，当返回404找不到对应的资源的时候，在浏览器上可以看到，最终返回的状态码是200，这块需要注意下，编写error_page后面的内容，404后面需要加空格，200前面不能加空格</span><br></pre></td></tr></table></figure>

<h2 id="静态资源优化配置语法"><a href="#静态资源优化配置语法" class="headerlink" title="静态资源优化配置语法"></a>静态资源优化配置语法</h2><p>Nginx对静态资源如何进行优化配置。这里从三个属性配置进行优化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodeplay on;</span><br></pre></td></tr></table></figure>

<p>（1）sendﬁle，用来开启高效的文件传输模式。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>sendﬁle on |oﬀ;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>sendﬁle oﬀ;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
<p>请求静态资源的过程：客户端通过网络接口向服务端发送请求，操作系统将这些客户端的请求传递给服务器端应用程序，服务器端应用程序会处理这些请求，请求处理完成以后，操作系统还需要将处理得到的结果通过网络适配器传递回去。</p>
<p>如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name localhost；</span><br><span class="line">	location / &#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">		index index.html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">在html目录下有一个welcome.html页面，访问地址</span><br><span class="line">http://192.168.200.133/welcome.html</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587655397104.png" alt="1587655397104"></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587665814562.png" alt="1587665814562"></p>
<p>（2）tcp_nopush：该指令必须在sendfile打开的状态下才会生效，主要是用来提升网络包的传输’效率’</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>tcp_nopush on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>tcp_nopush oﬀ;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>（3）tcp_nodelay：该指令必须在keep-alive连接开启的情况下才生效，来提高网络包传输的’实时性’</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>tcp_nodelay on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>tcp_nodelay on;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587832596733.png" alt="1587832596733"></p>
<p>经过刚才的分析，”tcp_nopush”和”tcp_nodelay“看起来是”互斥的”，那么为什么要将这两个值都打开，这个大家需要知道的是在linux2.5.9以后的版本中两者是可以兼容的，三个指令都开启的好处是，sendfile可以开启高效的文件传输模式，tcp_nopush开启可以确保在发送到客户端之前数据包已经充分“填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有“填满”而暂停的数据包时，Nginx会忽略tcp_nopush参数， 然后，tcp_nodelay强制套接字发送数据。由此可知，TCP_NOPUSH可以与TCP_NODELAY一起设置，它比单独配置TCP_NODELAY具有更强的性能。所以我们可以使用如下配置来优化Nginx静态资源的处理</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sendfile on<span class="comment">;</span></span><br><span class="line">tcp_nopush on<span class="comment">;</span></span><br><span class="line">tcp_nodelay on<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<h2 id="Nginx静态资源压缩实战"><a href="#Nginx静态资源压缩实战" class="headerlink" title="Nginx静态资源压缩实战"></a>Nginx静态资源压缩实战</h2><p>经过上述内容的优化，我们再次思考一个问题，假如在满足上述优化的前提下，我们传送一个1M的数据和一个10M的数据那个效率高?，答案显而易见，传输内容小，速度就会快。那么问题又来了，同样的内容，如果把大小降下来，我们脑袋里面要蹦出一个词就是”压缩”，接下来，我们来学习Nginx的静态资源压缩模块。</p>
<p>在Nginx的配置文件中可以通过配置gzip来对静态资源进行压缩，相关的指令可以配置在http块、server块和location块中，Nginx可以通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_gzip_module模块</span><br><span class="line">ngx_http_gzip_static_module模块</span><br><span class="line">ngx_http_gunzip_module模块</span><br></pre></td></tr></table></figure>

<p>对这些指令进行解析和处理。</p>
<p>接下来我们从以下内容进行学习</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">（1）Gzip各模块支持的配置指令</span><br><span class="line">（2）Gzip压缩功能的配置</span><br><span class="line">（3）Gzip和sendfile的冲突解决</span><br><span class="line">（4）浏览器不支持Gzip的解决方案</span><br></pre></td></tr></table></figure>

<h3 id="Gzip模块配置指令"><a href="#Gzip模块配置指令" class="headerlink" title="Gzip模块配置指令"></a>Gzip模块配置指令</h3><p>接下来所学习的指令都来自ngx_http_gzip_module模块，该模块会在nginx安装的时候内置到nginx的安装环境中，也就是说我们可以直接使用这些指令。</p>
<ol>
<li>gzip指令：该指令用于开启或者关闭gzip功能</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
<p>注意只有该指令为打开状态，下面的指令才有效果</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">   gzip on<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>gzip_types指令：该指令可以根据响应页的MIME类型选择性地开启Gzip压缩功能</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_types mime-type …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_types text&#x2F;html;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>所选择的值可以从mime.types文件中进行查找，也可以使用”*”代表所有。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	gzip_types application/javascript<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>gzip_comp_level指令：该指令用于设置Gzip压缩程度，级别从1-9,1表示要是程度最低，要是效率最高，9刚好相反，压缩程度最高，但是效率最低最费时间。</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_comp_level level;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_comp_level 1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	gzip_comp_level 6<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>gzip_vary指令：该指令用于设置使用Gzip进行压缩发送是否携带“Vary:Accept-Encoding”头域的响应头部。主要是告诉接收方，所发送的数据经过了Gzip压缩处理</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_vary on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_vary off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587361606028.png" alt="1587361606028"></p>
<ol start="5">
<li>gzip_buffers指令：该指令用于处理请求压缩的缓冲区数量和大小。</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_buffers number size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_buffers 32 4k|16 8k;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>其中number:指定Nginx服务器向系统申请缓存空间个数，size指的是每个缓存空间的大小。主要实现的是申请number个每个大小为size的内存空间。这个值的设定一般会和服务器的操作系统有关，所以建议此项不设置，使用默认值即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_buffers 4 16K;	  #缓存空间大小</span><br></pre></td></tr></table></figure>



<ol start="6">
<li>gzip_disable指令：针对不同种类客户端发起的请求，可以选择性地开启和关闭Gzip功能。</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_disable regex …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>regex:根据客户端的浏览器标志(user-agent)来设置，支持使用正则表达式。指定的浏览器标志不使用Gzip.该指令一般是用来排除一些明显不支持Gzip的浏览器。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br></pre></td></tr></table></figure>



<ol start="7">
<li>gzip_http_version指令：针对不同的HTTP协议版本，可以选择性地开启和关闭Gzip功能。</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_http_version 1.0|1.1;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_http_version 1.1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>该指令是指定使用Gzip的HTTP最低版本，该指令一般采用默认值即可。</p>
<ol start="8">
<li>gzip_min_length指令：该指令针对传输数据的大小，可以选择性地开启和关闭Gzip功能</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_min_length length;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_min_length 20;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nignx计量大小的单位：bytes[字节] / kb[千字节] / M[兆]</span><br><span class="line">例如: 1024 / 10k|K / 10m|M</span><br></pre></td></tr></table></figure>

<p>Gzip压缩功能对大数据的压缩效果明显，但是如果要压缩的数据比较小的化，可能出现越压缩数据量越大的情况，因此我们需要根据响应内容的大小来决定是否使用Gzip功能，响应页面的大小可以通过头信息中的<code>Content-Length</code>来获取。但是如何使用了Chunk编码动态压缩，该指令将被忽略。建议设置为1K或以上。</p>
<ol start="9">
<li>gzip_proxied指令：该指令设置是否对服务端返回的结果进行Gzip压缩。</li>
</ol>
<table>
<thead>
<tr>
<th>语法</th>
<th>gzip_proxied  off|expired|no-cache|<br/>no-store|private|no_last_modified|no_etag|auth|any;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_proxied off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>off - 关闭Nginx服务器对后台服务器返回结果的Gzip压缩<br>expired - 启用压缩，如果header头中包含 “Expires” 头信息<br>no-cache - 启用压缩，如果header头中包含 “Cache-Control:no-cache” 头信息<br>no-store - 启用压缩，如果header头中包含 “Cache-Control:no-store” 头信息<br>private - 启用压缩，如果header头中包含 “Cache-Control:private” 头信息<br>no_last_modified - 启用压缩,如果header头中不包含 “Last-Modified” 头信息<br>no_etag - 启用压缩 ,如果header头中不包含 “ETag” 头信息<br>auth - 启用压缩 , 如果header头中包含 “Authorization” 头信息<br>any - 无条件启用压缩</p>
<h3 id="Gzip压缩功能的实例配置"><a href="#Gzip压缩功能的实例配置" class="headerlink" title="Gzip压缩功能的实例配置"></a>Gzip压缩功能的实例配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gzip on;  			  #开启gzip功能</span><br><span class="line">gzip_types *;		  #压缩源文件类型,根据具体的访问资源类型设定</span><br><span class="line">gzip_comp_level 6;	  #gzip压缩级别</span><br><span class="line">gzip_min_length 1024; #进行压缩响应页面的最小长度,content-length</span><br><span class="line">gzip_buffers 4 16K;	  #缓存空间大小</span><br><span class="line">gzip_http_version 1.1; #指定压缩响应所需要的最低HTTP请求版本</span><br><span class="line">gzip_vary  on;		  #往头信息中添加压缩标识</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;; #对IE6以下的版本都不进行压缩</span><br><span class="line">gzip_proxied  off； #nginx作为反向代理压缩服务端返回数据的条件</span><br></pre></td></tr></table></figure>

<p>这些配置在很多地方可能都会用到，所以我们可以将这些内容抽取到一个配置文件中，然后通过include指令把配置文件再次加载到nginx.conf配置文件中，方法使用。</p>
<p>nginx_gzip.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">gzip on;</span><br><span class="line">gzip_types *;</span><br><span class="line">gzip_comp_level 6;</span><br><span class="line">gzip_min_length 1024;</span><br><span class="line">gzip_buffers 4 16K;</span><br><span class="line">gzip_http_version 1.1;</span><br><span class="line">gzip_vary  on;</span><br><span class="line">gzip_disable &quot;MSIE [1-6]\.&quot;;</span><br><span class="line">gzip_proxied  off;</span><br></pre></td></tr></table></figure>

<p>nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">include nginx_gzip.conf</span><br></pre></td></tr></table></figure>

<h3 id="Gzip和sendfile共存问题"><a href="#Gzip和sendfile共存问题" class="headerlink" title="Gzip和sendfile共存问题"></a>Gzip和sendfile共存问题</h3><p>前面在讲解sendfile的时候，提到过，开启sendfile以后，在读取磁盘上的静态资源文件的时候，可以减少拷贝的次数，可以不经过用户进程将静态文件通过网络设备发送出去，但是Gzip要想对资源压缩，是需要经过用户进程进行操作的。所以如何解决两个设置的共存问题。</p>
<p>可以使用ngx_http_gzip_static_module模块的gzip_static指令来解决。</p>
<h4 id="gzip-static指令"><a href="#gzip-static指令" class="headerlink" title="gzip_static指令"></a>gzip_static指令</h4><p>gzip_static: 检查与访问资源同名的.gz文件时，response中以gzip相关的header返回.gz文件的内容。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th><strong>gzip_static</strong> on | off | always;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>gzip_static off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>添加上述命令后，会报一个错误，<code>unknown directive &quot;gzip_static&quot;</code>主要的原因是Nginx默认是没有添加ngx_http_gzip_static_module模块。如何来添加?</p>
<h4 id="添加模块到Nginx的实现步骤"><a href="#添加模块到Nginx的实现步骤" class="headerlink" title="添加模块到Nginx的实现步骤"></a>添加模块到Nginx的实现步骤</h4><p>(1)查询当前Nginx的配置参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure>

<p>(2)将nginx安装目录下sbin目录中的nginx二进制文件进行更名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/sbin</span><br><span class="line">mv nginx nginxold</span><br></pre></td></tr></table></figure>

<p>(3) 进入Nginx的安装目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd /root/nginx/core/nginx-1.16.1</span><br></pre></td></tr></table></figure>

<p>(4)执行make clean清空之前编译的内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make clean</span><br></pre></td></tr></table></figure>

<p>(5)使用configure来配置参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-http_gzip_static_module</span><br></pre></td></tr></table></figure>

<p>(6)使用make命令进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<p>(7) 将objs目录下的nginx二进制执行文件移动到nginx安装目录下的sbin目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv objs/nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>

<p>(8)执行更新命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure>

<h4 id="gzip-static测试使用"><a href="#gzip-static测试使用" class="headerlink" title="gzip_static测试使用"></a>gzip_static测试使用</h4><p>(1)直接访问<code>http://192.168.200.133/jquery.js</code></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587932106429.png" alt="1587932106429"></p>
<p>(2)使用gzip命令进行压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/nginx/html</span><br><span class="line">gzip jquery.js</span><br></pre></td></tr></table></figure>

<p>(3)再次访问<code>http://192.168.200.133/jquery.js</code></p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1587932300006.png" alt="1587932300006"></p>
<h2 id="静态资源的缓存处理"><a href="#静态资源的缓存处理" class="headerlink" title="静态资源的缓存处理"></a>静态资源的缓存处理</h2><h3 id="什么是缓存"><a href="#什么是缓存" class="headerlink" title="什么是缓存"></a>什么是缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">缓存（cache），原始意义是指访问速度比一般随机存取存储器（RAM）快的一种高速存储器，通常它不像系统主存那样使用DRAM技术，而使用昂贵但较快速的SRAM技术。缓存的设置是所有现代计算机系统发挥高性能的重要因素之一。</span><br></pre></td></tr></table></figure>

<h3 id="什么是web缓存"><a href="#什么是web缓存" class="headerlink" title="什么是web缓存"></a>什么是web缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Web缓存是指一个Web资源（如html页面，图片，js，数据等）存在于Web服务器和客户端（浏览器）之间的副本。缓存会根据进来的请求保存输出内容的副本；当下一个请求来到的时候，如果是相同的URL，缓存会根据缓存机制决定是直接使用副本响应访问请求，还是向源服务器再次发送请求。比较常见的就是浏览器会缓存访问过网站的网页，当再次访问这个URL地址的时候，如果网页没有更新，就不会再次下载网页，而是直接使用本地缓存的网页。只有当网站明确标识资源已经更新，浏览器才会再次下载网页</span><br></pre></td></tr></table></figure>

<h3 id="web缓存的种类"><a href="#web缓存的种类" class="headerlink" title="web缓存的种类"></a>web缓存的种类</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">客户端缓存</span><br><span class="line">	浏览器缓存</span><br><span class="line">服务端缓存</span><br><span class="line">	Nginx / Redis / Memcached等</span><br></pre></td></tr></table></figure>

<h3 id="浏览器缓存"><a href="#浏览器缓存" class="headerlink" title="浏览器缓存"></a>浏览器缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览.</span><br></pre></td></tr></table></figure>

<h3 id="为什么要用浏览器缓存"><a href="#为什么要用浏览器缓存" class="headerlink" title="为什么要用浏览器缓存"></a>为什么要用浏览器缓存</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">成本最低的一种缓存实现</span><br><span class="line">减少网络带宽消耗</span><br><span class="line">降低服务器压力</span><br><span class="line">减少网络延迟，加快页面打开速度</span><br></pre></td></tr></table></figure>

<h3 id="浏览器缓存的执行流程"><a href="#浏览器缓存的执行流程" class="headerlink" title="浏览器缓存的执行流程"></a>浏览器缓存的执行流程</h3><p>HTTP协议中和页面缓存相关的字段，我们先来认识下：</p>
<table>
<thead>
<tr>
<th>header</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Expires</td>
<td>缓存过期的日期和时间</td>
</tr>
<tr>
<td>Cache-Control</td>
<td>设置和缓存相关的配置信息</td>
</tr>
<tr>
<td>Last-Modified</td>
<td>请求资源最后修改时间</td>
</tr>
<tr>
<td>ETag</td>
<td>请求变量的实体标签的当前值，比如文件的MD5值</td>
</tr>
</tbody></table>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581762832290.png"></p>
<p>（1）用户首次通过浏览器发送请求到服务端获取数据，客户端是没有对应的缓存，所以需要发送request请求来获取数据；</p>
<p>（2）服务端接收到请求后，获取服务端的数据及服务端缓存的允许后，返回200的成功状态码并且在响应头上附上对应资源以及缓存信息；</p>
<p>（3）当用户再次访问相同资源的时候，客户端会在浏览器的缓存目录中查找是否存在响应的缓存文件</p>
<p>（4）如果没有找到对应的缓存文件，则走(2)步</p>
<p>（5）如果有缓存文件，接下来对缓存文件是否过期进行判断，过期的判断标准是(Expires),</p>
<p>（6）如果没有过期，则直接从本地缓存中返回数据进行展示</p>
<p>（7）如果Expires过期，接下来需要判断缓存文件是否发生过变化</p>
<p>（8）判断的标准有两个，一个是ETag(Entity Tag),一个是Last-Modified</p>
<p>（9）判断结果是未发生变化，则服务端返回304，直接从缓存文件中获取数据</p>
<p>（10）如果判断是发生了变化，重新从服务端获取数据，并根据缓存协商(服务端所设置的是否需要进行缓存数据的设置)来进行数据缓存。</p>
<h3 id="浏览器缓存相关指令"><a href="#浏览器缓存相关指令" class="headerlink" title="浏览器缓存相关指令"></a>浏览器缓存相关指令</h3><p>Nginx需要进行缓存相关设置，就需要用到如下的指令</p>
<h4 id="expires指令"><a href="#expires指令" class="headerlink" title="expires指令"></a>expires指令</h4><p>expires:该指令用来控制页面缓存的作用。可以通过该指令控制HTTP应答中的“Expires”和”Cache-Control”</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>expires   [modified] time<br/>expires epoch|max|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>expires off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>time:可以整数也可以是负数，指定过期时间，如果是负数，Cache-Control则为no-cache,如果为整数或0，则Cache-Control的值为max-age&#x3D;time;</p>
<p>epoch: 指定Expires的值为’1 January,1970,00:00:01 GMT’(1970-01-01 00:00:00)，Cache-Control的值no-cache</p>
<p>max:指定Expires的值为’31 December2037 23:59:59GMT’ (2037-12-31 23:59:59) ，Cache-Control的值为10年</p>
<p>off:默认不缓存。</p>
<h4 id="add-header指令"><a href="#add-header指令" class="headerlink" title="add_header指令"></a>add_header指令</h4><p>add_header指令是用来添加指定的响应头和响应值。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>add_header name value [always];</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location…</td>
</tr>
</tbody></table>
<p>Cache-Control作为响应头信息，可以设置如下值：</p>
<p>缓存响应指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cache-control: must-revalidate</span><br><span class="line">Cache-control: no-cache</span><br><span class="line">Cache-control: no-store</span><br><span class="line">Cache-control: no-transform</span><br><span class="line">Cache-control: public</span><br><span class="line">Cache-control: private</span><br><span class="line">Cache-control: proxy-revalidate</span><br><span class="line">Cache-Control: max-age=&lt;seconds&gt;</span><br><span class="line">Cache-control: s-maxage=&lt;seconds&gt;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>must-revalidate</td>
<td>可缓存但必须再向源服务器进行确认</td>
</tr>
<tr>
<td>no-cache</td>
<td>缓存前必须确认其有效性</td>
</tr>
<tr>
<td>no-store</td>
<td>不缓存请求或响应的任何内容</td>
</tr>
<tr>
<td>no-transform</td>
<td>代理不可更改媒体类型</td>
</tr>
<tr>
<td>public</td>
<td>可向任意方提供响应的缓存</td>
</tr>
<tr>
<td>private</td>
<td>仅向特定用户返回响应</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>要求中间缓存服务器对缓存的响应有效性再进行确认</td>
</tr>
<tr>
<td>max-age&#x3D;&lt;秒&gt;</td>
<td>响应最大Age值</td>
</tr>
<tr>
<td>s-maxage&#x3D;&lt;秒&gt;</td>
<td>公共缓存服务器响应的最大Age值</td>
</tr>
</tbody></table>
<p>max-age&#x3D;[秒]：</p>
<h1 id="Nginx的跨域问题解决"><a href="#Nginx的跨域问题解决" class="headerlink" title="Nginx的跨域问题解决"></a>Nginx的跨域问题解决</h1><p>这块内容，我们主要从以下方面进行解决：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">什么情况下会出现跨域问题?</span><br><span class="line">实例演示跨域问题</span><br><span class="line">具体的解决方案是什么?</span><br></pre></td></tr></table></figure>

<h2 id="同源策略"><a href="#同源策略" class="headerlink" title="同源策略"></a>同源策略</h2><p>浏览器的同源策略：是一种约定，是浏览器最核心也是最基本的安全功能，如果浏览器少了同源策略，则浏览器的正常功能可能都会受到影响。</p>
<p>同源:  协议、域名(IP)、端口相同即为同源</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.131/user/1</span><br><span class="line">https://192.168.200.131/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://192.168.200.131/user/1</span><br><span class="line">http://192.168.200.132/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://192.168.200.131/user/1</span><br><span class="line">http://192.168.200.131:8080/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://www.nginx.com/user/1</span><br><span class="line">http://www.nginx.org/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://192.168.200.131/user/1</span><br><span class="line">http://192.168.200.131:8080/user/1</span><br><span class="line">不</span><br><span class="line"></span><br><span class="line">http://www.nginx.org:80/user/1</span><br><span class="line">http://www.nginx.org/user/1</span><br><span class="line">满足</span><br></pre></td></tr></table></figure>

<h2 id="跨域问题"><a href="#跨域问题" class="headerlink" title="跨域问题"></a>跨域问题</h2><p>简单描述下:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">有两台服务器分别为A,B,如果从服务器A的页面发送异步请求到服务器B获取数据，如果服务器A和服务器B不满足同源策略，则就会出现跨域问题。</span><br></pre></td></tr></table></figure>

<h2 id="跨域问题的案例演示"><a href="#跨域问题的案例演示" class="headerlink" title="跨域问题的案例演示"></a>跨域问题的案例演示</h2><p>出现跨域问题会有什么效果?,接下来通过一个需求来给大家演示下：</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581766282200.png">（1）nginx的html目录下新建一个a.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>跨域问题演示<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;jquery.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            $(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                $(<span class="string">&quot;#btn&quot;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                        $.<span class="title function_">get</span>(<span class="string">&#x27;http://192.168.200.133:8080/getUser&#x27;</span>,<span class="keyword">function</span>(<span class="params">data</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                                <span class="title function_">alert</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(data));</span></span><br><span class="line"><span class="language-javascript">                        &#125;);</span></span><br><span class="line"><span class="language-javascript">                &#125;);</span></span><br><span class="line"><span class="language-javascript">            &#125;);</span></span><br><span class="line"><span class="language-javascript">        </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">value</span>=<span class="string">&quot;获取数据&quot;</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（2）在nginx.conf配置如下内容</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">        listen  8080<span class="comment">;</span></span><br><span class="line">        server_name localhost<span class="comment">;</span></span><br><span class="line">        location /getUser&#123;</span><br><span class="line">                default_type application/json<span class="comment">;</span></span><br><span class="line">                return 200 &#x27;&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18&#125;&#x27;<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	listen 	80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">		index index.html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>(3)通过浏览器访问测试</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1588004913681.png" alt="1588004913681"></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>使用add_header指令，该指令可以用来添加一些头信息</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>add_header name  value…</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>此处用来解决跨域问题，需要添加两个头信息，一个是<code>Access-Control-Allow-Origin</code>,<code>Access-Control-Allow-Methods</code></p>
<p>Access-Control-Allow-Origin: 直译过来是允许跨域访问的源地址信息，可以配置多个(多个用逗号分隔)，也可以使用<code>*</code>代表所有源</p>
<p>Access-Control-Allow-Methods:直译过来是允许跨域访问的请求方式，值可以为 GET POST PUT DELETE…,可以全部设置，也可以根据需要设置，多个用逗号分隔</p>
<p>具体配置方式</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location /getUser&#123;</span><br><span class="line">    add_header Access-Control-Allow-Origin *<span class="comment">;</span></span><br><span class="line">    add_header Access-Control-Allow-Methods GET,POST,PUT,DELETE<span class="comment">;</span></span><br><span class="line">    default_type application/json<span class="comment">;</span></span><br><span class="line">    return 200 &#x27;&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18&#125;&#x27;<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="静态资源防盗链"><a href="#静态资源防盗链" class="headerlink" title="静态资源防盗链"></a>静态资源防盗链</h2><h3 id="什么是资源盗链"><a href="#什么是资源盗链" class="headerlink" title="什么是资源盗链"></a>什么是资源盗链</h3><p>资源盗链指的是此内容不在自己服务器上，而是通过技术手段，绕过别人的限制将别人的内容放到自己页面上最终展示给用户。以此来盗取大网站的空间和流量。简而言之就是用别人的东西成就自己的网站。</p>
<p>效果演示</p>
<p>京东:<a target="_blank" rel="noopener" href="https://img14.360buyimg.com/n7/jfs/t1/101062/37/2153/254169/5dcbd410E6d10ba22/4ddbd212be225fcd.jpg">https://img14.360buyimg.com/n7/jfs/t1/101062/37/2153/254169/5dcbd410E6d10ba22/4ddbd212be225fcd.jpg</a></p>
<p>百度:<a target="_blank" rel="noopener" href="https://pics7.baidu.com/feed/cf1b9d16fdfaaf516f7e2011a7cda1e8f11f7a1a.jpeg?token=551979a23a0995e5e5279b8fa1a48b34&amp;s=BD385394D2E963072FD48543030030BB">https://pics7.baidu.com/feed/cf1b9d16fdfaaf516f7e2011a7cda1e8f11f7a1a.jpeg?token=551979a23a0995e5e5279b8fa1a48b34&amp;s=BD385394D2E963072FD48543030030BB</a></p>
<p>我们自己准备一个页面，在页面上引入这两个图片查看效果</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581827029973.png"></p>
<p>从上面的效果，可以看出来，下面的图片地址添加了防止盗链的功能，京东这边我们可以直接使用其图片。</p>
<h3 id="Nginx防盗链的实现原理："><a href="#Nginx防盗链的实现原理：" class="headerlink" title="Nginx防盗链的实现原理："></a>Nginx防盗链的实现原理：</h3><p>了解防盗链的原理之前，我们得先学习一个HTTP的头信息Referer,当浏览器向web服务器发送请求的时候，一般都会带上Referer,来告诉浏览器该网页是从哪个页面链接过来的。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581769820325.png"></p>
<p>后台服务器可以根据获取到的这个Referer信息来判断是否为自己信任的网站地址，如果是则放行继续访问，如果不是则可以返回403(服务端拒绝访问)的状态信息。</p>
<p>在本地模拟上述的服务器效果：</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581769079083.png"></p>
<p>Nginx防盗链的具体实现:</p>
<p>valid_referers:nginx会通就过查看referer自动和valid_referers后面的内容进行匹配，如果匹配到了就将$invalid_referer变量置0，如果没有匹配到，则将$invalid_referer变量置为1，匹配的过程中不区分大小写。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>valid_referers none|blocked|server_names|string…</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location</td>
</tr>
</tbody></table>
<p>none: 如果Header中的Referer为空，允许访问</p>
<p>blocked:在Header中的Referer不为空，但是该值被防火墙或代理进行伪装过，如不带”http:&#x2F;&#x2F;“ 、”https:&#x2F;&#x2F;“等协议头的资源允许访问。</p>
<p>server_names:指定具体的域名或者IP</p>
<p>string: 可以支持正则表达式和*的字符串。如果是正则表达式，需要以<code>~</code>开头表示，例如</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location ~*\.(png|jpg|gif)&#123;</span><br><span class="line">           valid_referers none blocked www.baidu.com 192.168.200.222 *.example.com example.*  www.example.org  ~\.google\.<span class="comment">;</span></span><br><span class="line">           if ($invalid_referer)&#123;</span><br><span class="line">                return 403<span class="comment">;</span></span><br><span class="line">           &#125;</span><br><span class="line">           root /usr/local/nginx/html<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>遇到的问题:图片有很多，该如何批量进行防盗链？</p>
<h3 id="针对目录进行防盗链"><a href="#针对目录进行防盗链" class="headerlink" title="针对目录进行防盗链"></a>针对目录进行防盗链</h3><p>配置如下：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /images &#123;</span><br><span class="line">           valid_referers none blocked www.baidu.com 192.168.200.222 *.example.com example.*  www.example.org  ~\.google\.<span class="comment">;</span></span><br><span class="line">           if ($invalid_referer)&#123;</span><br><span class="line">                return 403<span class="comment">;</span></span><br><span class="line">           &#125;</span><br><span class="line">           root /usr/local/nginx/html<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们可以对一个目录下的所有资源进行翻到了操作。</p>
<p>遇到的问题：Referer的限制比较粗，比如随意加一个Referer，上面的方式是无法进行限制的。那么这个问题改如何解决？</p>
<p>此处我们需要用到Nginx的第三方模块<code>ngx_http_accesskey_module</code>，第三方模块如何实现盗链，如果在Nginx中使用第三方模块的功能，这些我们在后面的Nginx的模块篇再进行详细的讲解。</p>
<h2 id="Rewrite功能配置"><a href="#Rewrite功能配置" class="headerlink" title="Rewrite功能配置"></a>Rewrite功能配置</h2><p>Rewrite是Nginx服务器提供的一个重要基本功能，是Web服务器产品中几乎必备的功能。主要的作用是用来实现URL的重写。</p>
<p>注意:Nginx服务器的Rewrite功能的实现依赖于PCRE的支持，因此在编译安装Nginx服务器之前，需要安装PCRE库。Nginx使用的是ngx_http_rewrite_module模块来解析和处理Rewrite功能的相关配置。</p>
<h3 id="“地址重写”与”地址转发”"><a href="#“地址重写”与”地址转发”" class="headerlink" title="“地址重写”与”地址转发”"></a>“地址重写”与”地址转发”</h3><p>重写和转发的区别:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">地址重写浏览器地址会发生变化而地址转发则不变</span><br><span class="line">一次地址重写会产生两次请求而一次地址转发只会产生一次请求</span><br><span class="line">地址重写到的页面必须是一个完整的路径而地址转发则不需要</span><br><span class="line">地址重写因为是两次请求所以request范围内属性不能传递给新页面而地址转发因为是一次请求所以可以传递值</span><br><span class="line">地址转发速度快于地址重写</span><br></pre></td></tr></table></figure>

<h3 id="Rewrite规则"><a href="#Rewrite规则" class="headerlink" title="Rewrite规则"></a>Rewrite规则</h3><h4 id="set指令"><a href="#set指令" class="headerlink" title="set指令"></a>set指令</h4><p>该指令用来设置一个新的变量。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>set $variable value;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>variable:变量的名称，该变量名称要用”$”作为变量的第一个字符，且不能与Nginx服务器预设的全局变量同名。</p>
<p>value:变量的值，可以是字符串、其他变量或者变量的组合等。</p>
<h4 id="Rewrite常用全局变量"><a href="#Rewrite常用全局变量" class="headerlink" title="Rewrite常用全局变量"></a>Rewrite常用全局变量</h4><table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>$args</td>
<td>变量中存放了请求URL中的请求指令。比如<a target="_blank" rel="noopener" href="http://192.168.200.133:8080/?arg1=value1&amp;args2=value2%E4%B8%AD%E7%9A%84&quot;arg1=value1&amp;arg2=value2&quot;%EF%BC%8C%E5%8A%9F%E8%83%BD%E5%92%8C$query_string%E4%B8%80%E6%A0%B7">http://192.168.200.133:8080?arg1=value1&amp;args2=value2中的&quot;arg1=value1&amp;arg2=value2&quot;，功能和$query_string一样</a></td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>变量存储的是用户访问服务的代理信息(如果通过浏览器访问，记录的是浏览器的相关版本信息)</td>
</tr>
<tr>
<td>$host</td>
<td>变量存储的是访问服务器的server_name值</td>
</tr>
<tr>
<td>$document_uri</td>
<td>变量存储的是当前访问地址的URI。比如<a target="_blank" rel="noopener" href="http://192.168.200.133/server?id=10&amp;name=zhangsan%E4%B8%AD%E7%9A%84&quot;/server&quot;%EF%BC%8C%E5%8A%9F%E8%83%BD%E5%92%8C$uri%E4%B8%80%E6%A0%B7">http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server&quot;，功能和$uri一样</a></td>
</tr>
<tr>
<td>$document_root</td>
<td>变量存储的是当前请求对应location的root值，如果未设置，默认指向Nginx自带html目录所在位置</td>
</tr>
<tr>
<td>$content_length</td>
<td>变量存储的是请求头中的Content-Length的值</td>
</tr>
<tr>
<td>$content_type</td>
<td>变量存储的是请求头中的Content-Type的值</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>变量存储的是客户端的cookie信息，可以通过add_header Set-Cookie ‘cookieName&#x3D;cookieValue’来添加cookie数据</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>变量中存储的是Nginx服务器对网络连接速率的限制，也就是Nginx配置中对limit_rate指令设置的值，默认是0，不限制。</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>变量中存储的是客户端的IP地址</td>
</tr>
<tr>
<td>$remote_port</td>
<td>变量中存储了客户端与服务端建立连接的端口号</td>
</tr>
<tr>
<td>$remote_user</td>
<td>变量中存储了客户端的用户名，需要有认证模块才能获取</td>
</tr>
<tr>
<td>$scheme</td>
<td>变量中存储了访问协议</td>
</tr>
<tr>
<td>$server_addr</td>
<td>变量中存储了服务端的地址</td>
</tr>
<tr>
<td>$server_name</td>
<td>变量中存储了客户端请求到达的服务器的名称</td>
</tr>
<tr>
<td>$server_port</td>
<td>变量中存储了客户端请求到达服务器的端口号</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>变量中存储了客户端请求协议的版本，比如”HTTP&#x2F;1.1”</td>
</tr>
<tr>
<td>$request_body_file</td>
<td>变量中存储了发给后端服务器的本地文件资源的名称</td>
</tr>
<tr>
<td>$request_method</td>
<td>变量中存储了客户端的请求方式，比如”GET”,”POST”等</td>
</tr>
<tr>
<td>$request_filename</td>
<td>变量中存储了当前请求的资源文件的路径名</td>
</tr>
<tr>
<td>$request_uri</td>
<td>变量中存储了当前请求的URI，并且携带请求参数，比如<a target="_blank" rel="noopener" href="http://192.168.200.133/server?id=10&amp;name=zhangsan%E4%B8%AD%E7%9A%84&quot;/server?id=10&amp;name=zhangsan&quot;">http://192.168.200.133/server?id=10&amp;name=zhangsan中的&quot;/server?id=10&amp;name=zhangsan&quot;</a></td>
</tr>
</tbody></table>
<h4 id="if指令"><a href="#if指令" class="headerlink" title="if指令"></a>if指令</h4><p>该指令用来支持条件判断，并根据条件判断结果选择不同的Nginx配置。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>if  (condition){…}</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location</td>
</tr>
</tbody></table>
<p>condition为判定条件，可以支持以下写法：</p>
<ol>
<li>变量名。如果变量名对应的值为空或者是0，if都判断为false,其他条件为true。</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($param)&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2. 使用&quot;=&quot;和&quot;!=&quot;比较变量和字符串是否相等，满足条件为true，不满足为false</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($<span class="attr">request_method</span> = POST)&#123;</span><br><span class="line">	return 405<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：此处和Java不太一样的地方是字符串不需要添加引号。</p>
<ol start="3">
<li><p>使用正则表达式对变量进行匹配，匹配成功返回true，否则返回false。变量与正则表达式之间使用”<del>“,”</del>*”,”!<del>“,”!</del>*“来连接。</p>
<p>“~”代表匹配正则表达式过程中区分大小写，</p>
<p>“~*“代表匹配正则表达式过程中不区分大小写</p>
<p>“!<del>“和”!</del>*“刚好和上面取相反值，如果匹配上返回false,匹配不上返回true</p>
</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~ MSIE)&#123;</span><br><span class="line">	<span class="comment">#$http_user_agent的值中是否包含MSIE字符串，如果包含返回true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：正则表达式字符串一般不需要加引号，但是如果字符串中包含”}”或者是”;”等字符时，就需要把引号加上。</p>
<ol start="4">
<li><p>判断请求的文件是否存在使用”-f”和”!-f”,</p>
<p>当使用”-f”时，如果请求的文件存在返回true，不存在返回false。</p>
<p>当使用”!f”时，如果请求文件不存在，但该文件所在目录存在返回true,文件和目录都不存在返回false,如果文件存在返回false</p>
</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if (-f $request_filename)&#123;</span><br><span class="line">	<span class="comment">#判断请求的文件是否存在</span></span><br><span class="line">&#125;</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">	<span class="comment">#判断请求的文件是否不存在</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li><p>判断请求的目录是否存在使用”-d”和”!-d”,</p>
<p>当使用”-d”时，如果请求的目录存在，if返回true，如果目录不存在则返回false</p>
<p>当使用”!-d”时，如果请求的目录不存在但该目录的上级目录存在则返回true，该目录和它上级目录都不存在则返回false,如果请求目录存在也返回false.</p>
</li>
<li><p>判断请求的目录或者文件是否存在使用”-e”和”!-e”</p>
<p>当使用”-e”,如果请求的目录或者文件存在时，if返回true,否则返回false.</p>
<p>当使用”!-e”,如果请求的文件和文件所在路径上的目录都不存在返回true,否则返回false</p>
</li>
<li><p>判断请求的文件是否可执行使用”-x”和”!-x”</p>
<p>当使用”-x”,如果请求的文件可执行，if返回true,否则返回false</p>
<p>当使用”!-x”,如果请求文件不可执行，返回true,否则返回false</p>
</li>
</ol>
<h4 id="break指令"><a href="#break指令" class="headerlink" title="break指令"></a>break指令</h4><p>该指令用于中断当前相同作用域中的其他Nginx配置。与该指令处于同一作用域的Nginx配置中，位于它前面的指令配置生效，位于后面的指令配置无效。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>break;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>例子:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">location /&#123;</span><br><span class="line">	if ($param)&#123;</span><br><span class="line">		set $id $1<span class="comment">;</span></span><br><span class="line">		break<span class="comment">;</span></span><br><span class="line">		limit_rate 10k<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="return指令"><a href="#return指令" class="headerlink" title="return指令"></a>return指令</h4><p>该指令用于完成对请求的处理，直接向客户端返回响应状态代码。在return后的所有Nginx配置都是无效的。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>return code [text];<br/>return code URL;<br/>return URL;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>code:为返回给客户端的HTTP状态代理。可以返回的状态代码为0~999的任意HTTP状态代理</p>
<p>text:为返回给客户端的响应体内容，支持变量的使用</p>
<p>URL:为返回给客户端的URL地址</p>
<h4 id="rewrite指令"><a href="#rewrite指令" class="headerlink" title="rewrite指令"></a>rewrite指令</h4><p>该指令通过正则表达式的使用来改变URI。可以同时存在一个或者多个指令，按照顺序依次对URL进行匹配和处理。</p>
<p>URL和URI的区别：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">URI:统一资源标识符</span><br><span class="line">URL:统一资源定位符</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>语法</th>
<th>rewrite regex replacement [flag];</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location、if</td>
</tr>
</tbody></table>
<p>regex:用来匹配URI的正则表达式</p>
<p>replacement:匹配成功后，用于替换URI中被截取内容的字符串。如果该字符串是以”http:&#x2F;&#x2F;“或者”https:&#x2F;&#x2F;“开头的，则不会继续向下对URI进行其他处理，而是直接返回重写后的URI给客户端。</p>
<p>flag:用来设置rewrite对URI的处理行为，可选值有如下：</p>
<ul>
<li>last:</li>
<li>break</li>
<li>redirect</li>
<li>permanent</li>
</ul>
<h4 id="rewrite-log指令"><a href="#rewrite-log指令" class="headerlink" title="rewrite_log指令"></a>rewrite_log指令</h4><p>该指令配置是否开启URL重写日志的输出功能。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>rewrite_log on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>rewrite_log off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location、if</td>
</tr>
</tbody></table>
<p>开启后，URL重写的相关日志将以notice级别输出到error_log指令配置的日志文件汇总。</p>
<h3 id="Rewrite的案例"><a href="#Rewrite的案例" class="headerlink" title="Rewrite的案例"></a>Rewrite的案例</h3><h4 id="域名跳转"><a href="#域名跳转" class="headerlink" title="域名跳转"></a>域名跳转</h4><p>》问题分析</p>
<p>先来看一个效果，如果我们想访问京东网站，大家都知道我们可以输入<code>www.jd.com</code>,但是同样的我们也可以输入<code>www.360buy.com</code>同样也都能访问到京东网站。这个其实是因为京东刚开始的时候域名就是<a target="_blank" rel="noopener" href="http://www.360buy.com,后面由于各种原因把自己的域名换成了www.jd.com/">www.360buy.com，后面由于各种原因把自己的域名换成了www.jd.com</a>, 虽然说域名变量，但是对于以前只记住了<a target="_blank" rel="noopener" href="http://www.360buy.com的用户来说,我们如何把这部分用户也迁移到我们新域名的访问上来,针对于这个问题,我们就可以使用nginx中rewrite的域名跳转来解决./">www.360buy.com的用户来说，我们如何把这部分用户也迁移到我们新域名的访问上来，针对于这个问题，我们就可以使用Nginx中Rewrite的域名跳转来解决。</a></p>
<p>》环境准备</p>
<ul>
<li>准备两个域名  <a target="_blank" rel="noopener" href="http://www.360buy.com/">www.360buy.com</a> | <a target="_blank" rel="noopener" href="http://www.jd.com/">www.jd.com</a></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.200.133 www.360buy.com</span><br><span class="line">192.168.200.133 www.jd.com</span><br></pre></td></tr></table></figure>

<ul>
<li>在&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;html&#x2F;hm目录下创建一个访问页面</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">h1</span>&gt;</span>欢迎来到我们的网站<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>通过Nginx实现当访问www.访问到系统的首页</li>
</ul>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.hm.com<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		root /usr/local/nginx/html/hm<span class="comment">;</span></span><br><span class="line">		index index.html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>》通过Rewrite完成将<a target="_blank" rel="noopener" href="http://www.360buy.com的请求跳转到www.jd.com/">www.360buy.com的请求跳转到www.jd.com</a></p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.360buy.com<span class="comment">;</span></span><br><span class="line">	rewrite ^/ http://www.jd.com permanent<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题描述:如何在域名跳转的过程中携带请求的URI？</p>
<p>修改配置信息</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.itheima.com<span class="comment">;</span></span><br><span class="line">	rewrite ^(.*) http://www.hm.com$1 permanent<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问题描述:我们除了上述说的<a target="_blank" rel="noopener" href="http://www.jd.com/">www.jd.com</a> 、<a target="_blank" rel="noopener" href="http://www.360buy.com其实还有我们也可以通过www.jingdong.com来访问,那么如何通过rewrite来实现多个域名的跳转/">www.360buy.com其实还有我们也可以通过www.jingdong.com来访问，那么如何通过Rewrite来实现多个域名的跳转</a>?</p>
<p>添加域名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts</span><br><span class="line">192.168.200.133 www.jingdong.com</span><br></pre></td></tr></table></figure>

<p>修改配置信息</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.360buy.com www.jingdong.com<span class="comment">;</span></span><br><span class="line">	rewrite ^(.*) http://www.jd.com$1 permanent<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="域名镜像"><a href="#域名镜像" class="headerlink" title="域名镜像"></a>域名镜像</h4><p>上述案例中，将<a target="_blank" rel="noopener" href="http://www.360buy.com/">www.360buy.com</a> 和 <a target="_blank" rel="noopener" href="http://www.jingdong.com都能跳转到www.jd.com,那么www.jd.com我们就可以把它起名叫主域名,其他两个就是我们所说的镜像域名,当然如果我们不想把整个网站做镜像,只想为其中某一个子目录下的资源做镜像,我们可以在location块中配置rewrite功能,比如/">www.jingdong.com都能跳转到www.jd.com，那么www.jd.com我们就可以把它起名叫主域名，其他两个就是我们所说的镜像域名，当然如果我们不想把整个网站做镜像，只想为其中某一个子目录下的资源做镜像，我们可以在location块中配置rewrite功能，比如</a>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name rewrite.myweb.com<span class="comment">;</span></span><br><span class="line">	location ^~ /source1&#123;</span><br><span class="line">		rewrite ^/resource1(.*) http://rewrite.myweb.com/web$1 last<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	location ^~ /source2&#123;</span><br><span class="line">		rewrite ^/resource2(.*) http://rewrite.myweb.com/web$1 last<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="独立域名"><a href="#独立域名" class="headerlink" title="独立域名"></a>独立域名</h4><p>一个完整的项目包含多个模块，比如购物网站有商品商品搜索模块、商品详情模块已经购物车模块等，那么我们如何为每一个模块设置独立的域名。</p>
<p>需求：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://search.hm.com  访问商品搜索模块</span><br><span class="line">http://item.hm.com	  访问商品详情模块</span><br><span class="line">http://cart.hm.com	  访问商品购物车模块</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name search.hm.com<span class="comment">;</span></span><br><span class="line">	rewrite ^(.*) http://www.hm.com/bbs$1 last<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	listen 81<span class="comment">;</span></span><br><span class="line">	server_name item.hm.com<span class="comment">;</span></span><br><span class="line">	rewrite ^(.*) http://www.hm.com/item$1 last<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	listen 82<span class="comment">;</span></span><br><span class="line">	server_name cart.hm.com<span class="comment">;</span></span><br><span class="line">	rewrite ^(.*) http://www.hm.com/cart$1 last<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="目录自动添加”-x2F-“"><a href="#目录自动添加”-x2F-“" class="headerlink" title="目录自动添加”&#x2F;“"></a>目录自动添加”&#x2F;“</h4><p>问题描述</p>
<p>通过一个例子来演示下问题:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen	80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">		index index.html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>要想访问上述资源，很简单，只需要通过<a target="_blank" rel="noopener" href="http://192.168.200.133直接就能访问,地址后面不需要加/,%E4%BD%86%E6%98%AF%E5%A6%82%E6%9E%9C%E5%B0%86%E4%B8%8A%E8%BF%B0%E7%9A%84%E9%85%8D%E7%BD%AE%E4%BF%AE%E6%94%B9%E4%B8%BA%E5%A6%82%E4%B8%8B%E5%86%85%E5%AE%B9">http://192.168.200.133直接就能访问，地址后面不需要加/,但是如果将上述的配置修改为如下内容</a>:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen	80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /hm &#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">		index index.html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个时候，要想访问上述资源，按照上述的访问方式，我们可以通过<a target="_blank" rel="noopener" href="http://192.168.200.133/hm/%E6%9D%A5%E8%AE%BF%E9%97%AE,%E4%BD%86%E6%98%AF%E5%A6%82%E6%9E%9C%E5%9C%B0%E5%9D%80%E5%90%8E%E9%9D%A2%E4%B8%8D%E5%8A%A0%E6%96%9C%E6%9D%A0%EF%BC%8C%E9%A1%B5%E9%9D%A2%E5%B0%B1%E4%BC%9A%E5%87%BA%E9%97%AE%E9%A2%98%E3%80%82%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%8A%A0%E6%96%9C%E6%9D%A0%EF%BC%8CNginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%86%85%E9%83%A8%E4%BC%9A%E8%87%AA%E5%8A%A8%E5%81%9A%E4%B8%80%E4%B8%AA301%E7%9A%84%E9%87%8D%E5%AE%9A%E5%90%91%EF%BC%8C%E9%87%8D%E5%AE%9A%E5%90%91%E7%9A%84%E5%9C%B0%E5%9D%80%E4%BC%9A%E6%9C%89%E4%B8%80%E4%B8%AA%E6%8C%87%E4%BB%A4%E5%8F%ABserver_name_in_redirect">http://192.168.200.133/hm/来访问,但是如果地址后面不加斜杠，页面就会出问题。如果不加斜杠，Nginx服务器内部会自动做一个301的重定向，重定向的地址会有一个指令叫server_name_in_redirect</a> on|off;来决定重定向的地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果该指令为on</span><br><span class="line">	重定向的地址为:  http://server_name/目录名/;</span><br><span class="line">如果该指令为off</span><br><span class="line">	重定向的地址为:  http://原URL中的域名/目录名/;</span><br></pre></td></tr></table></figure>

<p>所以就拿刚才的地址来说，<a target="_blank" rel="noopener" href="http://192.168.200.133/hm%E5%A6%82%E6%9E%9C%E4%B8%8D%E5%8A%A0%E6%96%9C%E6%9D%A0%EF%BC%8C%E9%82%A3%E4%B9%88%E6%8C%89%E7%85%A7%E4%B8%8A%E8%BF%B0%E8%A7%84%E5%88%99%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%8C%87%E4%BB%A4server_name_in_redirect%E4%B8%BAon%EF%BC%8C%E5%88%99301%E9%87%8D%E5%AE%9A%E5%90%91%E5%9C%B0%E5%9D%80%E5%8F%98%E4%B8%BA">http://192.168.200.133/hm如果不加斜杠，那么按照上述规则，如果指令server_name_in_redirect为on，则301重定向地址变为</a> <a target="_blank" rel="noopener" href="http://localhost/hm/,%E5%A6%82%E6%9E%9C%E4%B8%BAoff%EF%BC%8C%E5%88%99301%E9%87%8D%E5%AE%9A%E5%90%91%E5%9C%B0%E5%9D%80%E5%8F%98%E4%B8%BAhttp://192.168.200.133/ht/%E3%80%82%E5%90%8E%E9%9D%A2%E8%BF%99%E4%B8%AA%E6%98%AF%E6%AD%A3%E5%B8%B8%E7%9A%84%EF%BC%8C%E5%89%8D%E9%9D%A2%E5%9C%B0%E5%9D%80%E5%B0%B1%E6%9C%89%E9%97%AE%E9%A2%98%E3%80%82">http://localhost/hm/,如果为off，则301重定向地址变为http://192.168.200.133/ht/。后面这个是正常的，前面地址就有问题。</a></p>
<p>注意server_name_in_redirect指令在Nginx的0.8.48版本之前默认都是on，之后改成了off,所以现在我们这个版本不需要考虑这个问题，但是如果是0.8.48以前的版本并且server_name_in_redirect设置为on，我们如何通过rewrite来解决这个问题？</p>
<p>解决方案</p>
<p>我们可以使用rewrite功能为末尾没有斜杠的URL自动添加一个斜杠</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen	80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	server_name_in_redirect on<span class="comment">;</span></span><br><span class="line">	location /hm &#123;</span><br><span class="line">		if (-d $request_filename)&#123;</span><br><span class="line">			rewrite ^/(.*)(<span class="section">[^/]</span>)$ http://$host/$1$2/ permanent<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="合并目录"><a href="#合并目录" class="headerlink" title="合并目录"></a>合并目录</h4><p>搜索引擎优化(SEO)是一种利用搜索引擎的搜索规则来提供目的网站的有关搜索引擎内排名的方式。我们在创建自己的站点时，可以通过很多中方式来有效的提供搜索引擎优化的程度。其中有一项就包含URL的目录层级一般不要超过三层，否则的话不利于搜索引擎的搜索也给客户端的输入带来了负担，但是将所有的文件放在一个目录下又会导致文件资源管理混乱并且访问文件的速度也会随着文件增多而慢下来，这两个问题是相互矛盾的，那么使用rewrite如何解决上述问题?</p>
<p>举例，网站中有一个资源文件的访问路径时 &#x2F;server&#x2F;11&#x2F;22&#x2F;33&#x2F;44&#x2F;20.html,也就是说20.html存在于第5级目录下，如果想要访问该资源文件，客户端的URL地址就要写成 <code>http://www.web.name/server/11/22/33/44/20.html</code>,</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.web.name<span class="comment">;</span></span><br><span class="line">	location /server&#123;</span><br><span class="line">		root html<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是这个是非常不利于SEO搜索引擎优化的，同时客户端也不好记.使用rewrite我们可以进行如下配置:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.web.name<span class="comment">;</span></span><br><span class="line">	location /server&#123;</span><br><span class="line">		rewrite ^/server-(<span class="section">[0-9]</span>+)-(<span class="section">[0-9]</span>+)-(<span class="section">[0-9]</span>+)-(<span class="section">[0-9]</span>+)\.html$ /server/$1/$2/$3/$4/$5.html last<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这样的花，客户端只需要输入<a target="_blank" rel="noopener" href="http://www.web.name/server-11-22-33-44-20.html%E5%B0%B1%E5%8F%AF%E4%BB%A5%E8%AE%BF%E9%97%AE%E5%88%B020.html%E9%A1%B5%E9%9D%A2%E4%BA%86%E3%80%82%E8%BF%99%E9%87%8C%E4%B9%9F%E5%85%85%E5%88%86%E5%88%A9%E7%94%A8%E4%BA%86rewrite%E6%8C%87%E4%BB%A4%E6%94%AF%E6%8C%81%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E7%89%B9%E6%80%A7%E3%80%82">http://www.web.name/server-11-22-33-44-20.html就可以访问到20.html页面了。这里也充分利用了rewrite指令支持正则表达式的特性。</a></p>
<h4 id="防盗链"><a href="#防盗链" class="headerlink" title="防盗链"></a>防盗链</h4><p>防盗链之前我们已经介绍过了相关的知识，在rewrite中的防盗链和之前将的原理其实都是一样的，只不过通过rewrite可以将防盗链的功能进行完善下，当出现防盗链的情况，我们可以使用rewrite将请求转发到自定义的一张图片和页面，给用户比较好的提示信息。下面我们就通过根据文件类型实现防盗链的一个配置实例:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.web.com<span class="comment">;</span></span><br><span class="line">	locatin ~* ^.+\.(gif|jpg|png|swf|flv|rar|zip)$&#123;</span><br><span class="line">		valid_referers none blocked server_names *.web.com<span class="comment">;</span></span><br><span class="line">		if ($invalid_referer)&#123;</span><br><span class="line">			rewrite ^/ http://www.web.com/images/forbidden.png<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据目录实现防盗链配置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name www.web.com<span class="comment">;</span></span><br><span class="line">	location /file/&#123;</span><br><span class="line">		root /server/file/<span class="comment">;</span></span><br><span class="line">		valid_referers none blocked server_names *.web.com<span class="comment">;</span></span><br><span class="line">		if ($invalid_referer)&#123;</span><br><span class="line">			rewrite ^/ http://www.web.com/images/forbidden.png<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Nginx反向代理"><a href="#Nginx反向代理" class="headerlink" title="Nginx反向代理"></a>Nginx反向代理</h1><h2 id="Nginx反向代理概述"><a href="#Nginx反向代理概述" class="headerlink" title="Nginx反向代理概述"></a>Nginx反向代理概述</h2><p>关于正向代理和反向代理，我们在前面的章节已经通过一张图给大家详细的介绍过了，简而言之就是正向代理代理的对象是客户端，反向代理代理的是服务端，这是两者之间最大的区别。</p>
<p>Nginx即可以实现正向代理，也可以实现反向代理。</p>
<p>我们先来通过一个小案例演示下Nginx正向代理的简单应用。</p>
<p>先提需求：</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581846370052.png"></p>
<p>(1)服务端的设置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">  log_format main &#x27;client send <span class="attr">request</span>=&gt;clientIp=<span class="variable">$remote_addr</span> serverIp=&gt;<span class="variable">$host</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">	server&#123;</span></span><br><span class="line"><span class="string">		listen 80;</span></span><br><span class="line"><span class="string">		server_name	localhost;</span></span><br><span class="line"><span class="string">		access_log logs/access.log main;</span></span><br><span class="line"><span class="string">		location &#123;</span></span><br><span class="line"><span class="string">			root html;</span></span><br><span class="line"><span class="string">			index index.html index.htm;</span></span><br><span class="line"><span class="string">		&#125;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<p>(2)使用客户端访问服务端，打开日志查看结果</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1589729000713.png" alt="1589729000713"></p>
<p>(3)代理服务器设置：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line"></span><br><span class="line">        listen  82<span class="comment">;</span></span><br><span class="line">        resolver 8.8.8.8<span class="comment">;</span></span><br><span class="line">        location /&#123;</span><br><span class="line">                proxy_pass http://$host$request_uri<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>(4)查看代理服务器的IP(192.168.200.146)和Nginx配置监听的端口(82)</p>
<p>(5)在客户端配置代理服务器</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581847577947.png"></p>
<p>(6)设置完成后，再次通过浏览器访问服务端</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1589729479920.png" alt="1589729479920"></p>
<p>通过对比，上下两次的日志记录，会发现虽然我们是客户端访问服务端，但是如何使用了代理，那么服务端能看到的只是代理发送过去的请求，这样的化，就使用Nginx实现了正向代理的设置。</p>
<p>但是Nginx正向代理，在实际的应用中不是特别多，所以我们简单了解下，接下来我们继续学习Nginx的反向代理，这是Nginx比较重要的一个功能。</p>
<h2 id="Nginx反向代理的配置语法"><a href="#Nginx反向代理的配置语法" class="headerlink" title="Nginx反向代理的配置语法"></a>Nginx反向代理的配置语法</h2><p>Nginx反向代理模块的指令是由<code>ngx_http_proxy_module</code>模块进行解析，该模块在安装Nginx的时候已经自己加装到Nginx中了，接下来我们把反向代理中的常用指令一一介绍下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy_pass</span><br><span class="line">proxy_set_header</span><br><span class="line">proxy_redirect</span><br></pre></td></tr></table></figure>

<h3 id="proxy-pass"><a href="#proxy-pass" class="headerlink" title="proxy_pass"></a>proxy_pass</h3><p>该指令用来设置被代理服务器地址，可以是主机名称、IP地址加端口号形式。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_pass URL;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>location</td>
</tr>
</tbody></table>
<p>URL:为要设置的被代理服务器地址，包含传输协议(<code>http</code>,<code>https://</code>)、主机名称或IP地址加端口号、URI等要素。</p>
<p>举例：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">proxy_pass http://www.baidu.com<span class="comment">;</span></span><br><span class="line">location /server&#123;&#125;</span><br><span class="line">proxy_pass http://192.168.200.146<span class="comment">;</span></span><br><span class="line">    http://192.168.200.146/server/index.html</span><br><span class="line">proxy_pass http://192.168.200.146/<span class="comment">;</span></span><br><span class="line">    http://192.168.200.146/index.html</span><br></pre></td></tr></table></figure>

<p>大家在编写proxy_pass的时候，后面的值要不要加”&#x2F;“?</p>
<p>接下来通过例子来说明刚才我们提到的问题：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		<span class="comment">#proxy_pass http://192.168.200.146;</span></span><br><span class="line">		proxy_pass http://192.168.200.146/<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">当客户端访问 http://localhost/index.html,效果是一样的</span><br><span class="line">server&#123;</span><br><span class="line">	listen 80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /server&#123;</span><br><span class="line">		<span class="comment">#proxy_pass http://192.168.200.146;</span></span><br><span class="line">		proxy_pass http://192.168.200.146/<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">当客户端访问 http://localhost/server/index.html</span><br><span class="line">这个时候，第一个proxy_pass就变成了http://localhost/server/index.html</span><br><span class="line">第二个proxy_pass就变成了http://localhost/index.html效果就不一样了。</span><br></pre></td></tr></table></figure>

<h3 id="proxy-set-header"><a href="#proxy-set-header" class="headerlink" title="proxy_set_header"></a>proxy_set_header</h3><p>该指令可以更改Nginx服务器接收到的客户端请求的请求头信息，然后将新的请求头发送给代理的服务器</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_set_header field value;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_set_header Host $proxy_host;<br/>proxy_set_header Connection close;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>需要注意的是，如果想要看到结果，必须在被代理的服务器上来获取添加的头信息。</p>
<p>被代理服务器： [192.168.200.146]</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen  8080<span class="comment">;</span></span><br><span class="line">        server_name localhost<span class="comment">;</span></span><br><span class="line">        default_type text/plain<span class="comment">;</span></span><br><span class="line">        return 200 $http_username<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>代理服务器: [192.168.200.133]</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">        listen  8080<span class="comment">;</span></span><br><span class="line">        server_name localhost<span class="comment">;</span></span><br><span class="line">        location /server &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:8080/<span class="comment">;</span></span><br><span class="line">                proxy_set_header username TOM<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>访问测试</p>
<h3 id="proxy-redirect"><a href="#proxy-redirect" class="headerlink" title="proxy_redirect"></a>proxy_redirect</h3><p>该指令是用来重置头信息中的”Location”和”Refresh”的值。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_redirect redirect replacement;<br/>proxy_redirect default;<br/>proxy_redirect off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_redirect default;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>》为什么要用该指令?</p>
<p>服务端[192.168.200.146]</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen  8081<span class="comment">;</span></span><br><span class="line">    server_name localhost<span class="comment">;</span></span><br><span class="line">    if (!-f $request_filename)&#123;</span><br><span class="line">    	return 302 http://192.168.200.146<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代理服务端[192.168.200.133]</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">	listen  8081<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://192.168.200.146:8081/<span class="comment">;</span></span><br><span class="line">		proxy_redirect http://192.168.200.146 http://192.168.200.133<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>》该指令的几组选项</p>
<p>proxy_redirect redirect replacement;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redirect:目标,Location的值</span><br><span class="line">replacement:要替换的值</span><br></pre></td></tr></table></figure>

<p>proxy_redirect default;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">default;</span><br><span class="line">将location块的uri变量作为replacement,</span><br><span class="line">将proxy_pass变量作为redirect进行替换</span><br></pre></td></tr></table></figure>

<p>proxy_redirect off;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">关闭proxy_redirect的功能</span><br></pre></td></tr></table></figure>

<h2 id="Nginx反向代理实战"><a href="#Nginx反向代理实战" class="headerlink" title="Nginx反向代理实战"></a>Nginx反向代理实战</h2><p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581883378672.png" alt="1581883378672"></p>
<p>服务器1,2,3存在两种情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">第一种情况: 三台服务器的内容不一样。</span><br><span class="line">第二种情况: 三台服务器的内容是一样。</span><br></pre></td></tr></table></figure>



<ol>
<li>如果服务器1、服务器2和服务器3的内容不一样，那我们可以根据用户请求来分发到不同的服务器。</li>
</ol>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">代理服务器</span><br><span class="line">server &#123;</span><br><span class="line">        listen          8082<span class="comment">;</span></span><br><span class="line">        server_name     localhost<span class="comment">;</span></span><br><span class="line">        location /server1 &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:9001/<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        location /server2 &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:9002/<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        location /server3 &#123;</span><br><span class="line">                proxy_pass http://192.168.200.146:9003/<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">服务端</span><br><span class="line">server1</span><br><span class="line">server &#123;</span><br><span class="line">        listen          9001<span class="comment">;</span></span><br><span class="line">        server_name     localhost<span class="comment">;</span></span><br><span class="line">        default_type text/html<span class="comment">;</span></span><br><span class="line">        return 200 &#x27;&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;&#x27;</span><br><span class="line">&#125;</span><br><span class="line">server2</span><br><span class="line">server &#123;</span><br><span class="line">        listen          9002<span class="comment">;</span></span><br><span class="line">        server_name     localhost<span class="comment">;</span></span><br><span class="line">        default_type text/html<span class="comment">;</span></span><br><span class="line">        return 200 &#x27;&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;&#x27;</span><br><span class="line">&#125;</span><br><span class="line">server3</span><br><span class="line">server &#123;</span><br><span class="line">        listen          9003<span class="comment">;</span></span><br><span class="line">        server_name     localhost<span class="comment">;</span></span><br><span class="line">        default_type text/html<span class="comment">;</span></span><br><span class="line">        return 200 &#x27;&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;&#x27;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果服务器1、服务器2和服务器3的内容是一样的，该如何处理?</li>
</ol>
<h2 id="Nginx的安全控制"><a href="#Nginx的安全控制" class="headerlink" title="Nginx的安全控制"></a>Nginx的安全控制</h2><p>关于web服务器的安全是比较大的一个话题，里面所涉及的内容很多，Nginx反向代理是如何来提升web服务器的安全呢？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">安全隔离</span><br></pre></td></tr></table></figure>

<p>什么是安全隔离?</p>
<p>通过代理分开了客户端到应用程序服务器端的连接，实现了安全措施。在反向代理之前设置防火墙，仅留一个入口供代理服务器访问。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1589908851340.png" alt="1589908851340"></p>
<h3 id="如何使用SSL对流量进行加密"><a href="#如何使用SSL对流量进行加密" class="headerlink" title="如何使用SSL对流量进行加密"></a>如何使用SSL对流量进行加密</h3><p>翻译成大家能熟悉的说法就是将我们常用的http请求转变成https请求，那么这两个之间的区别简单的来说两个都是HTTP协议，只不过https是身披SSL外壳的http.</p>
<p>HTTPS是一种通过计算机网络进行安全通信的传输协议。它经由HTTP进行通信，利用SSL&#x2F;TLS建立全通信，加密数据包，确保数据的安全性。</p>
<p>SSL(Secure Sockets Layer)安全套接层</p>
<p>TLS(Transport Layer Security)传输层安全</p>
<p>上述这两个是为网络通信提供安全及数据完整性的一种安全协议，TLS和SSL在传输层和应用层对网络连接进行加密。</p>
<p>总结来说为什么要使用https:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http协议是明文传输数据，存在安全问题，而https是加密传输，相当于http+ssl，并且可以防止流量劫持。</span><br></pre></td></tr></table></figure>

<p>Nginx要想使用SSL，需要满足一个条件即需要添加一个模块<code>--with-http_ssl_module</code>,而该模块在编译的过程中又需要OpenSSL的支持，这个我们之前已经准备好了。</p>
<h4 id="nginx添加SSL的支持"><a href="#nginx添加SSL的支持" class="headerlink" title="nginx添加SSL的支持"></a>nginx添加SSL的支持</h4><p>（1）完成 <code>--with-http_ssl_module</code>模块的增量添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">》将原有/usr/local/nginx/sbin/nginx进行备份</span><br><span class="line">》拷贝nginx之前的配置信息</span><br><span class="line">》在nginx的安装源码进行配置指定对应模块  ./configure --with-http_ssl_module</span><br><span class="line">》通过make模板进行编译</span><br><span class="line">》将objs下面的nginx移动到/usr/local/nginx/sbin下</span><br><span class="line">》在源码目录下执行  make upgrade进行升级，这个可以实现不停机添加新模块的功能</span><br></pre></td></tr></table></figure>

<h4 id="Nginx的SSL相关指令"><a href="#Nginx的SSL相关指令" class="headerlink" title="Nginx的SSL相关指令"></a>Nginx的SSL相关指令</h4><p>因为刚才我们介绍过该模块的指令都是通过ngx_http_ssl_module模块来解析的。</p>
<p>》ssl:该指令用来在指定的服务器开启HTTPS,可以使用 listen 443 ssl,后面这种方式更通用些。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl on | off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen 443 ssl<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>》ssl_certificate:为当前这个虚拟主机指定一个带有PEM格式证书的证书。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_certificate file;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>》ssl_certificate_key:该指令用来指定PEM secret key文件的路径</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_ceritificate_key file;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>》ssl_session_cache:该指令用来配置用于SSL会话的缓存</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_sesion_cache off|none|[builtin[:size]] [shared:name:size]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_session_cache none;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>off:禁用会话缓存，客户端不得重复使用会话</p>
<p>none:禁止使用会话缓存，客户端可以重复使用，但是并没有在缓存中存储会话参数</p>
<p>builtin:内置OpenSSL缓存，仅在一个工作进程中使用。</p>
<p>shared:所有工作进程之间共享缓存，缓存的相关信息用name和size来指定</p>
<p>》ssl_session_timeout：开启SSL会话功能后，设置客户端能够反复使用储存在缓存中的会话参数时间。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_session_timeout time;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_session_timeout 5m;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>》ssl_ciphers:指出允许的密码，密码指定为OpenSSL支持的格式</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_ciphers ciphers;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_ciphers HIGH:!aNULL:!MD5;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<p>可以使用<code>openssl ciphers</code>查看openssl支持的格式。</p>
<p>》ssl_prefer_server_ciphers：该指令指定是否服务器密码优先客户端密码</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ssl_perfer_server_ciphers on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>ssl_perfer_server_ciphers off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server</td>
</tr>
</tbody></table>
<h4 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h4><p>方式一：使用阿里云&#x2F;腾讯云等第三方服务进行购买。</p>
<p>方式二:使用openssl生成证书</p>
<p>先要确认当前系统是否有安装openssl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl version</span><br></pre></td></tr></table></figure>

<p>安装下面的命令进行生成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mkdir /root/cert</span><br><span class="line">cd /root/cert</span><br><span class="line">openssl genrsa -des3 -out server.key 1024</span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line">cp server.key server.key.org</span><br><span class="line">openssl rsa -in server.key.org -out server.key</span><br><span class="line">openssl x509 -req -days 365 -in server.csr -signkey server.key -out server.crt</span><br></pre></td></tr></table></figure>

<h4 id="开启SSL实例"><a href="#开启SSL实例" class="headerlink" title="开启SSL实例"></a>开启SSL实例</h4><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       443 ssl<span class="comment">;</span></span><br><span class="line">    server_name  localhost<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    ssl_certificate      server.cert<span class="comment">;</span></span><br><span class="line">    ssl_certificate_key  server.key<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    ssl_session_cache    shared:SSL:1m<span class="comment">;</span></span><br><span class="line">    ssl_session_timeout  5m<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5<span class="comment">;</span></span><br><span class="line">    ssl_prefer_server_ciphers  on<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   html<span class="comment">;</span></span><br><span class="line">        index  index.html index.htm<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（4）验证</p>
<h2 id="反向代理系统调优"><a href="#反向代理系统调优" class="headerlink" title="反向代理系统调优"></a>反向代理系统调优</h2><p>反向代理值Buffer和Cache</p>
<p>Buffer翻译过来是”缓冲”，Cache翻译过来是”缓存”。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1581879638569.png" alt="1581879638569"></p>
<p>总结下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">相同点:</span><br><span class="line">两种方式都是用来提供IO吞吐效率，都是用来提升Nginx代理的性能。</span><br><span class="line">不同点:</span><br><span class="line">缓冲主要用来解决不同设备之间数据传递速度不一致导致的性能低的问题，缓冲中的数据一旦此次操作完成后，就可以删除。</span><br><span class="line">缓存主要是备份，将被代理服务器的数据缓存一份到代理服务器，这样的话，客户端再次获取相同数据的时候，就只需要从代理服务器上获取，效率较高，缓存中的数据可以重复使用，只有满足特定条件才会删除.</span><br></pre></td></tr></table></figure>

<p>（1）Proxy Buffer相关指令</p>
<p>》proxy_buffering :该指令用来开启或者关闭代理服务器的缓冲区；</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffering on|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffering on;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>》proxy_buffers:该指令用来指定单个连接从代理服务器读取响应的缓存区的个数和大小。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffers number size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffers 8 4k | 8K;(与系统平台有关)</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>number:缓冲区的个数</p>
<p>size:每个缓冲区的大小，缓冲区的总大小就是number*size</p>
<p>》proxy_buffer_size:该指令用来设置从被代理服务器获取的第一部分响应数据的大小。保持与proxy_buffers中的size一致即可，当然也可以更小。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_buffer_size size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_buffer_size 4k | 8k;(与系统平台有关)</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>》proxy_busy_buffers_size：该指令用来限制同时处于BUSY状态的缓冲总大小。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_busy_buffers_size size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_busy_buffers_size 8k|16K;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>》proxy_temp_path:当缓冲区存满后，仍未被Nginx服务器完全接受，响应数据就会被临时存放在磁盘文件上，该指令设置文件路径</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_temp_path  path;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_temp_path proxy_temp;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>注意path最多设置三层。  </p>
<p>》proxy_temp_file_write_size：该指令用来设置磁盘上缓冲文件的大小。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_temp_file_write_size size;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_temp_file_write_size 8K|16K;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>通用网站的配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">proxy_buffering on<span class="comment">;</span></span><br><span class="line">proxy_buffer_size 4 32k<span class="comment">;</span></span><br><span class="line">proxy_busy_buffers_size 64k<span class="comment">;</span></span><br><span class="line">proxy_temp_file_write_size 64k<span class="comment">;</span></span><br></pre></td></tr></table></figure>

<p>根据项目的具体内容进行相应的调节。</p>
<h1 id="Nginx负载均衡"><a href="#Nginx负载均衡" class="headerlink" title="Nginx负载均衡"></a>Nginx负载均衡</h1><h2 id="负载均衡概述"><a href="#负载均衡概述" class="headerlink" title="负载均衡概述"></a>负载均衡概述</h2><p>早期的网站流量和业务功能都比较简单，单台服务器足以满足基本的需求，但是随着互联网的发展，业务流量越来越大并且业务逻辑也跟着越来越复杂，单台服务器的性能及单点故障问题就凸显出来了，因此需要多台服务器进行性能的水平扩展及避免单点故障出现。那么如何将不同用户的请求流量分发到不同的服务器上呢？</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591631182469.png" alt="1591631182469"></p>
<h2 id="负载均衡的原理及处理流程"><a href="#负载均衡的原理及处理流程" class="headerlink" title="负载均衡的原理及处理流程"></a>负载均衡的原理及处理流程</h2><p>系统的扩展可以分为纵向扩展和横向扩展。</p>
<p>纵向扩展是从单机的角度出发，通过增加系统的硬件处理能力来提升服务器的处理能力</p>
<p>横向扩展是通过添加机器来满足大型网站服务的处理能力。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1584602513812.png" alt="1584602513812"></p>
<p>这里面涉及到两个重要的角色分别是”应用集群”和”负载均衡器”。</p>
<p>应用集群：将同一应用部署到多台机器上，组成处理集群，接收负载均衡设备分发的请求，进行处理并返回响应的数据。</p>
<p>负载均衡器:将用户访问的请求根据对应的负载均衡算法，分发到集群中的一台服务器进行处理。</p>
<h3 id="负载均衡的作用"><a href="#负载均衡的作用" class="headerlink" title="负载均衡的作用"></a>负载均衡的作用</h3><p>1、解决服务器的高并发压力，提高应用程序的处理性能。</p>
<p>2、提供故障转移，实现高可用。</p>
<p>3、通过添加或减少服务器数量，增强网站的可扩展性。</p>
<p>4、在负载均衡器上进行过滤，可以提高系统的安全性。</p>
<h2 id="负载均衡常用的处理方式"><a href="#负载均衡常用的处理方式" class="headerlink" title="负载均衡常用的处理方式"></a>负载均衡常用的处理方式</h2><h3 id="方式一-用户手动选择"><a href="#方式一-用户手动选择" class="headerlink" title="方式一:用户手动选择"></a>方式一:用户手动选择</h3><p>这种方式比较原始，只要实现的方式就是在网站主页上面提供不同线路、不同服务器链接方式，让用户来选择自己访问的具体服务器，来实现负载均衡。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1584602887881.png" alt="1584602887881"></p>
<h3 id="方式二-DNS轮询方式"><a href="#方式二-DNS轮询方式" class="headerlink" title="方式二:DNS轮询方式"></a>方式二:DNS轮询方式</h3><p>DNS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">域名系统（服务）协议（DNS）是一种分布式网络目录服务，主要用于域名与 IP 地址的相互转换。</span><br></pre></td></tr></table></figure>

<p>大多域名注册商都支持对同一个主机名添加多条A记录，这就是DNS轮询，DNS服务器将解析请求按照A记录的顺序，随机分配到不同的IP上，这样就能完成简单的负载均衡。DNS轮询的成本非常低，在一些不重要的服务器，被经常使用。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591010973996.png" alt="1591010973996"></p>
<p>如下是我们为某一个域名添加的IP地址，用2台服务器来做负载均衡。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1590064506355.png" alt="1590064506355"></p>
<p>验证:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ping www.nginx521.cn</span><br></pre></td></tr></table></figure>

<p>清空本地的dns缓存</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipconfig/flushdns</span><br></pre></td></tr></table></figure>

<p>我们发现使用DNS来实现轮询，不需要投入过多的成本，虽然DNS轮询成本低廉，但是DNS负载均衡存在明显的缺点。</p>
<p>1.可靠性低</p>
<p>假设一个域名DNS轮询多台服务器，如果其中的一台服务器发生故障，那么所有的访问该服务器的请求将不会有所回应，即使你将该服务器的IP从DNS中去掉，但是由于各大宽带接入商将众多的DNS存放在缓存中，以节省访问时间，导致DNS不会实时更新。所以DNS轮流上一定程度上解决了负载均衡问题，但是却存在可靠性不高的缺点。</p>
<p>2.负载均衡不均衡</p>
<p>DNS负载均衡采用的是简单的轮询负载算法，不能区分服务器的差异，不能反映服务器的当前运行状态，不能做到为性能好的服务器多分配请求，另外本地计算机也会缓存已经解析的域名到IP地址的映射，这也会导致使用该DNS服务器的用户在一定时间内访问的是同一台Web服务器，从而引发Web服务器减的负载不均衡。</p>
<p>负载不均衡则会导致某几台服务器负荷很低，而另外几台服务器负荷确很高，处理请求的速度慢，配置高的服务器分配到的请求少，而配置低的服务器分配到的请求多。</p>
<h3 id="方式三-四-x2F-七层负载均衡"><a href="#方式三-四-x2F-七层负载均衡" class="headerlink" title="方式三:四&#x2F;七层负载均衡"></a>方式三:四&#x2F;七层负载均衡</h3><p>介绍四&#x2F;七层负载均衡之前，我们先了解一个概念，OSI(open system interconnection),叫开放式系统互联模型，这个是由国际标准化组织ISO指定的一个不基于具体机型、操作系统或公司的网络体系结构。该模型将网络通信的工作分为七层。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1584693830966.png" alt="1584693830966"></p>
<p>应用层：为应用程序提供网络服务。</p>
<p>表示层：对数据进行格式化、编码、加密、压缩等操作。</p>
<p>会话层：建立、维护、管理会话连接。</p>
<p>传输层：建立、维护、管理端到端的连接，常见的有TCP&#x2F;UDP。</p>
<p>网络层：IP寻址和路由选择</p>
<p>数据链路层：控制网络层与物理层之间的通信。</p>
<p>物理层：比特流传输。</p>
<p>所谓四层负载均衡指的是OSI七层模型中的传输层，主要是基于IP+PORT的负载均衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实现四层负载均衡的方式：</span><br><span class="line">硬件：F5 BIG-IP、Radware等</span><br><span class="line">软件：LVS、Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>

<p>所谓的七层负载均衡指的是在应用层，主要是基于虚拟的URL或主机IP的负载均衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实现七层负载均衡的方式：</span><br><span class="line">软件：Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>

<p>四层和七层负载均衡的区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">四层负载均衡数据包是在底层就进行了分发，而七层负载均衡数据包则在最顶端进行分发，所以四层负载均衡的效率比七层负载均衡的要高。</span><br><span class="line">四层负载均衡不识别域名，而七层负载均衡识别域名。</span><br></pre></td></tr></table></figure>

<p>处理四层和七层负载以为其实还有二层、三层负载均衡，二层是在数据链路层基于mac地址来实现负载均衡，三层是在网络层一般采用虚拟IP地址的方式实现负载均衡。</p>
<p>实际环境采用的模式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">四层负载(LVS)+七层负载(Nginx)</span><br></pre></td></tr></table></figure>

<h2 id="Nginx七层负载均衡"><a href="#Nginx七层负载均衡" class="headerlink" title="Nginx七层负载均衡"></a>Nginx七层负载均衡</h2><p>Nginx要实现七层负载均衡需要用到proxy_pass代理模块配置。Nginx默认安装支持这个模块，我们不需要再做任何处理。Nginx的负载均衡是在Nginx的反向代理基础上把用户的请求根据指定的算法分发到一组【upstream虚拟服务池】。</p>
<h3 id="Nginx七层负载均衡的指令"><a href="#Nginx七层负载均衡的指令" class="headerlink" title="Nginx七层负载均衡的指令"></a>Nginx七层负载均衡的指令</h3><h4 id="upstream指令"><a href="#upstream指令" class="headerlink" title="upstream指令"></a>upstream指令</h4><p>该指令是用来定义一组服务器，它们可以是监听不同端口的服务器，并且也可以是同时监听TCP和Unix socket的服务器。服务器可以指定不同的权重，默认为1。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>upstream name {…}</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<h4 id="server指令"><a href="#server指令" class="headerlink" title="server指令"></a>server指令</h4><p>该指令用来指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者unix socket</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>server name [paramerters]</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>upstream</td>
</tr>
</tbody></table>
<h3 id="Nginx七层负载均衡的实现流程"><a href="#Nginx七层负载均衡的实现流程" class="headerlink" title="Nginx七层负载均衡的实现流程"></a>Nginx七层负载均衡的实现流程</h3><p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1590248160635.png" alt="1590248160635"></p>
<p>服务端设置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen   9001<span class="comment">;</span></span><br><span class="line">    server_name localhost<span class="comment">;</span></span><br><span class="line">    default_type text/html<span class="comment">;</span></span><br><span class="line">    location /&#123;</span><br><span class="line">    	return 200 &#x27;&lt;h1&gt;192.168.200.146:9001&lt;/h1&gt;&#x27;<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen   9002<span class="comment">;</span></span><br><span class="line">    server_name localhost<span class="comment">;</span></span><br><span class="line">    default_type text/html<span class="comment">;</span></span><br><span class="line">    location /&#123;</span><br><span class="line">    	return 200 &#x27;&lt;h1&gt;192.168.200.146:9002&lt;/h1&gt;&#x27;<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">    listen   9003<span class="comment">;</span></span><br><span class="line">    server_name localhost<span class="comment">;</span></span><br><span class="line">    default_type text/html<span class="comment">;</span></span><br><span class="line">    location /&#123;</span><br><span class="line">    	return 200 &#x27;&lt;h1&gt;192.168.200.146:9003&lt;/h1&gt;&#x27;<span class="comment">;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>负载均衡器设置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9091<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9092<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9093<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="负载均衡状态"><a href="#负载均衡状态" class="headerlink" title="负载均衡状态"></a>负载均衡状态</h3><p>代理服务器在负责均衡调度中的状态有以下几个：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody><tr>
<td>down</td>
<td>当前的server暂时不参与负载均衡</td>
</tr>
<tr>
<td>backup</td>
<td>预留的备份服务器</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求失败的次数</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>经过max_fails失败后, 服务暂停时间</td>
</tr>
<tr>
<td>max_conns</td>
<td>限制最大的接收连接数</td>
</tr>
</tbody></table>
<h4 id="down"><a href="#down" class="headerlink" title="down"></a>down</h4><p>down:将该服务器标记为永久不可用，那么该代理服务器将不参与负载均衡。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 down<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002</span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该状态一般会对需要停机维护的服务器进行设置。</p>
<h4 id="backup"><a href="#backup" class="headerlink" title="backup"></a>backup</h4><p>backup:将该服务器标记为备份服务器，当主服务器不可用时，将用来传递请求。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 down<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002 backup<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时需要将9094端口的访问禁止掉来模拟下唯一能对外提供访问的服务宕机以后，backup的备份服务器就要开始对外提供服务，此时为了测试验证，我们需要使用防火墙来进行拦截。</p>
<p>介绍一个工具<code>firewall-cmd</code>,该工具是Linux提供的专门用来操作firewall的。</p>
<p>查询防火墙中指定的端口是否开放</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --query-port=9001/tcp</span><br></pre></td></tr></table></figure>

<p>如何开放一个指定的端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=9002/tcp</span><br></pre></td></tr></table></figure>

<p>批量添加开发端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --add-port=9001-9003/tcp</span><br></pre></td></tr></table></figure>

<p>如何移除一个指定的端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --permanent --remove-port=9003/tcp</span><br></pre></td></tr></table></figure>

<p>重新加载</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure>

<p>其中</p>
<p>​	 –permanent表示设置为持久</p>
<p>​	 –add-port表示添加指定端口</p>
<p>​	 –remove-port表示移除指定端口</p>
<h4 id="max-conns"><a href="#max-conns" class="headerlink" title="max_conns"></a>max_conns</h4><p>max_conns&#x3D;number:用来设置代理服务器同时活动链接的最大数量，默认为0，表示不限制，使用该配置可以根据后端服务器处理请求的并发量来进行设置，防止后端服务器被压垮。</p>
<h4 id="max-fails和fail-timeout"><a href="#max-fails和fail-timeout" class="headerlink" title="max_fails和fail_timeout"></a>max_fails和fail_timeout</h4><p>max_fails&#x3D;number:设置允许请求代理服务器失败的次数，默认为1。</p>
<p>fail_timeout&#x3D;time:设置经过max_fails失败后，服务暂停的时间，默认是10秒。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.133:9001 down<span class="comment">;</span></span><br><span class="line">	server 192.168.200.133:9002 backup<span class="comment">;</span></span><br><span class="line">	server 192.168.200.133:9003 <span class="attr">max_fails</span>=<span class="number">3</span> fail_timeout=<span class="number">15</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h2><p>介绍完Nginx负载均衡的相关指令后，我们已经能实现将用户的请求分发到不同的服务器上，那么除了采用默认的分配方式以外，我们还能采用什么样的负载算法?</p>
<p>Nginx的upstream支持如下六种方式的分配算法，分别是:</p>
<table>
<thead>
<tr>
<th>算法名称</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>轮询</td>
<td>默认方式</td>
</tr>
<tr>
<td>weight</td>
<td>权重方式</td>
</tr>
<tr>
<td>ip_hash</td>
<td>依据ip分配方式</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据URL分配方式</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式</td>
</tr>
</tbody></table>
<h3 id="轮询"><a href="#轮询" class="headerlink" title="轮询"></a>轮询</h3><p>是upstream模块负载均衡默认的策略。每个请求会按时间顺序逐个分配到不同的后端服务器。轮询不需要额外的配置。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 <span class="attr">weight</span>=<span class="number">1</span><span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="weight加权-加权轮询"><a href="#weight加权-加权轮询" class="headerlink" title="weight加权[加权轮询]"></a>weight加权[加权轮询]</h3><p>weight&#x3D;number:用来设置服务器的权重，默认为1，权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的，所有此策略比较适合服务器的硬件配置差别比较大的情况。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 <span class="attr">weight</span>=<span class="number">10</span><span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002 <span class="attr">weight</span>=<span class="number">5</span><span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003 <span class="attr">weight</span>=<span class="number">3</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h3><p>当对后端的多台动态应用服务器做负载均衡时，ip_hash指令能够将某个客户端IP的请求通过哈希算法定位到同一台后端服务器上。这样，当来自某一个IP的用户在后端Web服务器A上登录后，在访问该站点的其他URL，能保证其访问的还是后端web服务器A。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>ip_hash;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>upstream</td>
</tr>
</tbody></table>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	ip_hash<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要额外多说一点的是使用ip_hash指令无法保证后端服务器的负载均衡，可能导致有些后端服务器接收到的请求多，有些后端服务器接收的请求少，而且设置后端服务器权重等方法将不起作用。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591706748677.png" alt="1591706748677"></p>
<h3 id="least-conn"><a href="#least-conn" class="headerlink" title="least_conn"></a>least_conn</h3><p>最少连接，把请求转发给连接数较少的后端服务器。轮询算法是把请求平均的转发给各个后端，使它们的负载大致相同；但是，有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn这种方式就可以达到更好的负载均衡效果。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	least_conn<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此负载均衡策略适合请求处理时间长短不一造成服务器过载的情况。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591809623736.png" alt="1591809623736"></p>
<h3 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h3><p>按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，要配合缓存命中来使用。同一个资源多次请求，可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费。而使用url_hash，可以使得同一个url（也就是同一个资源请求）会到达同一台服务器，一旦缓存住了资源，再此收到请求，就可以从缓存中读取。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	hash &amp;request_uri<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问如下地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.133:8083/a</span><br><span class="line">http://192.168.200.133:8083/b</span><br><span class="line">http://192.168.200.133:8083/c</span><br></pre></td></tr></table></figure>



<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591812222306.png" alt="1591812222306"></p>
<h3 id="fair"><a href="#fair" class="headerlink" title="fair"></a>fair</h3><p>fair采用的不是内建负载均衡使用的轮换的均衡算法，而是可以根据页面大小、加载时间长短智能的进行负载均衡。那么如何使用第三方模块的fair负载均衡策略。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	fair<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是如何直接使用会报错，因为fair属于第三方模块实现的负载均衡。需要添加<code>nginx-upstream-fair</code>,如何添加对应的模块:</p>
<ol>
<li>下载nginx-upstream-fair模块</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下载地址为:</span><br><span class="line">	https://github.com/gnosek/nginx-upstream-fair</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>将下载的文件上传到服务器并进行解压缩</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unzip nginx-upstream-fair-master.zip</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>重命名资源</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv nginx-upstream-fair-master fair</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>使用.&#x2F;configure命令将资源添加到Nginx模块中</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --add-module=/root/fair</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>编译</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<p>编译可能会出现如下错误，ngx_http_upstream_srv_conf_t结构中缺少default_port</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1584941470457.png" alt="1584941470457"></p>
<p>解决方案:</p>
<p>在Nginx的源码中 src&#x2F;http&#x2F;ngx_http_upstream.h,找到<code>ngx_http_upstream_srv_conf_s</code>，在模块中添加添加default_port属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">in_port_t	   default_port</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1584943399597.png" alt="1584943399597"></p>
<p>然后再进行make.</p>
<ol start="6">
<li>更新Nginx</li>
</ol>
<p>​	 6.1 将sbin目录下的nginx进行备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginxold</span><br></pre></td></tr></table></figure>

<p>​	6.2 将安装目录下的objs中的nginx拷贝到sbin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd objs</span><br><span class="line">cp nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>

<p>​	 6.3 更新Nginx</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ../</span><br><span class="line">make upgrade</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>编译测试使用Nginx</li>
</ol>
<p>上面介绍了Nginx常用的负载均衡的策略，有人说是5种，是把轮询和加权轮询归为一种，也有人说是6种。那么在咱们以后的开发中到底使用哪种，这个需要根据实际项目的应用场景来决定的。</p>
<h2 id="负载均衡案例"><a href="#负载均衡案例" class="headerlink" title="负载均衡案例"></a>负载均衡案例</h2><h3 id="案例一：对所有请求实现一般轮询规则的负载均衡"><a href="#案例一：对所有请求实现一般轮询规则的负载均衡" class="headerlink" title="案例一：对所有请求实现一般轮询规则的负载均衡"></a>案例一：对所有请求实现一般轮询规则的负载均衡</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例二：对所有请求实现加权轮询规则的负载均衡"><a href="#案例二：对所有请求实现加权轮询规则的负载均衡" class="headerlink" title="案例二：对所有请求实现加权轮询规则的负载均衡"></a>案例二：对所有请求实现加权轮询规则的负载均衡</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001 <span class="attr">weight</span>=<span class="number">7</span><span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002 <span class="attr">weight</span>=<span class="number">5</span><span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003 <span class="attr">weight</span>=<span class="number">3</span><span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8083<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例三：对特定资源实现负载均衡"><a href="#案例三：对特定资源实现负载均衡" class="headerlink" title="案例三：对特定资源实现负载均衡"></a>案例三：对特定资源实现负载均衡</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">upstream videobackend&#123;</span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">upstream filebackend&#123;</span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9004<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen 8084<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /video/ &#123;</span><br><span class="line">		proxy_pass http://videobackend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	location /file/ &#123;</span><br><span class="line">		proxy_pass http://filebackend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例四：对不同域名实现负载均衡"><a href="#案例四：对不同域名实现负载均衡" class="headerlink" title="案例四：对不同域名实现负载均衡"></a>案例四：对不同域名实现负载均衡</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">upstream itcastbackend&#123;</span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">upstream itheimabackend&#123;</span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9004<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen	8085<span class="comment">;</span></span><br><span class="line">	server_name www.itcast.cn<span class="comment">;</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://itcastbackend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen	8086<span class="comment">;</span></span><br><span class="line">	server_name www.itheima.cn<span class="comment">;</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://itheimabackend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="案例五：实现带有URL重写的负载均衡"><a href="#案例五：实现带有URL重写的负载均衡" class="headerlink" title="案例五：实现带有URL重写的负载均衡"></a>案例五：实现带有URL重写的负载均衡</h3><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">upstream backend&#123;</span><br><span class="line">	server 192.168.200.146:9001<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9002<span class="comment">;</span></span><br><span class="line">	server 192.168.200.146:9003<span class="comment">;</span></span><br><span class="line">&#125;</span><br><span class="line">server &#123;</span><br><span class="line">	listen	80<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /file/ &#123;</span><br><span class="line">		rewrite ^(/file/.*) /server/$1 last<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://backend<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx四层负载均衡"><a href="#Nginx四层负载均衡" class="headerlink" title="Nginx四层负载均衡"></a>Nginx四层负载均衡</h2><p>Nginx在1.9之后，增加了一个stream模块，用来实现四层协议的转发、代理、负载均衡等。stream模块的用法跟http的用法类似，允许我们配置一组TCP或者UDP等协议的监听，然后通过proxy_pass来转发我们的请求，通过upstream添加多个后端服务，实现负载均衡。</p>
<p>四层协议负载均衡的实现，一般都会用到LVS、HAProxy、F5等，要么很贵要么配置很麻烦，而Nginx的配置相对来说更简单，更能快速完成工作。</p>
<h3 id="添加stream模块的支持"><a href="#添加stream模块的支持" class="headerlink" title="添加stream模块的支持"></a>添加stream模块的支持</h3><p>Nginx默认是没有编译这个模块的，需要使用到stream模块，那么需要在编译的时候加上<code>--with-stream</code>。</p>
<p>完成添加<code>--with-stream</code>的实现步骤:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">》将原有/usr/local/nginx/sbin/nginx进行备份</span><br><span class="line">》拷贝nginx之前的配置信息</span><br><span class="line">》在nginx的安装源码进行配置指定对应模块  ./configure --with-stream</span><br><span class="line">》通过make模板进行编译</span><br><span class="line">》将objs下面的nginx移动到/usr/local/nginx/sbin下</span><br><span class="line">》在源码目录下执行  make upgrade进行升级，这个可以实现不停机添加新模块的功能</span><br></pre></td></tr></table></figure>

<h3 id="Nginx四层负载均衡的指令"><a href="#Nginx四层负载均衡的指令" class="headerlink" title="Nginx四层负载均衡的指令"></a>Nginx四层负载均衡的指令</h3><h4 id="stream指令"><a href="#stream指令" class="headerlink" title="stream指令"></a>stream指令</h4><p>该指令提供在其中指定流服务器指令的配置文件上下文。和http指令同级。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>stream { … }</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>main</td>
</tr>
</tbody></table>
<h4 id="upstream指令-1"><a href="#upstream指令-1" class="headerlink" title="upstream指令"></a>upstream指令</h4><p>该指令和http的upstream指令是类似的。</p>
<h3 id="四层负载均衡的案例"><a href="#四层负载均衡的案例" class="headerlink" title="四层负载均衡的案例"></a>四层负载均衡的案例</h3><h4 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h4><p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591897178807.png" alt="1591897178807"></p>
<p>实现步骤</p>
<p>(1)准备Redis服务器,在一条服务器上准备三个Redis，端口分别是6379,6378</p>
<p>1.上传redis的安装包，<code>redis-4.0.14.tar.gz</code></p>
<p>2.将安装包进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf redis-4.0.14.tar.gz</span><br></pre></td></tr></table></figure>

<p>3.进入redis的安装包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd redis-4.0.14</span><br></pre></td></tr></table></figure>

<p>4.使用make和install进行编译和安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make PREFIX=/usr/local/redis/redis01 install</span><br></pre></td></tr></table></figure>

<p>5.拷贝redis配置文件<code>redis.conf</code>到&#x2F;usr&#x2F;local&#x2F;redis&#x2F;redis01&#x2F;bin目录中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp redis.conf	/usr/local/redis/redis01/bin</span><br></pre></td></tr></table></figure>

<p>6.修改redis.conf配置文件</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port  6379      <span class="comment">#redis的端口</span></span><br><span class="line">daemonize yes   <span class="comment">#后台启动redis</span></span><br></pre></td></tr></table></figure>

<p>7.将redis01复制一份为redis02</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/redis</span><br><span class="line">cp -r redis01 redis02</span><br></pre></td></tr></table></figure>

<p>8.将redis02文件文件夹中的redis.conf进行修改</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">port  6378      <span class="comment">#redis的端口</span></span><br><span class="line">daemonize yes   <span class="comment">#后台启动redis</span></span><br></pre></td></tr></table></figure>

<p>9.分别启动，即可获取两个Redis.并查看</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps -ef | grep redis</span><br></pre></td></tr></table></figure>

<p>使用Nginx将请求分发到不同的Redis服务器上。</p>
<p>(2)准备Tomcat服务器.</p>
<p>1.上传tomcat的安装包，<code>apache-tomcat-8.5.56.tar.gz</code></p>
<p>2.将安装包进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf apache-tomcat-8.5.56.tar.gz</span><br></pre></td></tr></table></figure>

<p>3.进入tomcat的bin目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd apache-tomcat-8.5.56/bin</span><br><span class="line">./startup</span><br></pre></td></tr></table></figure>

<p>nginx.conf配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">stream &#123;</span><br><span class="line">        upstream redisbackend &#123;</span><br><span class="line">                server 192.168.200.146:6379<span class="comment">;</span></span><br><span class="line">                server 192.168.200.146:6378<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        upstream tomcatbackend &#123;</span><br><span class="line">        		server 192.168.200.146:8080<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">                listen  81<span class="comment">;</span></span><br><span class="line">                proxy_pass redisbackend<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">        server &#123;</span><br><span class="line">        		listen	82<span class="comment">;</span></span><br><span class="line">        		proxy_pass tomcatbackend<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>访问测试。</p>
<h1 id="Nginx缓存集成"><a href="#Nginx缓存集成" class="headerlink" title="Nginx缓存集成"></a>Nginx缓存集成</h1><h2 id="缓存的概念"><a href="#缓存的概念" class="headerlink" title="缓存的概念"></a>缓存的概念</h2><p>缓存就是数据交换的缓冲区(称作:Cache),当用户要获取数据的时候，会先从缓存中去查询获取数据，如果缓存中有就会直接返回给用户，如果缓存中没有，则会发请求从服务器重新查询数据，将数据返回给用户的同时将数据放入缓存，下次用户就会直接从缓存中获取数据。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591944051969.png" alt="1591944051969"></p>
<p>缓存其实在很多场景中都有用到，比如：</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>操作系统磁盘缓存</td>
<td>减少磁盘机械操作</td>
</tr>
<tr>
<td>数据库缓存</td>
<td>减少文件系统的IO操作</td>
</tr>
<tr>
<td>应用程序缓存</td>
<td>减少对数据库的查询</td>
</tr>
<tr>
<td>Web服务器缓存</td>
<td>减少对应用服务器请求次数</td>
</tr>
<tr>
<td>浏览器缓存</td>
<td>减少与后台的交互次数</td>
</tr>
</tbody></table>
<p>缓存的优点</p>
<p>​	1.减少数据传输，节省网络流量，加快响应速度，提升用户体验；</p>
<p>​	2.减轻服务器压力；</p>
<p>​	3.提供服务端的高可用性；</p>
<p>缓存的缺点</p>
<p>​	1.数据的不一致</p>
<p>​	2.增加成本</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1582295367198.png" alt="1582295367198"></p>
<p>本次课程注解讲解的是Nginx,Nginx作为web服务器，Nginx作为Web缓存服务器，它介于客户端和应用服务器之间，当用户通过浏览器访问一个URL时，web缓存服务器会去应用服务器获取要展示给用户的内容，将内容缓存到自己的服务器上，当下一次请求到来时，如果访问的是同一个URL，web缓存服务器就会直接将之前缓存的内容返回给客户端，而不是向应用服务器再次发送请求。web缓存降低了应用服务器、数据库的负载，减少了网络延迟，提高了用户访问的响应速度，增强了用户的体验。</p>
<h2 id="Nginx的web缓存服务"><a href="#Nginx的web缓存服务" class="headerlink" title="Nginx的web缓存服务"></a>Nginx的web缓存服务</h2><p>Nginx是从0.7.48版开始提供缓存功能。Nginx是基于Proxy Store来实现的，其原理是把URL及相关组合当做Key,在使用MD5算法对Key进行哈希，得到硬盘上对应的哈希目录路径，从而将缓存内容保存在该目录中。它可以支持任意URL连接，同时也支持404&#x2F;301&#x2F;302这样的非200状态码。Nginx即可以支持对指定URL或者状态码设置过期时间，也可以使用purge命令来手动清除指定URL的缓存。</p>
<p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591947990200.png" alt="1591947990200"></p>
<h2 id="Nginx缓存设置的相关指令"><a href="#Nginx缓存设置的相关指令" class="headerlink" title="Nginx缓存设置的相关指令"></a>Nginx缓存设置的相关指令</h2><p>Nginx的web缓存服务主要是使用<code>ngx_http_proxy_module</code>模块相关指令集来完成，接下来我们把常用的指令来进行介绍下。</p>
<h3 id="proxy-cache-path"><a href="#proxy-cache-path" class="headerlink" title="proxy_cache_path"></a>proxy_cache_path</h3><p>该指定用于设置缓存文件的存放路径</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_path path [levels&#x3D;number] <br/>keys_zone&#x3D;zone_name:zone_size [inactive&#x3D;time][max_size&#x3D;size];</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody></table>
<p>path:缓存路径地址,如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/proxy_cache</span><br></pre></td></tr></table></figure>

<p>levels: 指定该缓存空间对应的目录，最多可以设置3层，每层取值为1|2如 :</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">levels</span>=<span class="number">1</span>:<span class="number">2</span>   缓存空间有两层目录，第一次是<span class="number">1</span>个字母，第二次是<span class="number">2</span>个字母</span><br><span class="line">举例说明:</span><br><span class="line">itheima<span class="section">[key]</span>通过MD5加密以后的值为 43c8233266edce38c2c9af0694e2107d</span><br><span class="line"><span class="attr">levels</span>=<span class="number">1</span>:<span class="number">2</span>   最终的存储路径为/usr/local/proxy_cache/d/<span class="number">07</span></span><br><span class="line"><span class="attr">levels</span>=<span class="number">2</span>:<span class="number">1</span>:<span class="number">2</span> 最终的存储路径为/usr/local/proxy_cache/<span class="number">7</span>d/<span class="number">0</span>/<span class="number">21</span></span><br><span class="line"><span class="attr">levels</span>=<span class="number">2</span>:<span class="number">2</span>:<span class="number">2</span> 最终的存储路径为??/usr/local/proxy_cache/<span class="number">7</span>d/<span class="number">10</span>/e2</span><br></pre></td></tr></table></figure>

<p>keys_zone:用来为这个缓存区设置名称和指定大小，如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">keys_zone</span>=itcast:<span class="number">200</span>m  缓存区的名称是itcast,大小为<span class="number">200</span>M,<span class="number">1</span>M大概能存储<span class="number">8000</span>个keys</span><br></pre></td></tr></table></figure>

<p>inactive:指定缓存的数据多次时间未被访问就将被删除，如：</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">inactive</span>=<span class="number">1</span>d   缓存数据在<span class="number">1</span>天内没有被访问就会被删除</span><br></pre></td></tr></table></figure>

<p>max_size:设置最大缓存空间，如果缓存空间存满，默认会覆盖缓存时间最长的资源，如:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">max_size</span>=<span class="number">20</span>g</span><br></pre></td></tr></table></figure>

<p>配置实例:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">proxy_cache_path /usr/local/proxy_cache <span class="attr">keys_zone</span>=itcast:<span class="number">200</span>m  levels=<span class="number">1</span>:<span class="number">2</span>:<span class="number">1</span> inactive=<span class="number">1</span>d max_size=<span class="number">20</span>g<span class="comment">;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="proxy-cache"><a href="#proxy-cache" class="headerlink" title="proxy_cache"></a>proxy_cache</h3><p>该指令用来开启或关闭代理缓存，如果是开启则自定使用哪个缓存区来进行缓存。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache zone_name|off;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache off;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>zone_name：指定使用缓存区的名称</p>
<h3 id="proxy-cache-key"><a href="#proxy-cache-key" class="headerlink" title="proxy_cache_key"></a>proxy_cache_key</h3><p>该指令用来设置web缓存的key值，Nginx会根据key值MD5哈希存缓存。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_key key;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_key $scheme$proxy_host$request_uri;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="proxy-cache-valid"><a href="#proxy-cache-valid" class="headerlink" title="proxy_cache_valid"></a>proxy_cache_valid</h3><p>该指令用来对不同返回状态码的URL设置不同的缓存时间</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_valid [code …] time;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_valid 200 302 10m;</span><br><span class="line">proxy_cache_valid 404 1m;</span><br><span class="line">为200和302的响应URL设置10分钟缓存，为404的响应URL设置1分钟缓存</span><br><span class="line">proxy_cache_valid any 1m;</span><br><span class="line">对所有响应状态码的URL都设置1分钟缓存</span><br></pre></td></tr></table></figure>

<h3 id="proxy-cache-min-uses"><a href="#proxy-cache-min-uses" class="headerlink" title="proxy_cache_min_uses"></a>proxy_cache_min_uses</h3><p>该指令用来设置资源被访问多少次后被缓存</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_min_uses number;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_min_uses 1;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<h3 id="proxy-cache-methods"><a href="#proxy-cache-methods" class="headerlink" title="proxy_cache_methods"></a>proxy_cache_methods</h3><p>该指令用户设置缓存哪些HTTP方法</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_methods GET|HEAD|POST;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>proxy_cache_methods GET HEAD;</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>默认缓存HTTP的GET和HEAD方法，不缓存POST方法。</p>
<h2 id="Nginx缓存设置案例"><a href="#Nginx缓存设置案例" class="headerlink" title="Nginx缓存设置案例"></a>Nginx缓存设置案例</h2><h3 id="需求分析-1"><a href="#需求分析-1" class="headerlink" title="需求分析"></a>需求分析</h3><p><img src="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/1591959569463.png" alt="1591959569463"></p>
<h3 id="步骤实现"><a href="#步骤实现" class="headerlink" title="步骤实现"></a>步骤实现</h3><p>1.环境准备</p>
<p>应用服务器的环境准备</p>
<p>（1）在192.168.200.146服务器上的tomcat的webapps下面添加一个js目录，并在js目录中添加一个jquery.js文件</p>
<p>（2）启动tomcat</p>
<p>（3）访问测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.200.146:8080/js/jquery.js</span><br></pre></td></tr></table></figure>

<p>Nginx的环境准备</p>
<p>（1）完成Nginx反向代理配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	upstream backend&#123;</span><br><span class="line">		server 192.168.200.146:8080<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen       8080<span class="comment">;</span></span><br><span class="line">        server_name  localhost<span class="comment">;</span></span><br><span class="line">        location / &#123;</span><br><span class="line">        	proxy_pass http://backend/js/<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>（2）完成Nginx缓存配置</p>
<p>4.添加缓存配置</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	proxy_cache_path /usr/local/proxy_cache <span class="attr">levels</span>=<span class="number">2</span>:<span class="number">1</span> keys_zone=itcast:<span class="number">200</span>m inactive=<span class="number">1</span>d max_size=<span class="number">20</span>g<span class="comment">;</span></span><br><span class="line">	upstream backend&#123;</span><br><span class="line">		server 192.168.200.146:8080<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">	server &#123;</span><br><span class="line">		listen       8080<span class="comment">;</span></span><br><span class="line">        server_name  localhost<span class="comment">;</span></span><br><span class="line">        location / &#123;</span><br><span class="line">        	proxy_cache itcast<span class="comment">;</span></span><br><span class="line">            proxy_cache_key itheima<span class="comment">;</span></span><br><span class="line">            proxy_cache_min_uses 5<span class="comment">;</span></span><br><span class="line">            proxy_cache_valid 200 5d<span class="comment">;</span></span><br><span class="line">            proxy_cache_valid 404 30s<span class="comment">;</span></span><br><span class="line">            proxy_cache_valid any 1m<span class="comment">;</span></span><br><span class="line">            add_header nginx-cache &quot;$upstream_cache_status&quot;<span class="comment">;</span></span><br><span class="line">        	proxy_pass http://backend/js/<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Nginx缓存的清除"><a href="#Nginx缓存的清除" class="headerlink" title="Nginx缓存的清除"></a>Nginx缓存的清除</h2><h3 id="方式一-删除对应的缓存目录"><a href="#方式一-删除对应的缓存目录" class="headerlink" title="方式一:删除对应的缓存目录"></a>方式一:删除对应的缓存目录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/local/proxy_cache/......</span><br></pre></td></tr></table></figure>

<h3 id="方式二-使用第三方扩展模块"><a href="#方式二-使用第三方扩展模块" class="headerlink" title="方式二:使用第三方扩展模块"></a>方式二:使用第三方扩展模块</h3><h4 id="ngx-cache-purge"><a href="#ngx-cache-purge" class="headerlink" title="ngx_cache_purge"></a>ngx_cache_purge</h4><p>（1）下载ngx_cache_purge模块对应的资源包，并上传到服务器上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngx_cache_purge-2.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>（2）对资源文件进行解压缩</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf ngx_cache_purge-2.3.tar.gz</span><br></pre></td></tr></table></figure>

<p>（3）修改文件夹名称，方便后期配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv ngx_cache_purge-2.3 purge</span><br></pre></td></tr></table></figure>

<p>（4）查询Nginx的配置参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure>

<p>（5）进入Nginx的安装目录，使用.&#x2F;configure进行参数配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --add-module=/root/nginx/module/purge</span><br></pre></td></tr></table></figure>

<p>（6）使用make进行编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make</span><br></pre></td></tr></table></figure>

<p>（7）将nginx安装目录的nginx二级制可执行文件备份</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginxold</span><br></pre></td></tr></table></figure>

<p>（8）将编译后的objs中的nginx拷贝到nginx的sbin目录下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin</span><br></pre></td></tr></table></figure>

<p>（9）使用make进行升级</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure>

<p>（10）在nginx配置文件中进行如下配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	location ~/purge(/.*) &#123;</span><br><span class="line">		proxy_cache_purge itcast itheima;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<h2 id="Nginx设置资源不缓存"><a href="#Nginx设置资源不缓存" class="headerlink" title="Nginx设置资源不缓存"></a>Nginx设置资源不缓存</h2><p>前面咱们已经完成了Nginx作为web缓存服务器的使用。但是我们得思考一个问题就是不是所有的数据都适合进行缓存。比如说对于一些经常发生变化的数据。如果进行缓存的话，就很容易出现用户访问到的数据不是服务器真实的数据。所以对于这些资源我们在缓存的过程中就需要进行过滤，不进行缓存。</p>
<p>Nginx也提供了这块的功能设置，需要使用到如下两个指令</p>
<p>proxy_no_cache</p>
<p>该指令是用来定义不将数据进行缓存的条件。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_no_cache string …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>配置实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_no_cache $cookie_nocache $arg_nocache $arg_comment;</span><br></pre></td></tr></table></figure>

<p>proxy_cache_bypass</p>
<p>该指令是用来设置不从缓存中获取数据的条件。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>proxy_cache_bypass string …;</th>
</tr>
</thead>
<tbody><tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>http、server、location</td>
</tr>
</tbody></table>
<p>配置实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_cache_bypass $cookie_nocache $arg_nocache $arg_comment;</span><br></pre></td></tr></table></figure>

<p>上述两个指令都有一个指定的条件，这个条件可以是多个，并且多个条件中至少有一个不为空且不等于”0”,则条件满足成立。上面给的配置实例是从官方网站获取的，里面使用到了三个变量，分别是$cookie_nocache、$arg_nocache、$arg_comment</p>
<h3 id="cookie-nocache、-arg-nocache、-arg-comment"><a href="#cookie-nocache、-arg-nocache、-arg-comment" class="headerlink" title="$cookie_nocache、$arg_nocache、$arg_comment"></a>$cookie_nocache、$arg_nocache、$arg_comment</h3><p>这三个参数分别代表的含义是:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$cookie_nocache</span><br><span class="line">指的是当前请求的cookie中键的名称为nocache对应的值</span><br><span class="line">$arg_nocache和$arg_comment</span><br><span class="line">指的是当前请求的参数中属性名为nocache和comment对应的属性值</span><br></pre></td></tr></table></figure>

<p>案例演示下:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">log_format params $cookie_nocache | $arg_nocache | $arg_comment；</span><br><span class="line">server&#123;</span><br><span class="line">	listen	8081<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location /&#123;</span><br><span class="line">		access_log logs/access_params.log params<span class="comment">;</span></span><br><span class="line">		add_header Set-Cookie &#x27;<span class="attr">nocache</span>=<span class="number">999</span><span class="string">&#x27;;</span></span><br><span class="line"><span class="string">		root html;</span></span><br><span class="line"><span class="string">		index index.html;</span></span><br><span class="line"><span class="string">	&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="案例实现"><a href="#案例实现" class="headerlink" title="案例实现"></a>案例实现</h3><p>设置不缓存资源的配置方案</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	listen	8080<span class="comment">;</span></span><br><span class="line">	server_name localhost<span class="comment">;</span></span><br><span class="line">	location / &#123;</span><br><span class="line">		if ($request_uri ~ /.*\.js$)&#123;</span><br><span class="line">           set $nocache 1<span class="comment">;</span></span><br><span class="line">        &#125;</span><br><span class="line">		proxy_no_cache $nocache $cookie_nocache $arg_nocache $arg_comment<span class="comment">;</span></span><br><span class="line">        proxy_cache_bypass $nocache $cookie_nocache $arg_nocache $arg_comment<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://dreamerlearner.github.io">Dreamer Blog</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://dreamerlearner.github.io/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/">http://dreamerlearner.github.io/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AF%BC%E8%88%AA/">导航</a><a class="post-meta__tags" href="/tags/%E5%88%86%E4%BA%AB/">分享</a></div><div class="post_share"><div class="social-share" data-image="/img/vanilla.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/10/07/Nginx%E6%9E%B6%E6%9E%84%E7%AF%87/"><img class="prev-cover" src="/img/gears1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">Nginx架构篇</div></div></a></div><div class="next-post pull-right"><a href="/2022/10/07/Nginx%E5%9F%BA%E7%A1%80%E7%AF%87/"><img class="next-cover" src="/img/gears1.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Nginx基础篇</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/09/23/springboot%E5%89%8D%E8%A8%80/" title="springboot前言"><img class="cover" src="/img/golden.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot前言</div></div></a></div><div><a href="/2022/09/23/springboot%E8%BF%90%E7%BB%B4%E5%AE%9E%E7%94%A8%E7%AF%87/" title="springboot运维实用篇"><img class="cover" src="/img/nearby.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot运维实用篇</div></div></a></div><div><a href="/2022/09/23/springboot%E5%8E%9F%E7%90%86%E7%AF%87/" title="springboot原理篇"><img class="cover" src="/img/strings.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot原理篇</div></div></a></div><div><a href="/2022/09/23/springboot%E5%9F%BA%E7%A1%80%E7%AF%87/" title="springboot基础篇"><img class="cover" src="/img/responsive-web-site-screenshot.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot基础篇</div></div></a></div><div><a href="/2022/09/24/redis%E5%85%A5%E9%97%A8%E7%AF%87/" title="redis入门篇"><img class="cover" src="/img/om10.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-24</div><div class="title">redis入门篇</div></div></a></div><div><a href="/2022/09/24/redis%E5%AE%9E%E6%88%98%E7%AF%87/" title="redis实战篇"><img class="cover" src="/img/ipad-desk.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-24</div><div class="title">redis实战篇</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Dreamer Blog</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">15</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dreamerLearner"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dreamerlearner/dreamerlearner.github.io" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2107603134@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%9F%BA%E7%A1%80%E9%85%8D%E7%BD%AE%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.</span> <span class="toc-text">Nginx服务器基础配置实例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E6%9C%8D%E5%8A%A1%E6%93%8D%E4%BD%9C%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.</span> <span class="toc-text">Nginx服务操作的问题</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%85%8D%E7%BD%AE%E6%88%90%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.</span> <span class="toc-text">Nginx配置成系统服务</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%91%BD%E4%BB%A4%E9%85%8D%E7%BD%AE%E5%88%B0%E7%B3%BB%E7%BB%9F%E7%8E%AF%E5%A2%83"><span class="toc-number">4.</span> <span class="toc-text">Nginx命令配置到系统环境</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%83%A8%E7%BD%B2"><span class="toc-number">5.</span> <span class="toc-text">Nginx静态资源部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">Nginx静态资源概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.</span> <span class="toc-text">Nginx静态资源的配置指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#listen%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.1.</span> <span class="toc-text">listen指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-name%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.2.</span> <span class="toc-text">server_name指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%B9%E9%85%8D%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">匹配执行顺序</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#location%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.3.</span> <span class="toc-text">location指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%AF%B7%E6%B1%82%E8%B5%84%E6%BA%90%E7%9A%84%E7%9B%AE%E5%BD%95root-x2F-alias"><span class="toc-number">5.2.4.</span> <span class="toc-text">设置请求资源的目录root &#x2F; alias</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#index%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.5.</span> <span class="toc-text">index指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#error-page%E6%8C%87%E4%BB%A4"><span class="toc-number">5.2.6.</span> <span class="toc-text">error_page指令</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-number">5.3.</span> <span class="toc-text">静态资源优化配置语法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%8E%8B%E7%BC%A9%E5%AE%9E%E6%88%98"><span class="toc-number">5.4.</span> <span class="toc-text">Nginx静态资源压缩实战</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gzip%E6%A8%A1%E5%9D%97%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-number">5.4.1.</span> <span class="toc-text">Gzip模块配置指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gzip%E5%8E%8B%E7%BC%A9%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E4%BE%8B%E9%85%8D%E7%BD%AE"><span class="toc-number">5.4.2.</span> <span class="toc-text">Gzip压缩功能的实例配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gzip%E5%92%8Csendfile%E5%85%B1%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-number">5.4.3.</span> <span class="toc-text">Gzip和sendfile共存问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gzip-static%E6%8C%87%E4%BB%A4"><span class="toc-number">5.4.3.1.</span> <span class="toc-text">gzip_static指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9D%97%E5%88%B0Nginx%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.4.3.2.</span> <span class="toc-text">添加模块到Nginx的实现步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gzip-static%E6%B5%8B%E8%AF%95%E4%BD%BF%E7%94%A8"><span class="toc-number">5.4.3.3.</span> <span class="toc-text">gzip_static测试使用</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E7%BC%93%E5%AD%98%E5%A4%84%E7%90%86"><span class="toc-number">5.5.</span> <span class="toc-text">静态资源的缓存处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%BC%93%E5%AD%98"><span class="toc-number">5.5.1.</span> <span class="toc-text">什么是缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFweb%E7%BC%93%E5%AD%98"><span class="toc-number">5.5.2.</span> <span class="toc-text">什么是web缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#web%E7%BC%93%E5%AD%98%E7%9A%84%E7%A7%8D%E7%B1%BB"><span class="toc-number">5.5.3.</span> <span class="toc-text">web缓存的种类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">5.5.4.</span> <span class="toc-text">浏览器缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">5.5.5.</span> <span class="toc-text">为什么要用浏览器缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9A%84%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="toc-number">5.5.6.</span> <span class="toc-text">浏览器缓存的执行流程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link"><span class="toc-number">5.5.6.1.</span> <span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">5.5.7.</span> <span class="toc-text">浏览器缓存相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#expires%E6%8C%87%E4%BB%A4"><span class="toc-number">5.5.7.1.</span> <span class="toc-text">expires指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#add-header%E6%8C%87%E4%BB%A4"><span class="toc-number">5.5.7.2.</span> <span class="toc-text">add_header指令</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E7%9A%84%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="toc-number">6.</span> <span class="toc-text">Nginx的跨域问题解决</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5"><span class="toc-number">6.1.</span> <span class="toc-text">同源策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">6.2.</span> <span class="toc-text">跨域问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98%E7%9A%84%E6%A1%88%E4%BE%8B%E6%BC%94%E7%A4%BA"><span class="toc-number">6.3.</span> <span class="toc-text">跨域问题的案例演示</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">6.4.</span> <span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">6.5.</span> <span class="toc-text">静态资源防盗链</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E8%B5%84%E6%BA%90%E7%9B%97%E9%93%BE"><span class="toc-number">6.5.1.</span> <span class="toc-text">什么是资源盗链</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E9%98%B2%E7%9B%97%E9%93%BE%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%EF%BC%9A"><span class="toc-number">6.5.2.</span> <span class="toc-text">Nginx防盗链的实现原理：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%92%88%E5%AF%B9%E7%9B%AE%E5%BD%95%E8%BF%9B%E8%A1%8C%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">6.5.3.</span> <span class="toc-text">针对目录进行防盗链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Rewrite%E5%8A%9F%E8%83%BD%E9%85%8D%E7%BD%AE"><span class="toc-number">6.6.</span> <span class="toc-text">Rewrite功能配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%9C%E5%9C%B0%E5%9D%80%E9%87%8D%E5%86%99%E2%80%9D%E4%B8%8E%E2%80%9D%E5%9C%B0%E5%9D%80%E8%BD%AC%E5%8F%91%E2%80%9D"><span class="toc-number">6.6.1.</span> <span class="toc-text">“地址重写”与”地址转发”</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rewrite%E8%A7%84%E5%88%99"><span class="toc-number">6.6.2.</span> <span class="toc-text">Rewrite规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#set%E6%8C%87%E4%BB%A4"><span class="toc-number">6.6.2.1.</span> <span class="toc-text">set指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Rewrite%E5%B8%B8%E7%94%A8%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">6.6.2.2.</span> <span class="toc-text">Rewrite常用全局变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#if%E6%8C%87%E4%BB%A4"><span class="toc-number">6.6.2.3.</span> <span class="toc-text">if指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#break%E6%8C%87%E4%BB%A4"><span class="toc-number">6.6.2.4.</span> <span class="toc-text">break指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#return%E6%8C%87%E4%BB%A4"><span class="toc-number">6.6.2.5.</span> <span class="toc-text">return指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rewrite%E6%8C%87%E4%BB%A4"><span class="toc-number">6.6.2.6.</span> <span class="toc-text">rewrite指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rewrite-log%E6%8C%87%E4%BB%A4"><span class="toc-number">6.6.2.7.</span> <span class="toc-text">rewrite_log指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rewrite%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="toc-number">6.6.3.</span> <span class="toc-text">Rewrite的案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%B7%B3%E8%BD%AC"><span class="toc-number">6.6.3.1.</span> <span class="toc-text">域名跳转</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E9%95%9C%E5%83%8F"><span class="toc-number">6.6.3.2.</span> <span class="toc-text">域名镜像</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E5%9F%9F%E5%90%8D"><span class="toc-number">6.6.3.3.</span> <span class="toc-text">独立域名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E8%87%AA%E5%8A%A8%E6%B7%BB%E5%8A%A0%E2%80%9D-x2F-%E2%80%9C"><span class="toc-number">6.6.3.4.</span> <span class="toc-text">目录自动添加”&#x2F;“</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%88%E5%B9%B6%E7%9B%AE%E5%BD%95"><span class="toc-number">6.6.3.5.</span> <span class="toc-text">合并目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">6.6.3.6.</span> <span class="toc-text">防盗链</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">7.</span> <span class="toc-text">Nginx反向代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%A6%82%E8%BF%B0"><span class="toc-number">7.1.</span> <span class="toc-text">Nginx反向代理概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%9A%84%E9%85%8D%E7%BD%AE%E8%AF%AD%E6%B3%95"><span class="toc-number">7.2.</span> <span class="toc-text">Nginx反向代理的配置语法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-pass"><span class="toc-number">7.2.1.</span> <span class="toc-text">proxy_pass</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-set-header"><span class="toc-number">7.2.2.</span> <span class="toc-text">proxy_set_header</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-redirect"><span class="toc-number">7.2.3.</span> <span class="toc-text">proxy_redirect</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E5%AE%9E%E6%88%98"><span class="toc-number">7.3.</span> <span class="toc-text">Nginx反向代理实战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9A%84%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6"><span class="toc-number">7.4.</span> <span class="toc-text">Nginx的安全控制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8SSL%E5%AF%B9%E6%B5%81%E9%87%8F%E8%BF%9B%E8%A1%8C%E5%8A%A0%E5%AF%86"><span class="toc-number">7.4.1.</span> <span class="toc-text">如何使用SSL对流量进行加密</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E6%B7%BB%E5%8A%A0SSL%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">7.4.1.1.</span> <span class="toc-text">nginx添加SSL的支持</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Nginx%E7%9A%84SSL%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">7.4.1.2.</span> <span class="toc-text">Nginx的SSL相关指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">7.4.1.3.</span> <span class="toc-text">生成证书</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%90%AFSSL%E5%AE%9E%E4%BE%8B"><span class="toc-number">7.4.1.4.</span> <span class="toc-text">开启SSL实例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%B3%BB%E7%BB%9F%E8%B0%83%E4%BC%98"><span class="toc-number">7.5.</span> <span class="toc-text">反向代理系统调优</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.</span> <span class="toc-text">Nginx负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A6%82%E8%BF%B0"><span class="toc-number">8.1.</span> <span class="toc-text">负载均衡概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">8.2.</span> <span class="toc-text">负载均衡的原理及处理流程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">8.2.1.</span> <span class="toc-text">负载均衡的作用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%B8%B8%E7%94%A8%E7%9A%84%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F"><span class="toc-number">8.3.</span> <span class="toc-text">负载均衡常用的处理方式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-%E7%94%A8%E6%88%B7%E6%89%8B%E5%8A%A8%E9%80%89%E6%8B%A9"><span class="toc-number">8.3.1.</span> <span class="toc-text">方式一:用户手动选择</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-DNS%E8%BD%AE%E8%AF%A2%E6%96%B9%E5%BC%8F"><span class="toc-number">8.3.2.</span> <span class="toc-text">方式二:DNS轮询方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%89-%E5%9B%9B-x2F-%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.3.3.</span> <span class="toc-text">方式三:四&#x2F;七层负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.4.</span> <span class="toc-text">Nginx七层负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-number">8.4.1.</span> <span class="toc-text">Nginx七层负载均衡的指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#upstream%E6%8C%87%E4%BB%A4"><span class="toc-number">8.4.1.1.</span> <span class="toc-text">upstream指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#server%E6%8C%87%E4%BB%A4"><span class="toc-number">8.4.1.2.</span> <span class="toc-text">server指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E5%AE%9E%E7%8E%B0%E6%B5%81%E7%A8%8B"><span class="toc-number">8.4.2.</span> <span class="toc-text">Nginx七层负载均衡的实现流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%8A%B6%E6%80%81"><span class="toc-number">8.4.3.</span> <span class="toc-text">负载均衡状态</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#down"><span class="toc-number">8.4.3.1.</span> <span class="toc-text">down</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#backup"><span class="toc-number">8.4.3.2.</span> <span class="toc-text">backup</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#max-conns"><span class="toc-number">8.4.3.3.</span> <span class="toc-text">max_conns</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#max-fails%E5%92%8Cfail-timeout"><span class="toc-number">8.4.3.4.</span> <span class="toc-text">max_fails和fail_timeout</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AD%96%E7%95%A5"><span class="toc-number">8.5.</span> <span class="toc-text">负载均衡策略</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AE%E8%AF%A2"><span class="toc-number">8.5.1.</span> <span class="toc-text">轮询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#weight%E5%8A%A0%E6%9D%83-%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2"><span class="toc-number">8.5.2.</span> <span class="toc-text">weight加权[加权轮询]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ip-hash"><span class="toc-number">8.5.3.</span> <span class="toc-text">ip_hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#least-conn"><span class="toc-number">8.5.4.</span> <span class="toc-text">least_conn</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#url-hash"><span class="toc-number">8.5.5.</span> <span class="toc-text">url_hash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fair"><span class="toc-number">8.5.6.</span> <span class="toc-text">fair</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%A1%88%E4%BE%8B"><span class="toc-number">8.6.</span> <span class="toc-text">负载均衡案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%80%EF%BC%9A%E5%AF%B9%E6%89%80%E6%9C%89%E8%AF%B7%E6%B1%82%E5%AE%9E%E7%8E%B0%E4%B8%80%E8%88%AC%E8%BD%AE%E8%AF%A2%E8%A7%84%E5%88%99%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.6.1.</span> <span class="toc-text">案例一：对所有请求实现一般轮询规则的负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%8C%EF%BC%9A%E5%AF%B9%E6%89%80%E6%9C%89%E8%AF%B7%E6%B1%82%E5%AE%9E%E7%8E%B0%E5%8A%A0%E6%9D%83%E8%BD%AE%E8%AF%A2%E8%A7%84%E5%88%99%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.6.2.</span> <span class="toc-text">案例二：对所有请求实现加权轮询规则的负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%B8%89%EF%BC%9A%E5%AF%B9%E7%89%B9%E5%AE%9A%E8%B5%84%E6%BA%90%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.6.3.</span> <span class="toc-text">案例三：对特定资源实现负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%9B%9B%EF%BC%9A%E5%AF%B9%E4%B8%8D%E5%90%8C%E5%9F%9F%E5%90%8D%E5%AE%9E%E7%8E%B0%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.6.4.</span> <span class="toc-text">案例四：对不同域名实现负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E4%BA%94%EF%BC%9A%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89URL%E9%87%8D%E5%86%99%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.6.5.</span> <span class="toc-text">案例五：实现带有URL重写的负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">8.7.</span> <span class="toc-text">Nginx四层负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0stream%E6%A8%A1%E5%9D%97%E7%9A%84%E6%94%AF%E6%8C%81"><span class="toc-number">8.7.1.</span> <span class="toc-text">添加stream模块的支持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Nginx%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%8C%87%E4%BB%A4"><span class="toc-number">8.7.2.</span> <span class="toc-text">Nginx四层负载均衡的指令</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#stream%E6%8C%87%E4%BB%A4"><span class="toc-number">8.7.2.1.</span> <span class="toc-text">stream指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#upstream%E6%8C%87%E4%BB%A4-1"><span class="toc-number">8.7.2.2.</span> <span class="toc-text">upstream指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%9A%84%E6%A1%88%E4%BE%8B"><span class="toc-number">8.7.3.</span> <span class="toc-text">四层负载均衡的案例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="toc-number">8.7.3.1.</span> <span class="toc-text">需求分析</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E9%9B%86%E6%88%90"><span class="toc-number">9.</span> <span class="toc-text">Nginx缓存集成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98%E7%9A%84%E6%A6%82%E5%BF%B5"><span class="toc-number">9.1.</span> <span class="toc-text">缓存的概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%9A%84web%E7%BC%93%E5%AD%98%E6%9C%8D%E5%8A%A1"><span class="toc-number">9.2.</span> <span class="toc-text">Nginx的web缓存服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E8%AE%BE%E7%BD%AE%E7%9A%84%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">9.3.</span> <span class="toc-text">Nginx缓存设置的相关指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-path"><span class="toc-number">9.3.1.</span> <span class="toc-text">proxy_cache_path</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache"><span class="toc-number">9.3.2.</span> <span class="toc-text">proxy_cache</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-key"><span class="toc-number">9.3.3.</span> <span class="toc-text">proxy_cache_key</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-valid"><span class="toc-number">9.3.4.</span> <span class="toc-text">proxy_cache_valid</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-min-uses"><span class="toc-number">9.3.5.</span> <span class="toc-text">proxy_cache_min_uses</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proxy-cache-methods"><span class="toc-number">9.3.6.</span> <span class="toc-text">proxy_cache_methods</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E8%AE%BE%E7%BD%AE%E6%A1%88%E4%BE%8B"><span class="toc-number">9.4.</span> <span class="toc-text">Nginx缓存设置案例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90-1"><span class="toc-number">9.4.1.</span> <span class="toc-text">需求分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.4.2.</span> <span class="toc-text">步骤实现</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E7%BC%93%E5%AD%98%E7%9A%84%E6%B8%85%E9%99%A4"><span class="toc-number">9.5.</span> <span class="toc-text">Nginx缓存的清除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%B8%80-%E5%88%A0%E9%99%A4%E5%AF%B9%E5%BA%94%E7%9A%84%E7%BC%93%E5%AD%98%E7%9B%AE%E5%BD%95"><span class="toc-number">9.5.1.</span> <span class="toc-text">方式一:删除对应的缓存目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F%E4%BA%8C-%E4%BD%BF%E7%94%A8%E7%AC%AC%E4%B8%89%E6%96%B9%E6%89%A9%E5%B1%95%E6%A8%A1%E5%9D%97"><span class="toc-number">9.5.2.</span> <span class="toc-text">方式二:使用第三方扩展模块</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ngx-cache-purge"><span class="toc-number">9.5.2.1.</span> <span class="toc-text">ngx_cache_purge</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx%E8%AE%BE%E7%BD%AE%E8%B5%84%E6%BA%90%E4%B8%8D%E7%BC%93%E5%AD%98"><span class="toc-number">9.6.</span> <span class="toc-text">Nginx设置资源不缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cookie-nocache%E3%80%81-arg-nocache%E3%80%81-arg-comment"><span class="toc-number">9.6.1.</span> <span class="toc-text">$cookie_nocache、$arg_nocache、$arg_comment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A1%88%E4%BE%8B%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.6.2.</span> <span class="toc-text">案例实现</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/18/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/" title="面试笔记"><img src="/img/nearby.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="面试笔记"/></a><div class="content"><a class="title" href="/2022/10/18/%E9%9D%A2%E8%AF%95%E7%AC%94%E8%AE%B0/" title="面试笔记">面试笔记</a><time datetime="2022-10-18T04:20:30.000Z" title="Created 2022-10-18 12:20:30">2022-10-18</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/Nginx%E6%A8%A1%E5%9D%97%E7%AF%87/" title="Nginx模块篇"><img src="/img/responsive-web-site-screenshot.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx模块篇"/></a><div class="content"><a class="title" href="/2022/10/07/Nginx%E6%A8%A1%E5%9D%97%E7%AF%87/" title="Nginx模块篇">Nginx模块篇</a><time datetime="2022-10-07T13:03:47.000Z" title="Created 2022-10-07 21:03:47">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/Nginx%E6%9E%B6%E6%9E%84%E7%AF%87/" title="Nginx架构篇"><img src="/img/gears1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx架构篇"/></a><div class="content"><a class="title" href="/2022/10/07/Nginx%E6%9E%B6%E6%9E%84%E7%AF%87/" title="Nginx架构篇">Nginx架构篇</a><time datetime="2022-10-07T13:03:41.000Z" title="Created 2022-10-07 21:03:41">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/" title="Nginx进阶篇"><img src="/img/vanilla.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx进阶篇"/></a><div class="content"><a class="title" href="/2022/10/07/Nginx%E8%BF%9B%E9%98%B6%E7%AF%87/" title="Nginx进阶篇">Nginx进阶篇</a><time datetime="2022-10-07T11:54:51.000Z" title="Created 2022-10-07 19:54:51">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/Nginx%E5%9F%BA%E7%A1%80%E7%AF%87/" title="Nginx基础篇"><img src="/img/gears1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Nginx基础篇"/></a><div class="content"><a class="title" href="/2022/10/07/Nginx%E5%9F%BA%E7%A1%80%E7%AF%87/" title="Nginx基础篇">Nginx基础篇</a><time datetime="2022-10-07T11:54:42.000Z" title="Created 2022-10-07 19:54:42">2022-10-07</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/vanilla.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Dreamer Blog</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>