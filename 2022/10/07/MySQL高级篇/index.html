<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>MySQL高级篇 | Dreamer Blog</title><meta name="keywords" content="导航,分享"><meta name="author" content="Dreamer Blog"><meta name="copyright" content="Dreamer Blog"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Mycat概述如今随着互联网的发展，数据的量级也是成指数的增长，从 GB 到 TB 到 PB。对数据的各种操作也是愈加的困难，传统的关系性数据库已经无法满足快速查询与插入数据的需求。这个时候 NoSQL 的出现暂时解决了这一危机。它通过降低数据的安全性，减少对事务的支持，减少对复杂查询的支持，来获取性能上的提升。 但是，在有些场合 NoSQL 一些折衷是无法满足使用场景的，就比如有些使用场景是绝">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL高级篇">
<meta property="og:url" content="http://dreamerlearner.github.io/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/index.html">
<meta property="og:site_name" content="Dreamer Blog">
<meta property="og:description" content="Mycat概述如今随着互联网的发展，数据的量级也是成指数的增长，从 GB 到 TB 到 PB。对数据的各种操作也是愈加的困难，传统的关系性数据库已经无法满足快速查询与插入数据的需求。这个时候 NoSQL 的出现暂时解决了这一危机。它通过降低数据的安全性，减少对事务的支持，减少对复杂查询的支持，来获取性能上的提升。 但是，在有些场合 NoSQL 一些折衷是无法满足使用场景的，就比如有些使用场景是绝">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://dreamerlearner.github.io/img/om10.jpg">
<meta property="article:published_time" content="2022-10-07T04:52:12.000Z">
<meta property="article:modified_time" content="2022-10-07T05:06:44.151Z">
<meta property="article:author" content="Dreamer Blog">
<meta property="article:tag" content="导航">
<meta property="article:tag" content="分享">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://dreamerlearner.github.io/img/om10.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://dreamerlearner.github.io/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'MySQL高级篇',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-10-07 13:06:44'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><meta name="generator" content="Hexo 6.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/favicon.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/om10.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Dreamer Blog</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 目录</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">MySQL高级篇</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-10-07T04:52:12.000Z" title="Created 2022-10-07 12:52:12">2022-10-07</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-10-07T05:06:44.151Z" title="Updated 2022-10-07 13:06:44">2022-10-07</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MySQL%E5%AD%A6%E4%B9%A0/">MySQL学习</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/MySQL%E5%AD%A6%E4%B9%A0/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/">MySQL高级篇</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="MySQL高级篇"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><hr>
<h1 id="Mycat概述"><a href="#Mycat概述" class="headerlink" title="Mycat概述"></a>Mycat概述</h1><p>如今随着互联网的发展，数据的量级也是成指数的增长，从 GB 到 TB 到 PB。对数据的各种操作也是愈加的困难，传统的关系性数据库已经无法满足快速查询与插入数据的需求。这个时候 NoSQL 的出现暂时解决了这一危机。它通过降低数据的安全性，减少对事务的支持，减少对复杂查询的支持，来获取性能上的提升。</p>
<p>但是，在有些场合 NoSQL 一些折衷是无法满足使用场景的，就比如有些使用场景是绝对要有事务与安全指标的。这个时候 NoSQL 肯定是无法满足的，所以还是需要使用关系性数据库。如何使用关系型数据库解决海量存储的问题呢？此时就需要做数据库集群，为了提高查询性能将一个数据库的数据分散到不同的数据库中存储。</p>
<h2 id="基本介绍"><a href="#基本介绍" class="headerlink" title="基本介绍"></a>基本介绍</h2><p>Mycat是<code>数据库分库分表</code>中间件。</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829223150660.png" alt="image-20210829223150660"></p>
<p><strong>1、数据库中间件</strong></p>
<p><strong>中间件：是一类连接软件组件和应用的计算机软件，以便于软件各部件之间的沟通。</strong></p>
<p>例子：Tomcat，web中间件。</p>
<p>数据库中间件：连接java应用程序和数据库</p>
<p><strong>2、为什么要用Mycat？</strong></p>
<p>①  Java与数据库紧耦合。万一耦合的MySQL DBMS挂了怎么办？</p>
<p>②  高访问量、高并发对数据库的压力。</p>
<p>③  多个数据库读写请求数据不一致</p>
<p><strong>3、数据库中间件对比</strong></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/zhognjianjian.png" alt="zhognjianjian"></p>
<p>①  <code>Cobar</code>属于阿里B2B事业群，始于2008年，在阿里服役3年多，接管3000+个MySQL数据库的schema,集群日处理在线SQL请求50亿次以上。由于Cobar发起人的离职，Cobar停止维护。</p>
<p>②  <code>Mycat</code>是开源社区在阿里cobar基础上进行二次开发，解决了cobar存在的问题，并且加入了许多新的功能在其中。青出于蓝而胜于蓝。</p>
<p>③  <code>OneProxy</code>基于MySQL官方的proxy思想利用c语言进行开发的，OneProxy是一款商业<code>收费</code>的中间件。舍弃了一些功能，专注在<code>性能和稳定性上</code>。</p>
<p>④  <code>kingshard</code>由小团队用go语言开发，还需要发展，需要不断完善。</p>
<p>⑤  <code>Vitess</code>是Youtube生产在使用，架构很复杂。不支持MySQL原生协议，使用<code>需要大量改造成本</code>。</p>
<p>⑥  <code>Atlas</code>是360团队基于mysql proxy改写，功能还需完善，高并发下不稳定。</p>
<p>⑦  <code>MaxScale</code>是mariadb（MySQL原作者维护的一个版本） 研发的中间件</p>
<p>⑧  <code>MySQLRoute</code>是MySQL官方Oracle公司发布的中间件</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829223348714.png" alt="image-20210829223348714"></p>
<p><strong>3、Mycat的官网</strong></p>
<p>  <a target="_blank" rel="noopener" href="http://www.mycat.io/">http://www.mycat.io/</a></p>
 <img src="image-20210815142309672.png" alt="image-20210815142309672" style="zoom:50%;" />

<h2 id="Mycat作用"><a href="#Mycat作用" class="headerlink" title="Mycat作用"></a>Mycat作用</h2><p><strong>1、读写分离</strong></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210825232422178.png" alt="image-20210825232422178"></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210826191320528.png" alt="image-20210826191320528"></p>
<p><strong>2、数据分片</strong></p>
<p>垂直拆分（分库）、水平拆分（分表）、垂直+水平拆分（分库分表）</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/shujufenpian.png" alt="shujufenpian"></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210826234533399.png" alt="image-20210826234533399"></p>
<p><strong>3、多数据源整合</strong></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/duoshujuyuanzhenghe.png" alt="duoshujuyuanzhenghe"></p>
<p>Mycat支持的数据库：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829223416736.png" alt="image-20210829223416736"></p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>Mycat 的原理中最重要的一个动词是“<code>拦截</code>”，它拦截了用户发送过来的 SQL 语句，首先对 SQL 语句做了一些特定的分析：如<code>分片分析、路由分析、读写分离分析、缓存分析</code>等，然后将此 SQL 发往后端的真实数据库，并将返回的结果做适当的处理，最终再返回给用户。</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/lanjie.png" alt="lanjie"></p>
<p>这种方式把数据库的分布式从代码中解耦出来，程序员察觉不出来后台使用<code>Mycat</code>还是<code>MySQL</code>。</p>
<p>整体过程可以概括为：<code>拦截</code> –  <code>分发</code> – <code>响应</code></p>
<h1 id="使用前准备工作"><a href="#使用前准备工作" class="headerlink" title="使用前准备工作"></a>使用前准备工作</h1><p>1、准备<code>4台</code>CentOS 虚拟机</p>
<p>2、每台虚拟机上需要安装好MySQL (可以是MySQL8.0 或者 MySQL5.7 皆可)</p>
<p>说明：前面我们讲过如何克隆一台CentOS。大家可以在一台CentOS上安装好MySQL，进而通过克隆的方式复制出3台包含MySQL的虚拟机。</p>
<p>注意：克隆的方式需要修改新克隆出来主机的：① <code>MAC地址</code> ② <code>hostname</code>  ③ <code>IP 地址</code>  ④ <code>UUID</code>。</p>
<p>此外，克隆的方式生成的虚拟机（包含MySQL Server），则克隆的虚拟机MySQL Server的UUID相同，必须修改，否则在有些场景会报错。比如：<code>show slave status\G</code>，报如下的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have equal MySQL server UUIDs; these UUIDs must be different for replication to work.</span><br></pre></td></tr></table></figure>

<p>修改MySQL Server 的UUID方式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/mysql/auto.cnf</span><br><span class="line"></span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<h1 id="安装启动"><a href="#安装启动" class="headerlink" title="安装启动"></a>安装启动</h1><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p><strong>1、解压后即可使用</strong></p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210815142736156.png" alt="image-20210815142736156"></p>
<p>解压缩文件拷贝到linux下 <code>/usr/local/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@atguigu02 opt]# tar -zxvf Mycat-server-1.6.7.1-release-20190627191042-linux.tar.gz</span><br><span class="line"></span><br><span class="line">[root@atguigu02 opt]# cp -r mycat/ /usr/local</span><br><span class="line"></span><br><span class="line">[root@atguigu02 opt]# rm -rf mycat</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829223555681.png" alt="image-20210829223555681"></p>
<p>打开mycat目录结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bin：二进制执行文件</span><br><span class="line">conf：配置文件目录</span><br><span class="line">lib：依赖</span><br><span class="line">logs：日志</span><br></pre></td></tr></table></figure>

<p><strong>2、conf目录下三个配置文件</strong></p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829223711744.png" alt="image-20210829223711744"></p>
<p>① <code>schema.xml</code>：定义逻辑库，表、分片节点等内容，实现读写分离</p>
<p>② <code>rule.xml</code>：定义分片规则，实现分库分表规则配置</p>
<p>③ <code>server.xml</code>：配置MyCat作为虚拟数据库的信息（地址、数据库名、用户名、密码等信息）</p>
<h2 id="配置与启动"><a href="#配置与启动" class="headerlink" title="配置与启动"></a>配置与启动</h2><p><strong>1、修改配置文件 server.xml</strong></p>
<p>修改用户信息，与MySQL区分，如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;mycat&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span>123456<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>TESTDB<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 这里的TESTDB，理解为用户面向Mycat的统一的一个逻辑数据库。--&gt;</span></span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210815221401476.png" alt="image-20210815221401476"></p>
<p><strong>2、修改配置文件 schema.xml</strong></p>
<ul>
<li><p>删除<code>&lt;schema&gt;</code>标签间的表信息，增加dataNode属性 <code>dataNode=&quot;dn1&quot;</code></p>
</li>
<li><p><code>&lt;dataNode&gt;</code>标签只留一个，可修改属性值</p>
</li>
<li><p><code>&lt;dataHost&gt;</code>标签只留一个，修改属性值</p>
<ul>
<li>内部节点<code>&lt;writeHost&gt;</code> 和 <code>&lt;readHost&gt;</code>只留一对，修改属性值：url、user、password</li>
</ul>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 虚拟库与真实库的映射 </span></span><br><span class="line"><span class="comment">	name=&quot;TESTDB&quot; 虚拟库的名字，对应刚刚在server.xml中设置的TESTDB</span></span><br><span class="line"><span class="comment">	sqlMaxLimit=&quot;100&quot;，允许最大查询记录数</span></span><br><span class="line"><span class="comment">	checkSQLschema=&quot;false&quot; 是否检查自动删除 “虚拟库名”</span></span><br><span class="line"><span class="comment">	dataNode=&quot;dn1&quot; 虚拟库对应的真实database，值为dataNode标签的name</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 可以访问的表，只有设置在这里的表才会被MyCat管理访问 </span></span><br><span class="line"><span class="comment">		dataNode:虚拟库对应的真实database，对应&lt;dataNode&gt;标签。如果做分片，则配置多个，用逗号分隔；或者使用db$0-99，代表db0到db99的database</span></span><br><span class="line"><span class="comment">		rule：分片规则，如果没有则删除</span></span><br><span class="line"><span class="comment">		--&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- &lt;table name=&quot;tb_item&quot; dataNode=&quot;dn1&quot;/&gt; --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 真实的database信息，每一个dataNode就是一个数据库分片</span></span><br><span class="line"><span class="comment">		name：虚拟名称</span></span><br><span class="line"><span class="comment">		dataHost：真实库的主机信息，对应&lt;dataHost&gt;标签</span></span><br><span class="line"><span class="comment">		database：真实MySQL中真实的物理数据库名称</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;testdb&quot;</span> /&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">&lt;!-- 真实库的主机信息</span></span><br><span class="line"><span class="comment">		name：主机名,name属性值要与dataNode节点中的dataHost属性值对应</span></span><br><span class="line"><span class="comment">		maxCon：最大连接， minCon：最小连接</span></span><br><span class="line"><span class="comment">		balance：负载均衡方式：0~3四种选项。0，不开启读写分离。1~3都开启，区别是主是否参与读</span></span><br><span class="line"><span class="comment">		writeType：写负载均衡。永远设置0</span></span><br><span class="line"><span class="comment">		dbDriver：驱动类型，推荐native，可选jdbc</span></span><br><span class="line"><span class="comment">		switchType：主从的自动切换</span></span><br><span class="line"><span class="comment">	--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!-- 这里设置写主机信息 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.128:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">			<span class="comment">&lt;!-- 这里设置读主机信息 --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.127:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">	</span><br><span class="line">	<span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628996577463.jpg" alt="img"></p>
<p><strong>3、验证数据库访问情况</strong></p>
<p>Mycat作为数据库中间件要和数据库部署在不同机器上，所以要验证远程访问情况。使用Mycat所在的主机访问Master和Slave端的MySQL Server。</p>
<p>注意：要关闭防火墙！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#确认两台MySQL服务器可以通过远程进行访问</span><br><span class="line">mysql -uroot -p123123 -h 192.168.140.128 -P 3306</span><br><span class="line">mysql -uroot -p123123 -h 192.168.140.127 -P 3306</span><br><span class="line"></span><br><span class="line">#如远程访问报错，请建对应用户</span><br><span class="line">grant all privileges on *.* to root@&#x27;缺少的host&#x27;  identified by &#x27;123123&#x27;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>4、启动程序</strong></p>
<p>在 <code>mycat/bin</code> 目录下执行：</p>
<p><strong>方式1：控制台启动</strong> ： <code>./mycat console</code></p>
<p><strong>方式2：后台启动</strong> ： <code>./mycat start</code></p>
<p>为了能第一时间看到启动日志，方便定位问题，我们选择①控制台启动。</p>
<p><strong>其它操作：</strong></p>
<p>后台关闭：<code>./mycat stop</code></p>
<p>后台重启：<code>./mycat restart</code></p>
<p>状态： <code>./mycat status</code></p>
<p>日志文件：<code>mycat/logs/wrapper.log</code></p>
<p><strong>5、启动时可能出现报错</strong></p>
<p>如果操作系统是CentOS6.8，可能会出现域名解析失败错误，如下图：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628996901367.jpg" alt="graphic"></p>
<p>可以按照以下步骤解决</p>
<p>①  用 <code>vim</code> 修改 <code>/etc/hosts</code> 文件，在 127.0.0.1 后面增加你的机器名</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628996913378.jpg" alt="graphic"></p>
<p>②  修改后重新启动网络服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service network restart   #CentOS 6</span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628996973583.jpg" alt="graphic"></p>
<h2 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h2><h3 id="登录后台管理窗口"><a href="#登录后台管理窗口" class="headerlink" title="登录后台管理窗口"></a>登录后台管理窗口</h3><p><code>9066端口号对应后台管理窗口，用于运维人员管理维护Mycat使用</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -umycat -p123456 -P 9066 -h 192.168.140.128</span><br></pre></td></tr></table></figure>

<p>注意：这里我是在对应MySQL8.0中使用的Mycat，可能会报错：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210815225720216.png" alt="image-20210815225720216"></p>
<p>解决方式1：修改server.xml中的标签。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;nonePasswordLogin&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- 0为需要密码登陆、1为不需要密码登陆 ,默认为0，设置为1则需要指定默认账户--&gt;</span></span><br></pre></td></tr></table></figure>

<p>重新启动mycat无密码登录，访问成功。 </p>
<p>解决方式2：更换MySQL的版本。</p>
<p><strong>常用命令如下：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show database</span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001.png" alt="graphic"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show @@help</span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image003.jpg" alt="graphic"></p>
<h3 id="登录数据窗口"><a href="#登录数据窗口" class="headerlink" title="登录数据窗口"></a>登录数据窗口</h3><p><code>8066端口号对应开发人员使用，用于通过Mycat查询数据</code>，我们选择这种方式访问Mycat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -umycat -p123456 -P 8066 -h 192.168.140.128</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br><span class="line"></span><br><span class="line">use TESTDB;</span><br><span class="line"></span><br><span class="line">show tables;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="项目中登录"><a href="#项目中登录" class="headerlink" title="项目中登录"></a>项目中登录</h3><p>其实项目中，只要改一个地方即可，就是jdbc的连接参数。</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829224849931.png" alt="image-20210829224849931"></p>
<h1 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h1><p>我们通过Mycat和MySQL的主从复制配合搭建数据库的读写分离，实现MySQL的高可用性。我们将搭建：<code>一主一从</code>、<code>双主双从</code>两种读写分离模式。</p>
<h2 id="主从复制原理-1"><a href="#主从复制原理-1" class="headerlink" title="主从复制原理"></a>主从复制原理</h2><p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image004.jpg" alt="graphic"></p>
<p>提到主从同步的原理，我们就需要了解在数据库中的一个重要日志文件，那就是 Binlog 二 进制日志，它记录了对数据库进行更新的事件。实际上主从同步的原理就是基于 Binlog 进行数据同步的。在主从复制过程中，会基于 3 个线程来操作，一个<code>主库线程</code>，两个<code>从库线程</code>。 </p>
<p>二进制日志转储线程（Binlog dump thread）是一个主库线程。当从库线程连接的时候， 主库可以将二进制日志发送给从库，当主库读取事件的时候，会在 <code>Binlog 上加锁</code>，读取完成之后，再将锁释放掉。 </p>
<p>从库 I&#x2F;O 线程会连接到主库，向主库发送请求更新 Binlog。这时从库的 I&#x2F;O 线程就可以读取到主库的二进制日志转储线程发送的 <code>Binlog 更新部分</code>，并且拷贝到本地形成中继日志 （Relay log）。 </p>
<p>从库 SQL 线程会读取从库中的中继日志，并且<code>执行日志中的事件</code>，从而将从库中的数据与主库保持<code>同步</code>。</p>
<img src="image-20210826171726917.png" alt="image-20210826171726917" style="zoom: 80%;" />

<p>所以你能看到主从同步的内容就是二进制日志（Binlog），它虽然叫二进制日志，实际上存储的是一个又一个<code>事件（Event）</code>，这些事件分别对应着数据库的更新操作，比如 <code>INSERT</code>、<code>UPDATE</code>、<code>DELETE </code>等。另外我们还需要注意的是，不是所有版本的 MySQL 都默认开启服务器的二进制日志，在进行主从同步的时候，我们需要先检查服务器<code>是否已经开启了二进制日志</code>。</p>
<p>从服务器通过配置可以读取主服务器中二进制日志，并且执行日志中的事件。每个从服务器都能收到整个二进制日志的内容。从服务器需要识别日志中哪些语句应该被执行。除非特殊指定，<code>默认情况下主服务器中所有的事件都将被执行</code>。</p>
<h2 id="MySQL复制三步骤："><a href="#MySQL复制三步骤：" class="headerlink" title="MySQL复制三步骤："></a>MySQL复制三步骤：</h2><ol>
<li><code>Master</code>将写操作记录到二进制日志（<code>binlog</code>）。这些记录过程叫做<strong>二进制日志事件</strong>(binary log events)；</li>
<li><code>Slave</code>将<code>Master</code>的binary log  events拷贝到它的中继日志（<code>relay log</code>）；</li>
<li><code>Slave</code>重做中继日志中的事件，将改变应用到自己的数据库中。 MySQL复制是异步的且串行化的，而且重启后从接入点开始复制。</li>
</ol>
<h2 id="复制的问题"><a href="#复制的问题" class="headerlink" title="复制的问题"></a>复制的问题</h2><p>复制的最大问题：<strong>延时</strong>  </p>
<h2 id="复制的基本原则"><a href="#复制的基本原则" class="headerlink" title="复制的基本原则"></a>复制的基本原则</h2><ul>
<li><p>每个<code>Slave</code>只有一个<code>Master</code></p>
</li>
<li><p>每个<code>Slave</code>只能有一个唯一的服务器ID</p>
</li>
<li><p>每个<code>Master</code>可以有多个<code>Slave</code></p>
</li>
</ul>
<h1 id="主从复制与读写分离的实现"><a href="#主从复制与读写分离的实现" class="headerlink" title="主从复制与读写分离的实现"></a>主从复制与读写分离的实现</h1><h2 id="搭建主从复制：一主一从"><a href="#搭建主从复制：一主一从" class="headerlink" title="搭建主从复制：一主一从"></a>搭建主从复制：一主一从</h2><p>一台<code>主机</code>用于处理所有<code>写请求</code>，一台<code>从机</code>负责所有<code>读请求</code>，架构图如下：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210826172957062.png" alt="image-20210826172957062"></p>
<h3 id="搭建MySQL主从复制"><a href="#搭建MySQL主从复制" class="headerlink" title="搭建MySQL主从复制"></a>搭建MySQL主从复制</h3><p><strong>①  主机配置(host79)</strong></p>
<p>修改配置文件：<code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#主服务器唯一ID</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">#启用二进制日志</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">#设置不要复制的数据库(可设置多个)</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line"></span><br><span class="line">#设置需要复制的数据库。注意：MySQL是从接入点开始复制操作的</span><br><span class="line">binlog-do-db=需要复制的主数据库名字</span><br><span class="line"></span><br><span class="line">#设置logbin格式</span><br><span class="line">binlog_format=STATEMENT</span><br></pre></td></tr></table></figure>

<p>binlog日志三种格式：</p>
<ul>
<li><p><code>STATEMENT模式</code>（基于SQL语句的复制(statement-based replication, SBR)）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog_format=STATEMENT</span><br></pre></td></tr></table></figure>

<p>每一条会修改数据的sql语句会记录到binlog中。这是默认的binlog格式。</p>
<p>优点：binlog文件较小，binlog可以用于实时的还原，而不仅仅用于复制。</p>
<p>缺点：使用以下函数的语句也无法被复制：LOAD_FILE()、UUID()、USER()、FOUND_ROWS()、SYSDATE() (除非启动时启用了 –sysdate-is-now 选项)。数据表必须几乎和主服务器保持一致才行，否则可能会导致复制出错。</p>
</li>
<li><p><code>ROW模式</code>（基于行的复制(row-based replication, RBR)）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog_format=ROW</span><br></pre></td></tr></table></figure>

<p>不记录每条sql语句的上下文信息，仅需记录哪条数据被修改了，修改成什么样了。</p>
<p>优点：任何情况都可以被复制，这对复制来说是最安全可靠的。</p>
<p>缺点：binlog 大了很多。无法从 binlog 中看到都复制了写什么语句。</p>
</li>
<li><p><code>MIXED模式</code>（混合模式复制(mixed-based replication, MBR)）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">binlog_format=MIXED</span><br></pre></td></tr></table></figure>

<p>以上两种模式的混合使用。</p>
</li>
</ul>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628997332911.jpg" alt="graphic"></p>
<p><strong>② 从机配置(host80)</strong></p>
<p>修改配置文件：<code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#从服务器唯一ID</span><br><span class="line">server-id=2</span><br><span class="line"></span><br><span class="line">#启用中继日志</span><br><span class="line">relay-log=mysql-relay</span><br></pre></td></tr></table></figure>

<p><strong>③ 主机、从机重启MySQL服务</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br><span class="line"></span><br><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure>

<p><strong>④ 主机从机都关闭防火墙</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status firewalld</span><br></pre></td></tr></table></figure>

<p><strong>⑤ 在Master主机上建立帐户并授权slave</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在主机MySQL里执行授权主从复制的命令</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;slave&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123123&#x27;;</span><br></pre></td></tr></table></figure>

<p><strong>注意：如果使用的是MySQL8，需要如下的方式建立账户，并授权slave：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">create user &#x27;slave&#x27;@&#x27;%&#x27; identified by &#x27;HelloWorld_123&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO slave@&#x27;%&#x27;;</span><br><span class="line"></span><br><span class="line">ALTER USER &#x27;slave&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;HelloWorld_123&#x27;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><strong>查询master的状态</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status; #查看当前最新的一个binlog日志的编号名称，及最后一个事件结束的位置</span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628997496560.png" alt="img"></p>
<ul>
<li>记录下File和Position的值</li>
</ul>
<p>注意：执行完此步骤后不要再操作主服务器MySQL，防止主服务器状态值变化</p>
<p><strong>⑥ 在从机上配置需要复制的主机</strong></p>
<ul>
<li>复制主机的命令</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;主机的IP地址&#x27;,</span><br><span class="line">MASTER_USER=&#x27;slave&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;123123&#x27;,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.具体数字&#x27;,MASTER_LOG_POS=具体值;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">举例：</span><br><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;192.168.1.110&#x27;,</span><br><span class="line">MASTER_USER=&#x27;slave&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;HelloWorld_123&#x27;,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.000002&#x27;,MASTER_LOG_POS=1133;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628997578261.png" alt="img"></p>
<ul>
<li><strong>启动从服务器复制功能</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<p>如果报错：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210826180046584.png" alt="image-20210826180046584"></p>
<p>可以执行如下操作，删除之前的relay_log信息。然后重新执行 change master to …语句即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset slave;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看从服务器状态</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628997746000.png" alt="img"></p>
<p>下面两个参数都是Yes，则说明主从配置成功！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<p>显式如下的情况，就是不正确的。可能错误的原因有：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. 网络不通</span><br><span class="line">2. 账户密码错误</span><br><span class="line">3. 防火墙</span><br><span class="line">4. mysql配置文件问题</span><br><span class="line">5. 连接服务器时语法</span><br><span class="line">6. 主服务器mysql权限</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210816105407268.png" alt="image-20210816105407268"></p>
<p><strong>⑦ 主机新建库、新建表、insert记录，从机复制</strong></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628997812192.jpg" alt="img"></p>
<p>以上就搭建好了<code>主从复制</code>。</p>
<p><strong>补充说明1：如何停止从服务复制功能</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br></pre></td></tr></table></figure>

<p><strong>补充说明2：如何重新配置主从</strong></p>
<p>对于从机来说，如果之前搭过主从。会报错如下：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210816092328495.png" alt="image-20210816092328495"></p>
<p>如何重新配置主从？在从机上执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave; </span><br><span class="line"></span><br><span class="line">reset master;</span><br></pre></td></tr></table></figure>

<h3 id="Mycat登录访问"><a href="#Mycat登录访问" class="headerlink" title="Mycat登录访问"></a>Mycat登录访问</h3><p>（方便起见，可以Xshell中启动三个窗口，针对Mycat所在的服务器进行连接，窗口分别命名为：mycat、bin、conf）</p>
<p>启动Mycat，在mycat&#x2F;bin目录下执行如下命令，启动mycat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mycat console</span><br></pre></td></tr></table></figure>

<p>登录mycat账户，并访问数据库中的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -umycat -p123456 -h192.168.140.128 -P8066</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show database;</span><br><span class="line">mysql&gt; use TESTDB;</span><br><span class="line">mysql&gt; select * from mytbl;</span><br></pre></td></tr></table></figure>

<h2 id="实现一主一从的读写分离"><a href="#实现一主一从的读写分离" class="headerlink" title="实现一主一从的读写分离"></a>实现一主一从的读写分离</h2><p>之前的配置已分配了读写主机，实现了主从复制，是否已实现读写分离？</p>
<h3 id="验证读写分离"><a href="#验证读写分离" class="headerlink" title="验证读写分离"></a>验证读写分离</h3><p>（1）在写主机插入如下数据，这样会出现主从主机数据不一致的情况。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into mytbl values (1,@@hostname);</span><br></pre></td></tr></table></figure>

<p>（2）在Mycat里查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from mytbl; </span><br></pre></td></tr></table></figure>

<p>此时发现读取的数据<code>来自于写主机</code>。如果实现了读写分离，那此时应该读取的是从机的数据。说明此时没有实现读写分离。</p>
<h3 id="实现读写分离"><a href="#实现读写分离" class="headerlink" title="实现读写分离"></a>实现读写分离</h3><p>修改Mycat的配置文件<code>schema.xml</code>的<code>&lt;dataHost&gt;</code>的balance属性，通过此属性配置读写分离的类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">负载均衡类型，目前的取值有4 种：</span><br><span class="line">（1）balance=&quot;0&quot;, 不开启读写分离机制，所有读操作都发送到当前可用的 writeHost 上。</span><br><span class="line"></span><br><span class="line">（2）balance=&quot;1&quot;，全部的readHost 与 stand by writeHost 参与 select 语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且 2M1 与 M2 互为主备)，正常情况下，M2,S1,S2 都参与 select 语句的负载均衡。</span><br><span class="line"></span><br><span class="line">（3）balance=&quot;2&quot;，所有读操作都随机的在 writeHost、readhost 上分发。</span><br><span class="line"></span><br><span class="line">（4）balance=&quot;3&quot;，所有读请求随机的分发到 readhost 执行，writerHost 不负担读压力。对应单主单从。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>读写分离情况下，<code>将balance设置成3是对的</code>。这里为了演示动态效果，把balance设置成2，这样会在两个机器间切换查询。</p>
<p>停止mycat服务，修改balance：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line">&lt;dataHost name=&quot;host1&quot; maxCon=&quot;1000&quot; minCon=&quot;10&quot; balance=&quot;2&quot; writeType=&quot;0&quot; dbType=&quot;mysql&quot; dbDriver=&quot;native&quot; switchType=&quot;1&quot; slaveThreshold=&quot;100&quot;&gt;</span><br><span class="line">…</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628998155425.jpg" alt="img"></p>
<h3 id="启动Mycat"><a href="#启动Mycat" class="headerlink" title="启动Mycat"></a>启动Mycat</h3><h3 id="验证读写分离-1"><a href="#验证读写分离-1" class="headerlink" title="验证读写分离"></a>验证读写分离</h3><p>（1）在写主机数据库表mytbl中插入带系统变量数据，造成主从数据不一致</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO mytbl VALUES(2,@@hostname);</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628998267656.jpg" alt="img"></p>
<p> （2）在Mycat里查询mytbl表,可以看到查询语句在主从两个主机间切换</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628998383828.png" alt="img"></p>
<h2 id="搭建主从复制：双主双从"><a href="#搭建主从复制：双主双从" class="headerlink" title="搭建主从复制：双主双从"></a>搭建主从复制：双主双从</h2><p>一个主机m1用于处理所有写请求，它的从机s1和另一台主机m2还有它的从机s2负责所有读请求。当m1主机宕机后，m2主机负责写请求，m1、m2互为备机。架构图如下：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210826191306073.png" alt="image-20210826191306073"></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1628998439368.jpg" alt="graphic"></p>
<table>
<thead>
<tr>
<th>编号</th>
<th>角色</th>
<th>IP地址</th>
<th>机器名</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Master1</td>
<td>192.168.140.128</td>
<td>host79.atguigu</td>
</tr>
<tr>
<td>2</td>
<td>Slave1</td>
<td>192.168.140.127</td>
<td>host80.atguigu</td>
</tr>
<tr>
<td>3</td>
<td>Master2</td>
<td>192.168.140.126</td>
<td>host81.atguigu</td>
</tr>
<tr>
<td>4</td>
<td>Slave2</td>
<td>192.168.140.125</td>
<td>host82.atguigu</td>
</tr>
</tbody></table>
<h3 id="储备"><a href="#储备" class="headerlink" title="储备"></a>储备</h3><ul>
<li><p>记得删除演示一主一从模式时创建的数据库<code>testdb</code>。</p>
</li>
<li><p>记得在之前的从机上执行：<code>stop slave</code> 和 <code>reset master </code>。</p>
</li>
</ul>
<h3 id="搭建MySQL主从复制（双主双从）"><a href="#搭建MySQL主从复制（双主双从）" class="headerlink" title="搭建MySQL主从复制（双主双从）"></a>搭建MySQL主从复制（双主双从）</h3><p><strong>①  双主机配置</strong></p>
<p><strong>Master1配置：</strong></p>
<p>修改配置文件：<code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#【必须】主服务器唯一ID</span><br><span class="line">server-id=1</span><br><span class="line"></span><br><span class="line">#【必须】启用二进制日志</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">#设置不要复制的数据库(可设置多个)</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line"></span><br><span class="line">#【必须】设置需要复制的数据库</span><br><span class="line">binlog-do-db=需要复制的主数据库名字</span><br><span class="line"></span><br><span class="line">#设置logbin格式</span><br><span class="line">binlog_format=STATEMENT</span><br><span class="line"></span><br><span class="line">#【必须】在作为从数据库的时候，有写入操作也要更新二进制日志文件</span><br><span class="line">log-slave-updates </span><br><span class="line"></span><br><span class="line">#【必须】表示自增长字段每次递增的量，指自增字段的起始值，其默认值是1，取值范围是1 .. 65535</span><br><span class="line">auto-increment-increment=2 </span><br><span class="line"></span><br><span class="line">#【必须】表示自增长字段从哪个数开始，指字段一次递增多少，他的取值范围是1 .. 65535</span><br><span class="line">auto-increment-offset=1 </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Master2配置：</strong></p>
<p>修改配置文件：<code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#【必须】主服务器唯一ID</span><br><span class="line">server-id=3</span><br><span class="line"></span><br><span class="line">#【必须】启用二进制日志</span><br><span class="line">log-bin=mysql-bin</span><br><span class="line"></span><br><span class="line">#设置不要复制的数据库(可设置多个)</span><br><span class="line">binlog-ignore-db=mysql</span><br><span class="line">binlog-ignore-db=information_schema</span><br><span class="line"></span><br><span class="line">#【必须】设置需要复制的数据库</span><br><span class="line">binlog-do-db=需要复制的主数据库名字</span><br><span class="line"></span><br><span class="line">#设置logbin格式</span><br><span class="line">binlog_format=STATEMENT</span><br><span class="line"></span><br><span class="line">#【必须】在作为从数据库的时候，有写入操作也要更新二进制日志文件</span><br><span class="line">log-slave-updates </span><br><span class="line"></span><br><span class="line">#【必须】表示自增长字段每次递增的量，指自增字段的起始值，其默认值是1，取值范围是1 .. 65535</span><br><span class="line">auto-increment-increment=2 </span><br><span class="line"></span><br><span class="line">#【必须】表示自增长字段从哪个数开始，指字段一次递增多少，他的取值范围是1 .. 65535</span><br><span class="line">auto-increment-offset=2</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>② 双从机配置</strong></p>
<p><strong>Slave1配置：</strong></p>
<p>修改配置文件：<code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#【必须】从服务器唯一ID</span><br><span class="line">server-id=2</span><br><span class="line"></span><br><span class="line">#【必须】启用中继日志</span><br><span class="line">relay-log=mysql-relay</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>Slave2配置：</strong></p>
<p>修改配置文件：<code>vim /etc/my.cnf</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#【必须】从服务器唯一ID</span><br><span class="line">server-id=4</span><br><span class="line"></span><br><span class="line">#【必须】启用中继日志</span><br><span class="line">relay-log=mysql-relay</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>③ 双主机、双从机重启mysql服务</strong></p>
<p><strong>④ 主机从机都关闭防火墙</strong></p>
<p><strong>⑤ 在两台主机上分别建立帐户并授权slave</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在主机MySQL里执行授权命令</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;slave&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123123&#x27;;</span><br></pre></td></tr></table></figure>

<p><strong>注意：如果使用的是MySQL8，需要如下的方式建立账户，并授权slave：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create user &#x27;slave&#x27;@&#x27;%&#x27; identified by &#x27;HelloWorld_123&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO slave@&#x27;%&#x27;;</span><br><span class="line"></span><br><span class="line">ALTER USER &#x27;slave&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;HelloWorld_123&#x27;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>



<ul>
<li>查询Master1的状态：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628999687408.png" alt="img"></p>
<ul>
<li>查询Master2的状态：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628999711121.png" alt="img"></p>
<p>注意：</p>
<p>分别记录下File和Position的值。</p>
<p>执行完此步骤后不要再操作主服务器MySQL，防止主服务器状态值变化。</p>
<p><strong>⑥ 在从机上配置需要复制的主机</strong></p>
<p>Slave1复制Master1，Slave2复制Master2。</p>
<p>#复制主机的命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=&#x27;主机的IP地址&#x27;,</span><br><span class="line">MASTER_USER=&#x27;slave&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;123123&#x27;,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.具体数字&#x27;,MASTER_LOG_POS=具体值;</span><br></pre></td></tr></table></figure>

<p> 所以，</p>
<p>Slave1的复制命令：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1628999832033.png" alt="img"></p>
<p>Slave2的复制命令：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002.png" alt="img"></p>
<ul>
<li>启动两台从服务器复制功能</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看从服务器状态</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure>

<p>Slave1的复制Master1</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image003.png" alt="img"></p>
<p>Slave2的复制Master2</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image004.png" alt="img"></p>
<p>下面两个参数都是Yes，则说明主从配置成功！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<ul>
<li>如果当初使用克隆的方式生成的虚拟机（包含MySQL Server），则克隆的虚拟机MySQL Server的UUID相同，必须修改，否则<code>show slave status\G</code>会报错。具体修改方式在《2.使用前准备工作》</li>
</ul>
<p><strong>⑦ 两个主服务器互相复制</strong></p>
<p>Master2复制Master1，Master1复制Master2</p>
<p>Master2的复制命令：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629000179039.png" alt="img"></p>
<p>Master1的复制命令：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629000179040.png" alt="img"></p>
<ul>
<li>启动两台主服务器复制功能</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br></pre></td></tr></table></figure>

<ul>
<li>查看从服务器状态</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G;</span><br></pre></td></tr></table></figure>

<p> Master2的复制Master1：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image003-1629000179040.png" alt="img"></p>
<p> Master1的复制Master2：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629000184850.png" alt="img"></p>
<p>下面两个参数都是Yes，则说明主从配置成功！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Slave_IO_Running: Yes</span><br><span class="line">Slave_SQL_Running: Yes</span><br></pre></td></tr></table></figure>

<p>⑧ Master1主机新建库、新建表、insert记录，Master2和从机复制</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629000668802.jpg" alt="img"></p>
<p>⑨ 如何停止从服务复制功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br></pre></td></tr></table></figure>

<p>⑩ 如何重新配置主从</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stop slave; </span><br><span class="line">reset master;</span><br></pre></td></tr></table></figure>

<h2 id="实现双主双从机的读写分离"><a href="#实现双主双从机的读写分离" class="headerlink" title="实现双主双从机的读写分离"></a>实现双主双从机的读写分离</h2><p>上述操作实现了双主双从的复制，下面实现读写分离操作。</p>
<h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p>修改Mycat的配置文件<code>schema.xml</code>的<code>&lt;dataHost&gt;</code>的<code>balance</code>属性，通过此属性配置读写分离的类型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">负载均衡类型，目前的取值有4 种：</span><br><span class="line">（1）balance=&quot;0&quot;, 不开启读写分离机制，所有读操作都发送到当前可用的 writeHost 上。</span><br><span class="line"></span><br><span class="line">（2）balance=&quot;1&quot;，全部的 readHost 与 stand by writeHost 参与 select 语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且 M1 与 M2 互为主备)，正常情况下，M2,S1,S2 都参与 select 语句的负载均衡。</span><br><span class="line"></span><br><span class="line">（3）balance=&quot;2&quot;，所有读操作都随机的在 writeHost、readhost 上分发。</span><br><span class="line"></span><br><span class="line">（4）balance=&quot;3&quot;，所有读请求随机的分发到 readhost 执行，writerHost 不负担读压力</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>为了双主双从读写分离balance设置为1：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;testdb&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;1&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span> &gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.128:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.127:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line">		<span class="comment">&lt;!--  复制一份 --&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.126:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span></span><br><span class="line">			<span class="comment">&lt;!-- can have multi read hosts --&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">readHost</span> <span class="attr">host</span>=<span class="string">&quot;hostS2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.125:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span> /&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"></span><br><span class="line">#balance=&quot;1&quot;: 全部的readHost与stand by writeHost参与select语句的负载均衡。</span><br><span class="line"></span><br><span class="line">#writeType=&quot;0&quot;: 所有写操作发送到配置的第一个writeHost，第一个挂了切到还生存的第二个</span><br><span class="line">#writeType=&quot;1&quot;，所有写操作都随机的发送到配置的 writeHost，1.5 以后废弃不推荐</span><br><span class="line">#writeHost，重新启动后以切换后的为准，切换记录在配置文件中:dnindex.properties 。</span><br><span class="line">#switchType=&quot;1&quot;: 1 默认值，自动切换。</span><br><span class="line">#               -1 表示不自动切换</span><br><span class="line">#                2 基于 MySQL 主从同步的状态决定是否切换。</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>主要修改内容见下图红框：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210816203836804.png" alt="image-20210816203836804">  </p>
<h3 id="启动Mycat-1"><a href="#启动Mycat-1" class="headerlink" title="启动Mycat"></a>启动Mycat</h3><h3 id="验证读写分离-2"><a href="#验证读写分离-2" class="headerlink" title="验证读写分离"></a>验证读写分离</h3><p>在写主机Master1数据库表mytbl中插入带系统变量数据，造成主从数据不一致  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO mytbl VALUES(3,@@hostname);  </span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image004-1629000737205.jpg" alt="img">  #</p>
<p>在Mycat里查询mytbl表,可以看到查询语句在Master2（host81）、Slave1（host80）、Slave2（host82）主从三个主机间切换。</p>
<p>  <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image005.png" alt="img">     </p>
<h3 id="抗风险能力测试"><a href="#抗风险能力测试" class="headerlink" title="抗风险能力测试"></a>抗风险能力测试</h3><p>停止数据库Master1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br><span class="line"></span><br><span class="line">systemctl status mysqld</span><br></pre></td></tr></table></figure>

<p>  <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image006.png" alt="img"></p>
<p>在Mycat里插入数据依然成功，Master2自动切换为写主机</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO  mytbl VALUES(3,@@hostname);</span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image007.png" alt="img"></p>
<p>启动数据库Master1：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image008.png" alt="img"></p>
<p>在Mycat里查询mytbl表,可以看到查询语句在Master1（host79）、Slave1（host80）、Slave2（host82）主从三个主机间切换：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image009.png" alt="img">        </p>
<p>Master1、Master2互做备机，负责写的主机宕机，备机切换负责写操作，保证数据库读写分离高可用性。</p>
<h1 id="Mycat数据分片"><a href="#Mycat数据分片" class="headerlink" title="Mycat数据分片"></a>Mycat数据分片</h1><h2 id="什么是数据分片？"><a href="#什么是数据分片？" class="headerlink" title="什么是数据分片？"></a>什么是数据分片？</h2><p>简单来说，就是指通过某种特定的条件，将我们存放在同一个数据库中的数据分散存放到多个数据库（主机）上面，以达到分散单台设备负载的效果。</p>
<h2 id="切分模式"><a href="#切分模式" class="headerlink" title="切分模式"></a>切分模式</h2><p>数据的切分（Sharding）根据其切分规则的类型，可以分为两种切分模式：</p>
<p><strong>1. 垂直（纵向）切分</strong>：是按照不同的表（或者 Schema）来切分到不同的数据库（主机）之上</p>
<p><strong>2. 水平（横向）切分</strong>：是根据表中的数据的逻辑关系，将同一个表中的数据按照某种条件拆分到多台数据库（主机）上面。</p>
<h2 id="Mycat分片原理"><a href="#Mycat分片原理" class="headerlink" title="Mycat分片原理"></a>Mycat分片原理</h2><p>MyCat的分片实现：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829225324607.png" alt="image-20210829225324607"></p>
<p><strong>逻辑库(schema) ：</strong>MyCat作为一个数据库中间件，起到一个程序与数据库的桥梁作用。开发人员无需知道MyCat的存在，只需要知道数据库的概念即可。为了让MyCat更透明，它会把自己“伪装”成一个MySQL数据库，因此需要有一个虚拟的 database，在MyCat中也叫逻辑库，英文就是schema。</p>
<p><strong>逻辑表（table）：</strong>既然有逻辑库，那么就会有逻辑表，分布式数据库中，对应用来说，读写数据的表就是逻辑表。逻辑表，可以是数据切分后，分布在一个或多个分片库中，也可以不做数据切分，不分片，只有一个表构成。</p>
<p><strong>分片节点(dataNode)：</strong>数据切分后，一个大表被分到不同的分片数据库上面，每个表分片所在的数据库就是分片节点（dataNode）。</p>
<p><strong>节点主机(dataHost)：</strong>数据切分后，每个分片节点（dataNode）不一定都会独占一台机器，同一机器上面可以有多个分片数据库，这样一个或多个分片节点（dataNode）所在的机器就是节点主机（dataHost）,为了规避单节点主机并发数限制，尽量将读写压力高的分片节点（dataNode）均衡的放在不同的节点主机（dataHost）。</p>
<p><strong>分片规则(rule)：</strong>前面讲了数据切分，一个大表被分成若干个分片表，就需要一定的规则，这样按照某种业务规则把数据分到某个分片的规则就是分片规则，数据切分选择合适的分片规则非常重要，将极大的避免后续数据处理的难度。</p>
<h1 id="垂直拆分——分库"><a href="#垂直拆分——分库" class="headerlink" title="垂直拆分——分库"></a>垂直拆分——分库</h1><p>一个数据库由很多表构成，每个表对应着不同的业务，垂直拆分是指按照业务将表进行分类，分布到不同的数据库上面，这样也就将数据或者说压力分担到不同的库上面，如下图：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629001912396.png" alt="img"></p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210826210404801.png" alt="image-20210826210404801"></p>
<p>系统被拆分成了：用户、订单交易、支付几个模块。</p>
<blockquote>
<p>【推荐】单表行数超过 500 万行或者单表容量超过 2GB，才推荐进行分库分表。 </p>
<p>说明：如果预计三年后的数据量根本达不到这个级别，请不要在创建表时就分库分表。</p>
<p>来源：阿里巴巴《Java开发手册》</p>
</blockquote>
<h2 id="如何划分表"><a href="#如何划分表" class="headerlink" title="如何划分表"></a>如何划分表</h2><p>一个问题：在两台主机上的两个数据库中的表，能否JOIN关联查询？</p>
<p>答案：不可以关联查询。</p>
<p><strong>分库的原则：</strong></p>
<ol>
<li><strong>能不切分尽量不要切分</strong>。数据量不是很大的库或者表，尽量不要分片。</li>
<li><strong>尽量按照功能模块分库，避免跨库join。</strong></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#客户表  rows:20万 </span><br><span class="line">CREATE TABLE customer(</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    NAME VARCHAR(200),</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#订单表   rows:600万</span><br><span class="line">CREATE TABLE orders(</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    order_type INT,</span><br><span class="line">    customer_id INT,</span><br><span class="line">    amount DECIMAL(10,2),</span><br><span class="line">    PRIMARY KEY(id)  </span><br><span class="line">); </span><br><span class="line"></span><br><span class="line">#订单详细表  rows:600万</span><br><span class="line">CREATE TABLE orders_detail(</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    detail VARCHAR(2000),</span><br><span class="line">    order_id INT,</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#订单状态字典表   rows:20</span><br><span class="line">CREATE TABLE dict_order_type(</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    order_type VARCHAR(200),</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>以上四个表如何分库？客户表分在一个数据库，另外三张都需要关联查询，分在另外一个数据库。</p>
<blockquote>
<p>分布在同一台主机上不同数据库的表，可以进行JOIN查询操作。</p>
<p>分布在不同主机上的数据库中的表，不可以进行JOIN查询操作。</p>
</blockquote>
<h2 id="实现分库"><a href="#实现分库" class="headerlink" title="实现分库"></a>实现分库</h2><h3 id="修改schema配置文件"><a href="#修改schema配置文件" class="headerlink" title="修改schema配置文件"></a>修改schema配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;TESTDB&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;false&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;customer&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orders&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;host2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;orders&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;host1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM1&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.128:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;hostM2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;native&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span>  <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">&lt;!-- can have multi write hosts --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;hostM2&quot;</span> <span class="attr">url</span>=<span class="string">&quot;192.168.140.127:3306&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;123123&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">writeHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line">…</span><br></pre></td></tr></table></figure>

<p>主要修改的内容如下图的红框：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210816233105601.png" alt="image-20210816233105601"></p>
<h3 id="新增两个空白库"><a href="#新增两个空白库" class="headerlink" title="新增两个空白库"></a>新增两个空白库</h3><p>分库操作不是在原来的老数据库上进行操作，需要准备两台机器分别安装新的数据库。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#在数据节点dn1、dn2上分别创建数据库orders</span><br><span class="line">CREATE DATABASE orders;</span><br></pre></td></tr></table></figure>

<h3 id="启动Mycat-2"><a href="#启动Mycat-2" class="headerlink" title="启动Mycat"></a>启动Mycat</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mycat console</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629003929180.png" alt="img"></p>
<h3 id="访问Mycat进行分库"><a href="#访问Mycat进行分库" class="headerlink" title="访问Mycat进行分库"></a>访问Mycat进行分库</h3><p>访问Mycat</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -umycat -p123456 -h 192.168.140.128 -P 8066</span><br></pre></td></tr></table></figure>

<p>切换到TESTDB，创建4张表，查看表信息，可以看到成功分库：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629004002080.jpg" alt="img"></p>
<h1 id="水平拆分——分表"><a href="#水平拆分——分表" class="headerlink" title="水平拆分——分表"></a>水平拆分——分表</h1><p>相对于垂直拆分，水平拆分不是将表做分类，而是按照某个字段的某种规则来分散到多个库之中，每个表中包含一部分数据。简单来说，我们可以将数据的水平切分<code>理解为是按照数据行的切分</code>，就是将表中的某些行切分到一个数据库，而另外的某些行又切分到其他的数据库中，如图： </p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629004058333.png" alt="img"> </p>
<h2 id="实现分表"><a href="#实现分表" class="headerlink" title="实现分表"></a>实现分表</h2><h3 id="选择要拆分的表"><a href="#选择要拆分的表" class="headerlink" title="选择要拆分的表"></a>选择要拆分的表</h3><p>MySQL单表存储数据条数是有瓶颈的，单表达到<code>1000万条</code>数据就达到了瓶颈，会影响查询效率，需要进行水平拆分（分表）进行优化。</p>
<p>例如：例子中的<code>orders</code>、<code>orders_detail</code>都已经达到600万行数据，需要进行分表优化。</p>
<h3 id="分表字段的考量"><a href="#分表字段的考量" class="headerlink" title="分表字段的考量"></a>分表字段的考量</h3><p>以<code>orders</code>表为例，可以根据不同字段进行分表。即相同字段值的数据放到同一台主机的表中。</p>
<table>
<thead>
<tr>
<th>编号</th>
<th>分表字段</th>
<th>效果</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>id（主键）、创建时间</td>
<td>查询订单注重时效，历史订单被查询的次数少，<br/>如此分片会造成一个节点访问多，一个访问少，不平均。</td>
</tr>
<tr>
<td>2</td>
<td>customer_id（客户id）</td>
<td>根据客户id去分，两个节点访问平均，一个客户<br/>的所有订单都在同一个节点</td>
</tr>
</tbody></table>
<h3 id="修改配置文件schema-xml"><a href="#修改配置文件schema-xml" class="headerlink" title="修改配置文件schema.xml"></a>修改配置文件schema.xml</h3><p>为orders表设置数据节点为dn1、dn2，并指定分片规则为mod_rule（自定义的名字）</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span>  <span class="attr">rule</span>=<span class="string">&quot;mod_rule&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如下图：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629006312997.png" alt="img"></p>
<h3 id="修改配置文件rule-xml"><a href="#修改配置文件rule-xml" class="headerlink" title="修改配置文件rule.xml"></a>修改配置文件rule.xml</h3><p>在rule配置文件里新增分片规则<code>mod_rule</code>，并指定规则适用字段为customer_id， 还有选择分片算法mod-long（对字段求模运算），customer_id对两个节点求模，根据结果分片。</p>
<p>配置算法<code>mod-long</code>参数count为2，两个节点</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;mod_rule&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>customer_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>mod-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;mod-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByMod&quot;</span>&gt;</span></span><br><span class="line">	<span class="comment">&lt;!-- how many data nodes --&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;count&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>如下图：</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629006540842.png" alt="img"></p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629006550971.png" alt="img"></p>
<h3 id="在数据节点dn2上建orders表"><a href="#在数据节点dn2上建orders表" class="headerlink" title="在数据节点dn2上建orders表"></a>在数据节点dn2上建orders表</h3><p>由于dn1在前面题目中已经创建了orders表，而dn2机器上没有。这里需要执行如下的命令，在dn2上创建orders表：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#订单表   rows:600万</span><br><span class="line">CREATE TABLE orders(</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    order_type INT,</span><br><span class="line">    customer_id INT,</span><br><span class="line">    amount DECIMAL(10,2),</span><br><span class="line">    PRIMARY KEY(id)  </span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<h3 id="重启Mycat让配置生效"><a href="#重启Mycat让配置生效" class="headerlink" title="重启Mycat让配置生效"></a>重启Mycat让配置生效</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./mycat console</span><br></pre></td></tr></table></figure>

<h3 id="访问Mycat实现分片"><a href="#访问Mycat实现分片" class="headerlink" title="访问Mycat实现分片"></a>访问Mycat实现分片</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#在mycat里向orders表插入数据，INSERT字段不能省略</span><br><span class="line"></span><br><span class="line">INSERT INTO orders(id,order_type,customer_id,amount) VALUES(1,101,100,100100);</span><br><span class="line">INSERT INTO orders(id,order_type,customer_id,amount) VALUES(2,101,100,100300);</span><br><span class="line">INSERT INTO orders(id,order_type,customer_id,amount) VALUES(3,101,101,120000);</span><br><span class="line">INSERT INTO orders(id,order_type,customer_id,amount) VALUES(4,101,101,103000);</span><br><span class="line">INSERT INTO orders(id,order_type,customer_id,amount) VALUES(5,102,101,100400);</span><br><span class="line">INSERT INTO orders(id,order_type,customer_id,amount) VALUES(6,102,100,100020);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，这里不能使用 INSERT INTO orders VALUES (1,101,100,100100); 语句实现向orders表中插入数据。因为但凡使用mycat实现分表，必须显式指明分表的字段。</p>
</blockquote>
<p>在mycat、dn1、dn2中查看orders表数据，分表成功。</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629006654622.jpg" alt="img"></p>
<h2 id="Mycat-的分片-“join”"><a href="#Mycat-的分片-“join”" class="headerlink" title="Mycat 的分片 “join”"></a>Mycat 的分片 “join”</h2><p>Orders订单表已经进行分表操作了，和它关联的orders_detail订单详情表如何进行join查询。</p>
<p>我们也要对orders_detail进行分片操作。Join的原理如下图：</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629006703402.jpg" alt="img"></p>
<h3 id="ER表"><a href="#ER表" class="headerlink" title="ER表"></a>ER表</h3><p>Mycat 借鉴了 NewSQL 领域的新秀 Foundation DB 的设计思路，Foundation DB 创新性的提出了 Table Group 的概念，其<strong>将子表的存储位置依赖于主表，并且物理上紧邻存放，因此彻底解决了 JOIN 的效率和性能问题</strong>，根据这一思路，提出了<code>基于 E-R 关系的数据分片</code>策略，子表的记录与所关联的父表记录存放在同一个数据分片上。</p>
<p><strong>① 修改schema.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span>  <span class="attr">rule</span>=<span class="string">&quot;mod_rule&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629006789459.png" alt="img"></p>
<p><strong>② 在dn2创建orders_detail表</strong></p>
<p>重启Mycat前注意，dn2 上不存在orders_detail表，需要创建此表。语句见上面。</p>
<p><strong>③ 重启Mycat</strong></p>
<p><strong>④ 访问Mycat向orders_detail表插入数据：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO orders_detail(id,detail,order_id) values(1,&#x27;detail1&#x27;,1);</span><br><span class="line">INSERT INTO orders_detail(id,detail,order_id) VALUES(2,&#x27;detail1&#x27;,2);</span><br><span class="line">INSERT INTO orders_detail(id,detail,order_id) VALUES(3,&#x27;detail1&#x27;,3);</span><br><span class="line">INSERT INTO orders_detail(id,detail,order_id) VALUES(4,&#x27;detail1&#x27;,4);</span><br><span class="line">INSERT INTO orders_detail(id,detail,order_id) VALUES(5,&#x27;detail1&#x27;,5);</span><br><span class="line">INSERT INTO orders_detail(id,detail,order_id) VALUES(6,&#x27;detail1&#x27;,6);</span><br></pre></td></tr></table></figure>

<p><strong>⑤ 在mycat、dn1、dn2中运行两个表join语句</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Select o.*,od.detail </span><br><span class="line">from orders o inner join orders_detail od </span><br><span class="line">on o.id=od.order_id;</span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629006881311.jpg" alt="img"></p>
<h3 id="全局表"><a href="#全局表" class="headerlink" title="全局表"></a>全局表</h3><p>在分片的情况下，当业务表因为规模而进行分片以后，<code>业务表</code>与这些附属的<code>字典表</code>之间的关联，就成了比较棘手的问题，考虑到字典表具有以下几个<code>特性</code>：</p>
<p>​		①  变动不频繁</p>
<p>​		②  数据量总体变化不大</p>
<p>​		③  数据规模不大，很少有超过数十万条记录</p>
<p>鉴于此，Mycat 定义了一种特殊的表，称之为“<code>全局表</code>”，全局表具有以下特性：</p>
<p>​		①  全局表的插入、更新操作会实时在所有节点上执行，保持各个分片的数据一致性</p>
<p>​		②  全局表的查询操作，只从一个节点获取</p>
<p>​		③  全局表可以跟任何一个表进行 JOIN 操作</p>
<p>将字典表或者符合字典表特性的一些表定义为全局表，则从另外一个方面，很好的解决了数据 JOIN 的难题。通过<code>全局表 + 基于E-R关系</code>的分片策略，Mycat 可以满足 80%以上的企业应用开发。</p>
<p><strong>① 修改schema.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span>  <span class="attr">rule</span>=<span class="string">&quot;mod_rule&quot;</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">childTable</span> <span class="attr">name</span>=<span class="string">&quot;orders_detail&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">joinKey</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">parentKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;dict_order_type&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">type</span>=<span class="string">&quot;global&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629007043604.jpg" alt="img"></p>
<p><strong>② 在dn2创建dict_order_type表</strong></p>
<p>重启Mycat前注意，dn2 上不存在dict_order_type表，需要创建此表。语句见上面。</p>
<p><strong>③ 重启Mycat</strong></p>
<p><strong>④ 访问Mycat向dict_order_type表插入数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO dict_order_type(id,order_type) VALUES(101,&#x27;type1&#x27;);</span><br><span class="line">INSERT INTO dict_order_type(id,order_type) VALUES(102,&#x27;type2&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>⑤ 在Mycat、dn1、dn2中查询表数据</strong></p>
<p>在不同机器上查询dict_order_type表中的数据都是完整的。</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image002-1629007094948.jpg" alt="img"></p>
<h2 id="常用分片规则"><a href="#常用分片规则" class="headerlink" title="常用分片规则"></a>常用分片规则</h2><h3 id="方式1：取模"><a href="#方式1：取模" class="headerlink" title="方式1：取模"></a>方式1：取模</h3><p>此规则是对分片字段求模运算。也是水平分表最常用规则。6.1配置分表中，orders表采用了此规则。</p>
<h3 id="方式2：分片枚举"><a href="#方式2：分片枚举" class="headerlink" title="方式2：分片枚举"></a>方式2：分片枚举</h3><p>通过在配置文件中配置可能的枚举id，自己配置分片。本规则适用于特定的场景，比如有些业务需要按照<code>省份</code>或<code>区县</code>来做保存，而全国省份区县固定的，这类业务使用本条规则。</p>
<p><strong>（1）修改schema.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 订单归属区域信息表  --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;orders_ware_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding_by_intfile&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>（2）修改rule.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_intfile&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>areacode<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>hash-int<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line"></span><br><span class="line">…</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;hash-int&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByFileMap&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>partition-hash-int.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;type&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span></span><br><span class="line"></span><br><span class="line"># columns：分片字段，algorithm：分片函数</span><br><span class="line"># mapFile：标识配置文件名称</span><br><span class="line"># type：0为int型、非0为String</span><br><span class="line">#defaultNode：默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，</span><br><span class="line">#             设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错</span><br></pre></td></tr></table></figure>

<p><strong>（3）修改partition-hash-int.txt配置文件</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">110</span>=<span class="string">0    # 0 表示第1个数据节点</span></span><br><span class="line"><span class="attr">120</span>=<span class="string">1    # 1 表示第2个数据节点</span></span><br></pre></td></tr></table></figure>

<p><strong>（4）重启Mycat</strong></p>
<p><strong>（5）访问Mycat创建表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#订单归属区域信息表  </span><br><span class="line">CREATE TABLE  orders_ware_info(</span><br><span class="line">    `id`        INT AUTO_INCREMENT comment &#x27;编号&#x27;,</span><br><span class="line">    `order_id`  INT comment &#x27;订单编号&#x27;,</span><br><span class="line">    `address`   VARCHAR(200) comment &#x27;地址&#x27;,</span><br><span class="line">    `areacode`  VARCHAR(20) comment &#x27;区域编号&#x27;,</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p><strong>（6）插入数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO orders_ware_info(id, order_id,address,areacode) VALUES (1,1,&#x27;北京&#x27;,&#x27;110&#x27;);</span><br><span class="line">INSERT INTO orders_ware_info(id, order_id,address,areacode) VALUES (2,2,&#x27;天津&#x27;,&#x27;120&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>（7）查询Mycat、dn1、dn2可以看到数据分片效果</strong></p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629007161328.png" alt="img"></p>
<h3 id="方式3：范围约定"><a href="#方式3：范围约定" class="headerlink" title="方式3：范围约定"></a>方式3：范围约定</h3><p>此分片适用于，提前规划好分片字段某个范围属于哪个分片。</p>
<p><strong>（1）修改schema.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 针对支付信息表 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;payment_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto_sharding_long&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>（2）修改rule.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;auto_sharding_long&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>order_id<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>rang-long<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;rang-long&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.AutoPartitionByLong&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mapFile&quot;</span>&gt;</span>autopartition-long.txt<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultNode&quot;</span>&gt;</span>0<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span> </span><br><span class="line"></span><br><span class="line"># columns：分片字段，algorithm：分片函数</span><br><span class="line"># mapFile：标识配置文件名称</span><br><span class="line"># defaultNode：默认节点:小于 0 表示不设置默认节点，大于等于 0 表示设置默认节点，</span><br><span class="line">#              设置默认节点如果碰到不识别的枚举值，就让它路由到默认节点，如不设置不识别就报错</span><br></pre></td></tr></table></figure>

<p><strong>（3）修改autopartition-long.txt配置文件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0-102=0</span><br><span class="line">103-200=1 </span><br></pre></td></tr></table></figure>

<p><strong>（4）重启Mycat</strong><br><strong>（5）访问Mycat，并创建表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#支付信息表  </span><br><span class="line">CREATE TABLE  payment_info(</span><br><span class="line">    `id`               INT AUTO_INCREMENT comment &#x27;编号&#x27;,</span><br><span class="line">    `order_id`         INT comment &#x27;订单编号&#x27;,</span><br><span class="line">    `payment_status`   INT comment &#x27;支付状态&#x27;,</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><strong>（6）插入数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO payment_info (id,order_id,payment_status) VALUES (1,101,0);</span><br><span class="line">INSERT INTO payment_info (id,order_id,payment_status) VALUES (2,102,1);</span><br><span class="line">INSERT INTO payment_info (id,order_id ,payment_status) VALUES (3,103,0);</span><br><span class="line">INSERT INTO payment_info (id,order_id,payment_status) VALUES (4,104,1);</span><br></pre></td></tr></table></figure>

<p><strong>（7）查询Mycat、dn1、dn2可以看到数据分片效果</strong></p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629007430783.png" alt="img"></p>
<h3 id="方式4：按日期（天）分片"><a href="#方式4：按日期（天）分片" class="headerlink" title="方式4：按日期（天）分片"></a>方式4：按日期（天）分片</h3><p>此规则为按天分片。设定时间格式、范围：</p>
<p><strong>（1）修改schema.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 针对用户信息表 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;login_info&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;sharding_by_date&quot;</span> &gt;</span><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>（2）修改rule.xml配置文件</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">tableRule</span> <span class="attr">name</span>=<span class="string">&quot;sharding_by_date&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">rule</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">columns</span>&gt;</span>login_date<span class="tag">&lt;/<span class="name">columns</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">algorithm</span>&gt;</span>shardingByDate<span class="tag">&lt;/<span class="name">algorithm</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tableRule</span>&gt;</span></span><br><span class="line">…</span><br><span class="line"><span class="tag">&lt;<span class="name">function</span> <span class="attr">name</span>=<span class="string">&quot;shardingByDate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;io.mycat.route.function.PartitionByDate&quot;</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dateFormat&quot;</span>&gt;</span>yyyy-MM-dd<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sBeginDate&quot;</span>&gt;</span>2019-01-01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sEndDate&quot;</span>&gt;</span>2019-01-04<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">	 <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sPartionDay&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">property</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;/<span class="name">function</span>&gt;</span> </span><br><span class="line"></span><br><span class="line"># columns：分片字段，algorithm：分片函数</span><br><span class="line"># dateFormat ：日期格式</span><br><span class="line"># sBeginDate ：开始日期 </span><br><span class="line"># sEndDate：结束日期,则代表数据达到了这个日期的分片后循环从开始分片插入。如果不设定，会报错</span><br><span class="line"># sPartionDay ：分区天数，即默认从开始日期算起，分隔 2 天一个分区</span><br></pre></td></tr></table></figure>

<p><strong>（3）重启Mycat</strong><br><strong>（4）访问Mycat创建表</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#用户信息表  </span><br><span class="line">CREATE TABLE  login_info(</span><br><span class="line">    `id`            INT AUTO_INCREMENT comment &#x27;编号&#x27;,</span><br><span class="line">    `user_id`       INT comment &#x27;用户编号&#x27;,</span><br><span class="line">    `login_date`    date comment &#x27;登录日期&#x27;,</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">); </span><br></pre></td></tr></table></figure>

<p><strong>（6）插入数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO login_info(id,user_id,login_date) VALUES (1,101,&#x27;2019-01-01&#x27;);</span><br><span class="line">INSERT INTO login_info(id,user_id,login_date) VALUES (2,102,&#x27;2019-01-02&#x27;);</span><br><span class="line">INSERT INTO login_info(id,user_id,login_date) VALUES (3,103,&#x27;2019-01-03&#x27;);</span><br><span class="line">INSERT INTO login_info(id,user_id,login_date) VALUES  (4,104,&#x27;2019-01-04&#x27;);</span><br><span class="line">INSERT INTO login_info(id,user_id,login_date) VALUES (5,103,&#x27;2019-01-05&#x27;);</span><br><span class="line">INSERT INTO login_info(id,user_id,login_date) VALUES (6,104,&#x27;2019-01-06&#x27;); </span><br></pre></td></tr></table></figure>

<p><strong>（7）查询Mycat、dn1、dn2可以看到数据分片效果</strong></p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629007482146.png" alt="img"></p>
<h2 id="全局ID序列"><a href="#全局ID序列" class="headerlink" title="全局ID序列"></a>全局ID序列</h2><p><strong>在实现分库分表的情况下，数据库自增主键已无法保证自增主键的全局唯一。</strong>为此，Mycat 提供了<code>全局 sequence</code>，并且提供了包含<code>本地配置</code>和<code>数据库配置</code>等多种实现方式。</p>
<h3 id="方式1：本地文件（不推荐）"><a href="#方式1：本地文件（不推荐）" class="headerlink" title="方式1：本地文件（不推荐）"></a>方式1：本地文件（不推荐）</h3><p>此方式 Mycat 将 sequence 配置到文件中，当使用到 sequence 中的配置后，Mycat 会更下 classpath 中的 <code>sequence_conf.properties</code> 文件中 <code>sequence 当前的值</code>。</p>
<p>​		①   优点：本地加载，读取速度较快</p>
<p>​		②   缺点：抗风险能力差，Mycat所在主机宕机后，无法读取本地文件。</p>
<h3 id="方式2：数据库方式（推荐）"><a href="#方式2：数据库方式（推荐）" class="headerlink" title="方式2：数据库方式（推荐）"></a>方式2：数据库方式（推荐）</h3><p>利用数据库一个表来进行计数累加，可行。但是每次生成序列都读写数据库，这样效率太低。</p>
<p><strong>优化：</strong>Mycat会预加载一部分号段到Mycat的内存中，这样大部分读写序列都是在内存中完成的。</p>
<p>如果内存中的号段用完了，Mycat会再向数据库要一次。</p>
<blockquote>
<p><strong>问：那如果Mycat崩溃了 ，那内存中的序列岂不是都没了？</strong></p>
<p><strong>答：</strong>是的。如果是这样，那么Mycat启动后会向数据库申请新的号段，原有号段会弃用。</p>
<p>也就是说如果Mycat重启，那么损失是当前的号段没用完的号码，但是不会因此出现主键重复。</p>
</blockquote>
<p><strong>① 建库序列脚本</strong></p>
<p>在dn1上执行如下操作：(以下脚本来自官方)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">#在dn1上创建全局序列表</span><br><span class="line">CREATE TABLE MYCAT_SEQUENCE (NAME VARCHAR(50) NOT NULL,current_value INT NOT</span><br><span class="line">NULL,increment INT NOT NULL DEFAULT 100, PRIMARY KEY(NAME)) ENGINE=INNODB;</span><br><span class="line"></span><br><span class="line">#创建全局序列所需函数</span><br><span class="line">DELIMITER $$ </span><br><span class="line">CREATE FUNCTION mycat_seq_currval(seq_name VARCHAR(50)) RETURNS VARCHAR(64)</span><br><span class="line">DETERMINISTIC  </span><br><span class="line">BEGIN</span><br><span class="line">DECLARE retval VARCHAR(64);</span><br><span class="line">SET retval=&quot;-999999999,null&quot;;</span><br><span class="line">SELECT CONCAT(CAST(current_value AS CHAR),&quot;,&quot;,CAST(increment AS CHAR)) INTO retval FROM</span><br><span class="line">MYCAT_SEQUENCE WHERE NAME = seq_name;</span><br><span class="line">RETURN retval;</span><br><span class="line">END $$</span><br><span class="line">DELIMITER ;</span><br><span class="line"> </span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION mycat_seq_setval(seq_name VARCHAR(50),VALUE INTEGER) RETURNS VARCHAR(64)</span><br><span class="line">DETERMINISTIC</span><br><span class="line">BEGIN</span><br><span class="line">UPDATE MYCAT_SEQUENCE</span><br><span class="line">SET current_value = VALUE</span><br><span class="line">WHERE NAME = seq_name;</span><br><span class="line">RETURN mycat_seq_currval(seq_name);</span><br><span class="line">END $$</span><br><span class="line">DELIMITER ;</span><br><span class="line"> </span><br><span class="line">DELIMITER $$</span><br><span class="line">CREATE FUNCTION mycat_seq_nextval(seq_name VARCHAR(50)) RETURNS VARCHAR(64) </span><br><span class="line">DETERMINISTIC</span><br><span class="line">BEGIN</span><br><span class="line">UPDATE MYCAT_SEQUENCE</span><br><span class="line">SET current_value = current_value + increment WHERE NAME = seq_name;</span><br><span class="line">RETURN mycat_seq_currval(seq_name);</span><br><span class="line">END $$</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#初始化序列表记录</span><br><span class="line">INSERT INTO MYCAT_SEQUENCE(NAME,current_value,increment) </span><br><span class="line">VALUES (&#x27;ORDERS&#x27;, 400000,100);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629007934487.png" alt="img"></p>
<p><strong>② 修改Mycat配置</strong></p>
<p><strong>修改sequence_db_conf.properties ：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim sequence_db_conf.properties</span><br></pre></td></tr></table></figure>

<p>意思是 ORDERS 这个序列在 dn1 这个节点上，具体dn1节点是哪台机子，请参考schema.xml</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829230204587.png" alt="image-20210829230204587"></p>
<p><strong>修改server.xml  ：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim server.xml</span><br></pre></td></tr></table></figure>

<p>全局序列类型：0-本地文件，1-数据库方式，2-时间戳方式。此处应该修改成1。</p>
<p> <img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/image-20210829230232414.png" alt="image-20210829230232414"></p>
<p><strong>重启Mycat</strong></p>
<p><strong>③ 验证全局序列</strong></p>
<p>登录Mycat，插入数据：（可执行多次如下数据）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">insert into orders(id,amount,customer_id,order_type) values(next value for MYCATSEQ_ORDERS,1000,101,102);</span><br></pre></td></tr></table></figure>

<p> 查询数据</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629008105303.png" alt="img"></p>
<p>模拟Mycat宕机（重启Mycat）后，再次Mycat中插入数据，再查询</p>
<p><img src="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/clip_image001-1629008119048.png" alt="img"></p>
<h3 id="方式3：时间戳方式（不推荐）"><a href="#方式3：时间戳方式（不推荐）" class="headerlink" title="方式3：时间戳方式（不推荐）"></a>方式3：时间戳方式（不推荐）</h3><p>全局序列ID&#x3D; <code>64 位二进制 (42(毫秒)</code>+<code>5(机器 ID)</code>+<code>5(业务编码)</code>+<code>12(重复累加)</code> 换算成十进制为 18 位数的 long 类型，每毫秒可以并发 12 位二进制的累加。 </p>
<p>​		①   优点：配置简单</p>
<p>​		②   缺点：18位ID过长</p>
<h3 id="方式4：自主生成全局序列"><a href="#方式4：自主生成全局序列" class="headerlink" title="方式4：自主生成全局序列"></a>方式4：自主生成全局序列</h3><p>可在<code>Java项目</code>里自己生成全局序列，如下：</p>
<p>​		①  根据业务逻辑组合</p>
<p>​		②  可以利用 redis 的单线程原子性 incr来生成序列</p>
<p>​		③  Twitter的雪花算法</p>
<p>但，自主生成需要单独在工程中用Java代码实现，还是推荐使用Mycat自带全局序列。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="http://dreamerlearner.github.io">Dreamer Blog</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://dreamerlearner.github.io/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/">http://dreamerlearner.github.io/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AF%BC%E8%88%AA/">导航</a><a class="post-meta__tags" href="/tags/%E5%88%86%E4%BA%AB/">分享</a></div><div class="post_share"><div class="social-share" data-image="/img/om10.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2022/10/07/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%8B)/"><img class="next-cover" src="/img/responsive-web-site-screenshot.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">MySQL基础篇(下)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/09/23/springboot%E5%89%8D%E8%A8%80/" title="springboot前言"><img class="cover" src="/img/golden.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot前言</div></div></a></div><div><a href="/2022/09/23/springboot%E8%BF%90%E7%BB%B4%E5%AE%9E%E7%94%A8%E7%AF%87/" title="springboot运维实用篇"><img class="cover" src="/img/nearby.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot运维实用篇</div></div></a></div><div><a href="/2022/09/23/springboot%E5%8E%9F%E7%90%86%E7%AF%87/" title="springboot原理篇"><img class="cover" src="/img/strings.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot原理篇</div></div></a></div><div><a href="/2022/09/23/springboot%E5%9F%BA%E7%A1%80%E7%AF%87/" title="springboot基础篇"><img class="cover" src="/img/responsive-web-site-screenshot.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-23</div><div class="title">springboot基础篇</div></div></a></div><div><a href="/2022/09/24/redis%E5%85%A5%E9%97%A8%E7%AF%87/" title="redis入门篇"><img class="cover" src="/img/coding.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-24</div><div class="title">redis入门篇</div></div></a></div><div><a href="/2022/09/24/redis%E5%AE%9E%E6%88%98%E7%AF%87/" title="redis实战篇"><img class="cover" src="/img/coding.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-09-24</div><div class="title">redis实战篇</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/favicon.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">Dreamer Blog</div><div class="author-info__description"></div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a><a href="/tags/"><div class="headline">Tags</div><div class="length-num">2</div></a><a href="/categories/"><div class="headline">Categories</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dreamerLearner"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/dreamerlearner/dreamerlearner.github.io" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:2107603134@qq.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>Announcement</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Mycat%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">Mycat概述</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">基本介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat%E4%BD%9C%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">Mycat作用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8E%9F%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%89%8D%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C"><span class="toc-number">2.</span> <span class="toc-text">使用前准备工作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%90%AF%E5%8A%A8"><span class="toc-number">3.</span> <span class="toc-text">安装启动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">3.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%B8%8E%E5%90%AF%E5%8A%A8"><span class="toc-number">3.2.</span> <span class="toc-text">配置与启动</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-number">3.3.</span> <span class="toc-text">登录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%90%8E%E5%8F%B0%E7%AE%A1%E7%90%86%E7%AA%97%E5%8F%A3"><span class="toc-number">3.3.1.</span> <span class="toc-text">登录后台管理窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%95%B0%E6%8D%AE%E7%AA%97%E5%8F%A3"><span class="toc-number">3.3.2.</span> <span class="toc-text">登录数据窗口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%B8%AD%E7%99%BB%E5%BD%95"><span class="toc-number">3.3.3.</span> <span class="toc-text">项目中登录</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">主从复制原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86-1"><span class="toc-number">4.1.</span> <span class="toc-text">主从复制原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%E5%A4%8D%E5%88%B6%E4%B8%89%E6%AD%A5%E9%AA%A4%EF%BC%9A"><span class="toc-number">4.2.</span> <span class="toc-text">MySQL复制三步骤：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">4.3.</span> <span class="toc-text">复制的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%8D%E5%88%B6%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E5%88%99"><span class="toc-number">4.4.</span> <span class="toc-text">复制的基本原则</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E4%B8%8E%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="toc-number">5.</span> <span class="toc-text">主从复制与读写分离的实现</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%9A%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="toc-number">5.1.</span> <span class="toc-text">搭建主从复制：一主一从</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">5.1.1.</span> <span class="toc-text">搭建MySQL主从复制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Mycat%E7%99%BB%E5%BD%95%E8%AE%BF%E9%97%AE"><span class="toc-number">5.1.2.</span> <span class="toc-text">Mycat登录访问</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E7%9A%84%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.2.</span> <span class="toc-text">实现一主一从的读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.2.1.</span> <span class="toc-text">验证读写分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.2.2.</span> <span class="toc-text">实现读写分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Mycat"><span class="toc-number">5.2.3.</span> <span class="toc-text">启动Mycat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-1"><span class="toc-number">5.2.4.</span> <span class="toc-text">验证读写分离</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%9A%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E"><span class="toc-number">5.3.</span> <span class="toc-text">搭建主从复制：双主双从</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%82%A8%E5%A4%87"><span class="toc-number">5.3.1.</span> <span class="toc-text">储备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BAMySQL%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%EF%BC%88%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%EF%BC%89"><span class="toc-number">5.3.2.</span> <span class="toc-text">搭建MySQL主从复制（双主双从）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%E6%9C%BA%E7%9A%84%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="toc-number">5.4.</span> <span class="toc-text">实现双主双从机的读写分离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">5.4.1.</span> <span class="toc-text">修改配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Mycat-1"><span class="toc-number">5.4.2.</span> <span class="toc-text">启动Mycat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-2"><span class="toc-number">5.4.3.</span> <span class="toc-text">验证读写分离</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%97%E9%A3%8E%E9%99%A9%E8%83%BD%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="toc-number">5.4.4.</span> <span class="toc-text">抗风险能力测试</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Mycat%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87"><span class="toc-number">6.</span> <span class="toc-text">Mycat数据分片</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%EF%BC%9F"><span class="toc-number">6.1.</span> <span class="toc-text">什么是数据分片？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%87%E5%88%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.2.</span> <span class="toc-text">切分模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat%E5%88%86%E7%89%87%E5%8E%9F%E7%90%86"><span class="toc-number">6.3.</span> <span class="toc-text">Mycat分片原理</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86%E2%80%94%E2%80%94%E5%88%86%E5%BA%93"><span class="toc-number">7.</span> <span class="toc-text">垂直拆分——分库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%92%E5%88%86%E8%A1%A8"><span class="toc-number">7.1.</span> <span class="toc-text">如何划分表</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E5%BA%93"><span class="toc-number">7.2.</span> <span class="toc-text">实现分库</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9schema%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">7.2.1.</span> <span class="toc-text">修改schema配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%A2%9E%E4%B8%A4%E4%B8%AA%E7%A9%BA%E7%99%BD%E5%BA%93"><span class="toc-number">7.2.2.</span> <span class="toc-text">新增两个空白库</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8Mycat-2"><span class="toc-number">7.2.3.</span> <span class="toc-text">启动Mycat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEMycat%E8%BF%9B%E8%A1%8C%E5%88%86%E5%BA%93"><span class="toc-number">7.2.4.</span> <span class="toc-text">访问Mycat进行分库</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86%E2%80%94%E2%80%94%E5%88%86%E8%A1%A8"><span class="toc-number">8.</span> <span class="toc-text">水平拆分——分表</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%88%86%E8%A1%A8"><span class="toc-number">8.1.</span> <span class="toc-text">实现分表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%89%E6%8B%A9%E8%A6%81%E6%8B%86%E5%88%86%E7%9A%84%E8%A1%A8"><span class="toc-number">8.1.1.</span> <span class="toc-text">选择要拆分的表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E8%A1%A8%E5%AD%97%E6%AE%B5%E7%9A%84%E8%80%83%E9%87%8F"><span class="toc-number">8.1.2.</span> <span class="toc-text">分表字段的考量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6schema-xml"><span class="toc-number">8.1.3.</span> <span class="toc-text">修改配置文件schema.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6rule-xml"><span class="toc-number">8.1.4.</span> <span class="toc-text">修改配置文件rule.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9C%A8%E6%95%B0%E6%8D%AE%E8%8A%82%E7%82%B9dn2%E4%B8%8A%E5%BB%BAorders%E8%A1%A8"><span class="toc-number">8.1.5.</span> <span class="toc-text">在数据节点dn2上建orders表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AFMycat%E8%AE%A9%E9%85%8D%E7%BD%AE%E7%94%9F%E6%95%88"><span class="toc-number">8.1.6.</span> <span class="toc-text">重启Mycat让配置生效</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AEMycat%E5%AE%9E%E7%8E%B0%E5%88%86%E7%89%87"><span class="toc-number">8.1.7.</span> <span class="toc-text">访问Mycat实现分片</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Mycat-%E7%9A%84%E5%88%86%E7%89%87-%E2%80%9Cjoin%E2%80%9D"><span class="toc-number">8.2.</span> <span class="toc-text">Mycat 的分片 “join”</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ER%E8%A1%A8"><span class="toc-number">8.2.1.</span> <span class="toc-text">ER表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="toc-number">8.2.2.</span> <span class="toc-text">全局表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%88%86%E7%89%87%E8%A7%84%E5%88%99"><span class="toc-number">8.3.</span> <span class="toc-text">常用分片规则</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F1%EF%BC%9A%E5%8F%96%E6%A8%A1"><span class="toc-number">8.3.1.</span> <span class="toc-text">方式1：取模</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F2%EF%BC%9A%E5%88%86%E7%89%87%E6%9E%9A%E4%B8%BE"><span class="toc-number">8.3.2.</span> <span class="toc-text">方式2：分片枚举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F3%EF%BC%9A%E8%8C%83%E5%9B%B4%E7%BA%A6%E5%AE%9A"><span class="toc-number">8.3.3.</span> <span class="toc-text">方式3：范围约定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F4%EF%BC%9A%E6%8C%89%E6%97%A5%E6%9C%9F%EF%BC%88%E5%A4%A9%EF%BC%89%E5%88%86%E7%89%87"><span class="toc-number">8.3.4.</span> <span class="toc-text">方式4：按日期（天）分片</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A8%E5%B1%80ID%E5%BA%8F%E5%88%97"><span class="toc-number">8.4.</span> <span class="toc-text">全局ID序列</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F1%EF%BC%9A%E6%9C%AC%E5%9C%B0%E6%96%87%E4%BB%B6%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">8.4.1.</span> <span class="toc-text">方式1：本地文件（不推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F2%EF%BC%9A%E6%95%B0%E6%8D%AE%E5%BA%93%E6%96%B9%E5%BC%8F%EF%BC%88%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">8.4.2.</span> <span class="toc-text">方式2：数据库方式（推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F3%EF%BC%9A%E6%97%B6%E9%97%B4%E6%88%B3%E6%96%B9%E5%BC%8F%EF%BC%88%E4%B8%8D%E6%8E%A8%E8%8D%90%EF%BC%89"><span class="toc-number">8.4.3.</span> <span class="toc-text">方式3：时间戳方式（不推荐）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E5%BC%8F4%EF%BC%9A%E8%87%AA%E4%B8%BB%E7%94%9F%E6%88%90%E5%85%A8%E5%B1%80%E5%BA%8F%E5%88%97"><span class="toc-number">8.4.4.</span> <span class="toc-text">方式4：自主生成全局序列</span></a></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/" title="MySQL高级篇"><img src="/img/om10.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL高级篇"/></a><div class="content"><a class="title" href="/2022/10/07/MySQL%E9%AB%98%E7%BA%A7%E7%AF%87/" title="MySQL高级篇">MySQL高级篇</a><time datetime="2022-10-07T04:52:12.000Z" title="Created 2022-10-07 12:52:12">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/07/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%8B)/" title="MySQL基础篇(下)"><img src="/img/responsive-web-site-screenshot.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL基础篇(下)"/></a><div class="content"><a class="title" href="/2022/10/07/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%8B)/" title="MySQL基础篇(下)">MySQL基础篇(下)</a><time datetime="2022-10-07T04:41:28.000Z" title="Created 2022-10-07 12:41:28">2022-10-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/10/06/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%AD)/" title="MySQL基础篇(中)"><img src="/img/gears1.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL基础篇(中)"/></a><div class="content"><a class="title" href="/2022/10/06/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%AD)/" title="MySQL基础篇(中)">MySQL基础篇(中)</a><time datetime="2022-10-06T04:52:03.000Z" title="Created 2022-10-06 12:52:03">2022-10-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/28/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%8A)/" title="MySQL基础篇(上)"><img src="/img/grid-book.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL基础篇(上)"/></a><div class="content"><a class="title" href="/2022/09/28/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87(%E4%B8%8A)/" title="MySQL基础篇(上)">MySQL基础篇(上)</a><time datetime="2022-09-28T13:49:17.000Z" title="Created 2022-09-28 21:49:17">2022-09-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/09/26/ssm%E5%AD%A6%E4%B9%A0/" title="SSM学习"><img src="/img/grid-book.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="SSM学习"/></a><div class="content"><a class="title" href="/2022/09/26/ssm%E5%AD%A6%E4%B9%A0/" title="SSM学习">SSM学习</a><time datetime="2022-09-26T12:38:19.000Z" title="Created 2022-09-26 20:38:19">2022-09-26</time></div></div></div></div></div></div></main><footer id="footer" style="background-image: url('/img/om10.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By Dreamer Blog</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">Search</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  Loading the Database</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><div class="aplayer no-destroy" data-id="60198" data-server="netease" data-type="playlist" data-fixed="true" data-autoplay="true"> </div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>